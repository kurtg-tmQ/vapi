/*! twilio-client.js 1.14.0

The following license applies to all parts of this software except as
documented below.

    Copyright (C) 2015-2021 Twilio, inc.
 
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
 
        http://www.apache.org/licenses/LICENSE-2.0
 
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

This software includes rtcpeerconnection-shim under the following (BSD 3-Clause) license.

    Copyright (c) 2017 Philipp Hancke. All rights reserved.

    Copyright (c) 2014, The WebRTC project authors. All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      * Redistributions of source code must retain the above copyright
        notice, this list of conditions and the following disclaimer.

      * Redistributions in binary form must reproduce the above copyright
        notice, this list of conditions and the following disclaimer in
        the documentation and/or other materials provided with the
        distribution.

      * Neither the name of Philipp Hancke nor the names of its contributors may
        be used to endorse or promote products derived from this software
        without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes backoff under the following (MIT) license.

    Copyright (C) 2012 Mathieu Turcotte

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.

This software includes loglevel under the following (MIT) license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.

 */
!function(e){var t=(function(){function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){return i(t[a][1][e]||e)},l,l.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}return e})()({1:[function(e,t,n){"use strict";t.exports=WebSocket},{}],2:[function(e,t,n){"use strict";t.exports={XMLHttpRequest:XMLHttpRequest}},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,i=e("events"),o=e("./twilio/connection");n.Connection=o.default;var a=e("./twilio/device");n.Device=a.default;var s=e("./twilio/preflight/preflight");n.PreflightTest=s.PreflightTest;var c=e("./twilio/pstream");function u(){r=new a.default,Object.getOwnPropertyNames(a.default.prototype).concat(Object.getOwnPropertyNames(i.EventEmitter.prototype)).filter(function(e){return"function"==typeof a.default.prototype[e]}).filter(function(e){return"destroy"!==e}).forEach(function(e){a.default[e]=a.default.prototype[e].bind(r)})}n.PStream=c,Object.defineProperty(a.default,"instance",{get:function(){return r},set:function(e){null===e&&(r=null)}}),a.default.destroy=function e(){r&&r.destroy(),u()},u(),Object.getOwnPropertyNames(r).filter(function(e){return"function"!=typeof a.default.prototype[e]}).forEach(function(e){Object.defineProperty(a.default,e,{get:function(){if(r)return r[e]},set:function(t){r&&(r[e]=t)}})})},{"./twilio/connection":6,"./twilio/device":9,"./twilio/preflight/preflight":16,"./twilio/pstream":17,events:47}],4:[function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{c(r.next(e))}catch(t){o(t)}}function s(e){try{c(r.throw(e))}catch(t){o(t)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(a,s)}c((r=r.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function o(s){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(c){s=[6,c],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([o,s])}}};Object.defineProperty(n,"__esModule",{value:!0});var o=e("./deferred"),a=function(){function e(){this._operations=[]}return e.prototype.enqueue=function(e){var t=!!this._operations.length,n=new o.default;return this._operations.push({deferred:n,callback:e}),t||this._processQueue(),n.promise},e.prototype._processQueue=function(){return r(this,void 0,void 0,function(){var e,t,n,r,o,a,s;return i(this,function(i){switch(i.label){case 0:if(!this._operations.length)return[3,5];t=(e=this._operations[0]).deferred,n=e.callback,r=void 0,o=void 0,a=void 0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,n()];case 2:return r=i.sent(),a=!0,[3,4];case 3:return o=s=i.sent(),[3,4];case 4:return this._operations.shift(),a?t.resolve(r):t.reject(o),[3,0];case 5:return[2]}})})},e}();n.AsyncQueue=a},{"./deferred":8}],5:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(n,"__esModule",{value:!0});var o=e("events"),a=e("./errors"),s=e("./log"),c=e("./outputdevicecollection"),u=e("./shims/mediadevices"),l=e("./util"),d=e("./shims/mediadeviceinfo"),p={audioinput:"Audio Input",audiooutput:"Audio Output"},f=function(e){function t(t,n,r,i){var o=e.call(this)||this;o.availableInputDevices=new Map,o.availableOutputDevices=new Map,o._audioConstraints=null,o._inputDevice=null,o._inputStream=null,o._isPollingInputVolume=!1,o._log=s.default.getInstance(),o._unknownDeviceIndexes={audioinput:{},audiooutput:{}},o._removeLostInput=function(e){if(!o.inputDevice||o.inputDevice.deviceId!==e.deviceId)return!1;o._replaceStream(null),o._inputDevice=null,o._maybeStopPollingVolume();var t=o.availableInputDevices.get("default")||Array.from(o.availableInputDevices.values())[0];return t&&o.setInputDevice(t.deviceId),!0},o._removeLostOutput=function(e){var t=o.speakerDevices.delete(e),n=o.ringtoneDevices.delete(e);return t||n},o._updateAvailableDevices=function(){return o._mediaDevices?o._mediaDevices.enumerateDevices().then(function(e){o._updateDevices(e.filter(function(e){return"audiooutput"===e.kind}),o.availableOutputDevices,o._removeLostOutput),o._updateDevices(e.filter(function(e){return"audioinput"===e.kind}),o.availableInputDevices,o._removeLostInput);var t=o.availableOutputDevices.get("default")||Array.from(o.availableOutputDevices.values())[0];[o.speakerDevices,o.ringtoneDevices].forEach(function(e){!e.get().size&&o.availableOutputDevices.size&&o.isOutputSelectionSupported&&e.set(t.deviceId).catch(function(e){o._log.warn("Unable to set audio output devices. "+e)})})}):Promise.reject("Enumeration not supported")},i=Object.assign({AudioContext:"undefined"!=typeof AudioContext&&AudioContext,setSinkId:"undefined"!=typeof HTMLAudioElement&&HTMLAudioElement.prototype.setSinkId},i),o._getUserMedia=r,o._mediaDevices=i.mediaDevices||u,o._onActiveInputChanged=n;var a=!!(i.AudioContext||i.audioContext),l=!!(o._mediaDevices&&o._mediaDevices.enumerateDevices),d="function"==typeof i.setSinkId;return o.isOutputSelectionSupported=l&&d,o.isVolumeSupported=a,i.enabledSounds&&o._addEnabledSounds(i.enabledSounds),o.isVolumeSupported&&(o._audioContext=i.audioContext||i.AudioContext&&new i.AudioContext,o._audioContext&&(o._inputVolumeAnalyser=o._audioContext.createAnalyser(),o._inputVolumeAnalyser.fftSize=32,o._inputVolumeAnalyser.smoothingTimeConstant=.3)),o.ringtoneDevices=new c.default("ringtone",o.availableOutputDevices,t,o.isOutputSelectionSupported),o.speakerDevices=new c.default("speaker",o.availableOutputDevices,t,o.isOutputSelectionSupported),o.addListener("newListener",function(e){"inputVolume"===e&&o._maybeStartPollingVolume()}),o.addListener("removeListener",function(e){"inputVolume"===e&&o._maybeStopPollingVolume()}),o.once("newListener",function(){o.isOutputSelectionSupported||o._log.warn("Warning: This browser does not support audio output selection."),o.isVolumeSupported||o._log.warn("Warning: This browser does not support Twilio's volume indicator feature.")}),l&&o._initializeEnumeration(),o}return i(t,e),Object.defineProperty(t.prototype,"audioConstraints",{get:function(){return this._audioConstraints},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputDevice",{get:function(){return this._inputDevice},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputStream",{get:function(){return this._inputStream},enumerable:!0,configurable:!0}),t.prototype._maybeStartPollingVolume=function(){var e=this;if(this.isVolumeSupported&&this._inputStream){if(this._updateVolumeSource(),!this._isPollingInputVolume&&this._inputVolumeAnalyser){var t=this._inputVolumeAnalyser.frequencyBinCount,n=new Uint8Array(t);this._isPollingInputVolume=!0;var r=function(){if(e._isPollingInputVolume){if(e._inputVolumeAnalyser){e._inputVolumeAnalyser.getByteFrequencyData(n);var t=l.average(n);e.emit("inputVolume",t/255)}requestAnimationFrame(r)}};requestAnimationFrame(r)}}},t.prototype._maybeStopPollingVolume=function(){!(!this.isVolumeSupported||!this._isPollingInputVolume||this._inputStream&&this.listenerCount("inputVolume"))&&(this._inputVolumeSource&&(this._inputVolumeSource.disconnect(),delete this._inputVolumeSource),this._isPollingInputVolume=!1)},t.prototype._unbind=function(){if(!this._mediaDevices)throw new a.NotSupportedError("Enumeration is not supported");this._mediaDevices.removeEventListener&&(this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices),this._mediaDevices.removeEventListener("deviceinfochange",this._updateAvailableDevices))},t.prototype.setAudioConstraints=function(e){return this._audioConstraints=Object.assign({},e),delete this._audioConstraints.deviceId,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},t.prototype.setInputDevice=function(e){return l.isFirefox()?Promise.reject(new a.NotSupportedError("Firefox does not currently support opening multiple audio input tracks simultaneously, even across different tabs. As a result, Device.audio.setInputDevice is disabled on Firefox until support is added.\nRelated BugZilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324")):this._setInputDevice(e,!1)},t.prototype.unsetAudioConstraints=function(){return this._audioConstraints=null,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},t.prototype.unsetInputDevice=function(){var e=this;return this.inputDevice?this._onActiveInputChanged(null).then(function(){e._replaceStream(null),e._inputDevice=null,e._maybeStopPollingVolume()}):Promise.resolve()},t.prototype._addEnabledSounds=function(e){var t=this;function n(t,n){return void 0!==n&&(e[t]=n),e[t]}Object.keys(e).forEach(function(e){t[e]=n.bind(null,e)})},t.prototype._getUnknownDeviceIndex=function(e){var t=e.deviceId,n=e.kind,r=this._unknownDeviceIndexes[n][t];return r||(r=Object.keys(this._unknownDeviceIndexes[n]).length+1,this._unknownDeviceIndexes[n][t]=r),r},t.prototype._initializeEnumeration=function(){var e=this;if(!this._mediaDevices)throw new a.NotSupportedError("Enumeration is not supported");this._mediaDevices.addEventListener&&(this._mediaDevices.addEventListener("devicechange",this._updateAvailableDevices),this._mediaDevices.addEventListener("deviceinfochange",this._updateAvailableDevices)),this._updateAvailableDevices().then(function(){e.isOutputSelectionSupported&&Promise.all([e.speakerDevices.set("default"),e.ringtoneDevices.set("default"),]).catch(function(t){e._log.warn("Warning: Unable to set audio output devices. "+t)})})},t.prototype._replaceStream=function(e){this._inputStream&&this._inputStream.getTracks().forEach(function(e){e.stop()}),this._inputStream=e},t.prototype._setInputDevice=function(e,t){var n=this;if("string"!=typeof e)return Promise.reject(new a.InvalidArgumentError("Must specify the device to set"));var r=this.availableInputDevices.get(e);if(!r)return Promise.reject(new a.InvalidArgumentError("Device not found: "+e));if(this._inputDevice&&this._inputDevice.deviceId===e&&this._inputStream){if(!t)return Promise.resolve();this._inputStream.getTracks().forEach(function(e){e.stop()})}var i={audio:Object.assign({deviceId:{exact:e}},this.audioConstraints)};return this._getUserMedia(i).then(function(e){return n._onActiveInputChanged(e).then(function(){n._replaceStream(e),n._inputDevice=r,n._maybeStartPollingVolume()})})},t.prototype._updateDevices=function(e,t,n){var r=this,i=e.map(function(e){return e.deviceId}),o=Array.from(t.values()).map(function(e){return e.deviceId}),a=[],s=l.difference(o,i);s.forEach(function(e){var r=t.get(e);r&&(t.delete(e),n(r)&&a.push(r))});var c=!1;e.forEach(function(e){var n=t.get(e.deviceId),i=r._wrapMediaDeviceInfo(e);n&&n.label===i.label||(t.set(e.deviceId,i),c=!0)}),(c||s.length)&&(null!==this.inputDevice&&"default"===this.inputDevice.deviceId&&(this._log.warn("Calling getUserMedia after device change to ensure that the           tracks of the active device (default) have not gone stale."),this._setInputDevice(this.inputDevice.deviceId,!0)),this.emit("deviceChange",a))},t.prototype._updateVolumeSource=function(){this._inputStream&&this._audioContext&&this._inputVolumeAnalyser&&(this._inputVolumeSource&&this._inputVolumeSource.disconnect(),this._inputVolumeSource=this._audioContext.createMediaStreamSource(this._inputStream),this._inputVolumeSource.connect(this._inputVolumeAnalyser))},t.prototype._wrapMediaDeviceInfo=function(e){var t={deviceId:e.deviceId,groupId:e.groupId,kind:e.kind,label:e.label};if(!t.label){if("default"===t.deviceId)t.label="Default";else{var n=this._getUnknownDeviceIndex(e);t.label="Unknown "+p[t.kind]+" Device "+n}}return new d(t)},t}(o.EventEmitter);f||(f={}),n.default=f},{"./errors":12,"./log":14,"./outputdevicecollection":15,"./shims/mediadeviceinfo":30,"./shims/mediadevices":31,"./util":34,events:47}],6:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var a,s,c,u,l,d,p,f,h,m,g,v,y,$,S,b=e("events"),w=e("./device"),C=e("./errors"),k=e("./log"),E=e("./rtc/icecandidate"),_=e("./statsMonitor"),x=e("./util"),I=e("backoff"),T=e("./constants"),P=e("./rtc").PeerConnection,D=e("./rtc/sdp").getPreferredCodecInfo,R={factor:1.1,initialDelay:1,maxDelay:3e4,randomisationFactor:.5},A=70,L=500,O=160,M=5e3,F={disconnect:!0,info:{code:31003,message:"Connection with Twilio was interrupted.",twilioError:new C.MediaErrors.ConnectionError}},N={packetsLostFraction:{max:"packet-loss",maxAverage:"packets-lost-fraction"}},U={audioInputLevel:"audio-input-level",audioOutputLevel:"audio-output-level",bytesReceived:"bytes-received",bytesSent:"bytes-sent",jitter:"jitter",mos:"mos",rtt:"rtt"},j={max:"high-",maxAverage:"high-",maxDuration:"constant-",min:"low-",minStandardDeviation:"constant-"},G=!1,B=function(e){function t(n,r){var i=e.call(this)||this;i.parameters={},i._inputVolumeStreak=0,i._isAnswered=!1,i._isCancelled=!1,i._latestInputVolume=0,i._latestOutputVolume=0,i._log=k.default.getInstance(),i._metricsSamples=[],i._outputVolumeStreak=0,i._soundcache=new Map,i._status=t.State.Pending,i.options={enableRingingState:!1,mediaStreamFactory:P,offerSdp:null,shouldPlayDisconnect:function(){return!0}},i.sendHangup=!0,i.toString=function(){return"[Twilio.Connection instance]"},i._emitWarning=function(e,t,n,r,o,a){if(!("constant-audio-input-level"===t&&i.isMuted())){var s=o?"info":"warning";"constant-audio-output-level"===t&&(s="info");var c={threshold:n};r&&(r instanceof Array?c.values=r.map(function(e){return"number"==typeof e?Math.round(100*e)/100:r}):c.value=r),i._publisher.post(s,e+"warning"+(o?"-cleared":"-raised"),t,{data:c},i),"constant-audio-output-level"!==t&&i.emit(o?"warning-cleared":"warning",t,a&&!o?a:null)}},i._onAnswer=function(e){!i._isAnswered&&(i._setCallSid(e),i._isAnswered=!0,i._maybeTransitionToOpen())},i._onCancel=function(e){var n=e.callsid;i.parameters.CallSid===n&&(i._isCancelled=!0,i._publisher.info("connection","cancel",null,i),i._cleanupEventListeners(),i.mediaStream.close(),i._status=t.State.Closed,i.emit("cancel"),i.pstream.removeListener("cancel",i._onCancel))},i._onHangup=function(e){if(e.callsid&&(i.parameters.CallSid||i.outboundConnectionId)){if(e.callsid!==i.parameters.CallSid&&e.callsid!==i.outboundConnectionId)return}else if(e.callsid)return;if(i._log.info("Received HANGUP from gateway"),e.error){var t={code:e.error.code||31e3,connection:i,message:e.error.message||"Error sent from gateway in HANGUP",twilioError:new C.GeneralErrors.ConnectionError};i._log.error("Received an error from the gateway:",t),i.emit("error",t)}i.sendHangup=!1,i._publisher.info("connection","disconnected-by-remote",null,i),i._disconnect(null,!0),i._cleanupEventListeners()},i._onMediaFailure=function(e){var n=t.MediaFailure,r=n.ConnectionDisconnected,o=n.ConnectionFailed,a=n.IceGatheringFailed,s=n.LowBytes,c=e===o||e===a;if(!i.options.enableIceRestart&&c||!x.isChrome(window,window.navigator)&&e===o)return i.mediaStream.onerror(F);if(i.options.enableIceRestart){if(i._status===t.State.Reconnecting){if(c){if(Date.now()-i._mediaReconnectStartTime>R.maxDelay)return i._log.info("Exceeded max ICE retries"),i.mediaStream.onerror(F);i._mediaReconnectBackoff.backoff()}return}var u=i.mediaStream.version.pc,l=u&&"disconnected"===u.iceConnectionState,d=i._monitor.hasActiveWarning("bytesSent","min")||i._monitor.hasActiveWarning("bytesReceived","min");if(e===s&&l||e===r&&d||c){var p={code:53405,message:"Media connection failed.",twilioError:new C.MediaErrors.ConnectionError};i._log.warn("ICE Connection disconnected."),i._publisher.warn("connection","error",p,i),i._publisher.info("connection","reconnecting",null,i),i._mediaReconnectStartTime=Date.now(),i._status=t.State.Reconnecting,i._mediaReconnectBackoff.reset(),i._mediaReconnectBackoff.backoff(),i.emit("reconnecting",p)}}},i._onMediaReconnected=function(){i._status===t.State.Reconnecting&&(i._log.info("ICE Connection reestablished."),i._publisher.info("connection","reconnected",null,i),i._status=t.State.Open,i.emit("reconnected"))},i._onRinging=function(e){if(i._setCallSid(e),i._status===t.State.Connecting||i._status===t.State.Ringing){var n=!!e.sdp;i.options.enableRingingState?(i._status=t.State.Ringing,i._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:n},i),i.emit("ringing",n)):n&&i._onAnswer(e)}},i._onRTCSample=function(e){var t=o(o({},e),{inputVolume:i._latestInputVolume,outputVolume:i._latestOutputVolume});i._codec=t.codecName,i._metricsSamples.push(t),i._metricsSamples.length>=10&&i._publishMetrics(),i.emit("sample",e)},i._onTransportClose=function(){i._log.error("Received transportClose from pstream"),i.emit("transportClose")},i._reemitWarning=function(e,t){var n,r=/^audio/.test(e.name)?"audio-level-":"network-quality-",o=j[e.threshold.name];e.name in N?n=N[e.name][e.threshold.name]:e.name in U&&(n=U[e.name]);var a=o+n;i._emitWarning(r,a,e.threshold.value,e.values||e.value,t,e)},i._reemitWarningCleared=function(e){i._reemitWarning(e,!0)},i._isUnifiedPlanDefault=n.isUnifiedPlanDefault,i._soundcache=n.soundcache,i.message=r&&r.twimlParams||{},i.customParameters=new Map(Object.entries(i.message).map(function(e){var t;return[e[0],String(e[1])]})),Object.assign(i.options,r),i.options.callParameters&&(i.parameters=i.options.callParameters),i._direction=i.parameters.CallSid?t.CallDirection.Incoming:t.CallDirection.Outgoing,i._direction===t.CallDirection.Incoming&&i.parameters?i.callerInfo=i.parameters.StirStatus?{isVerified:"TN-Validation-Passed-A"===i.parameters.StirStatus}:null:i.callerInfo=null,i._mediaReconnectBackoff=I.exponential(R),i._mediaReconnectBackoff.on("ready",function(){return i.mediaStream.iceRestart()}),i.outboundConnectionId="TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});var a=i._publisher=n.publisher;i._direction===t.CallDirection.Incoming?a.info("connection","incoming",null,i):a.info("connection","outgoing",{preflight:i.options.preflight},i);var s=i._monitor=new(i.options.StatsMonitor||_.default);return s.on("sample",i._onRTCSample),s.disableWarnings(),setTimeout(function(){return s.enableWarnings()},M),s.on("warning",function(e,n){("bytesSent"===e.name||"bytesReceived"===e.name)&&i._onMediaFailure(t.MediaFailure.LowBytes),i._reemitWarning(e,n)}),s.on("warning-cleared",function(e){i._reemitWarningCleared(e)}),i.mediaStream=new(i.options.MediaStream||i.options.mediaStreamFactory)(n.audioHelper,n.pstream,n.getUserMedia,{codecPreferences:i.options.codecPreferences,dscp:i.options.dscp,enableIceRestart:i.options.enableIceRestart,forceAggressiveIceNomination:i.options.forceAggressiveIceNomination,isUnifiedPlan:i._isUnifiedPlanDefault,maxAverageBitrate:i.options.maxAverageBitrate,preflight:i.options.preflight}),i.on("volume",function(e,t){i._inputVolumeStreak=i._checkVolume(e,i._inputVolumeStreak,i._latestInputVolume,"input"),i._outputVolumeStreak=i._checkVolume(t,i._outputVolumeStreak,i._latestOutputVolume,"output"),i._latestInputVolume=e,i._latestOutputVolume=t}),i.mediaStream.onvolume=function(e,t,n,r){s.addVolumes(n/255*32767,r/255*32767),i.emit("volume",e,t)},i.mediaStream.ondtlstransportstatechange=function(e){i._publisher.post("failed"===e?"error":"debug","dtls-transport-state",e,null,i)},i.mediaStream.onpcconnectionstatechange=function(e){var t="debug",n=i.mediaStream.getRTCDtlsTransport();"failed"===e&&(t=n&&"failed"===n.state?"error":"warning"),i._publisher.post(t,"pc-connection-state",e,null,i)},i.mediaStream.onicecandidate=function(e){var t=new E.IceCandidate(e).toPayload();i._publisher.debug("ice-candidate","ice-candidate",t,i)},i.mediaStream.onselectedcandidatepairchange=function(e){var t=new E.IceCandidate(e.local).toPayload(),n=new E.IceCandidate(e.remote,!0).toPayload();i._publisher.debug("ice-candidate","selected-ice-candidate-pair",{local_candidate:t,remote_candidate:n},i)},i.mediaStream.oniceconnectionstatechange=function(e){i._publisher.post("failed"===e?"error":"debug","ice-connection-state",e,null,i)},i.mediaStream.onicegatheringfailure=function(e){i._publisher.warn("ice-gathering-state",e,null,i),i._onMediaFailure(t.MediaFailure.IceGatheringFailed)},i.mediaStream.onicegatheringstatechange=function(e){i._publisher.debug("ice-gathering-state",e,null,i)},i.mediaStream.onsignalingstatechange=function(e){i._publisher.debug("signaling-state",e,null,i)},i.mediaStream.ondisconnected=function(e){i._log.info(e),i._publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:e},i),i.emit("warning","ice-connectivity-lost"),i._onMediaFailure(t.MediaFailure.ConnectionDisconnected)},i.mediaStream.onfailed=function(e){i._onMediaFailure(t.MediaFailure.ConnectionFailed)},i.mediaStream.onconnected=function(){i._status===t.State.Reconnecting&&i._onMediaReconnected()},i.mediaStream.onreconnected=function(e){i._log.info(e),i._publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:e},i),i.emit("warning-cleared","ice-connectivity-lost"),i._onMediaReconnected()},i.mediaStream.onerror=function(e){!0===e.disconnect&&i._disconnect(e.info&&e.info.message);var t={code:e.info.code,connection:i,info:e.info,message:e.info.message||"Error with mediastream",twilioError:e.info.twilioError};i._log.error("Received an error from MediaStream:",e),i.emit("error",t)},i.mediaStream.onopen=function(){i._status!==t.State.Open&&i._status!==t.State.Reconnecting&&(i._status===t.State.Ringing||i._status===t.State.Connecting?(i.mute(!1),i._maybeTransitionToOpen()):i.mediaStream.close())},i.mediaStream.onclose=function(){i._status=t.State.Closed,i.options.shouldPlayDisconnect&&i.options.shouldPlayDisconnect()&&!i._isCancelled&&i._soundcache.get(w.default.SoundName.Disconnect).play(),s.disable(),i._publishMetrics(),i._isCancelled||i.emit("disconnect",i)},i.pstream=n.pstream,i.pstream.on("cancel",i._onCancel),i.pstream.on("ringing",i._onRinging),i.pstream.on("transportClose",i._onTransportClose),i.on("error",function(e){i._publisher.error("connection","error",{code:e.code,message:e.message},i),i.pstream&&"disconnected"===i.pstream.status&&i._cleanupEventListeners()}),i.on("disconnect",function(){i._cleanupEventListeners()}),i}return i(t,e),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"codec",{get:function(){return this._codec},enumerable:!0,configurable:!0}),t.prototype._getRealCallSid=function(){return this._log.warn("_getRealCallSid is deprecated and will be removed in 2.0."),/^TJ/.test(this.parameters.CallSid)?null:this.parameters.CallSid},t.prototype._getTempCallSid=function(){return this._log.warn("_getTempCallSid is deprecated and will be removed in 2.0.                     Please use outboundConnectionId instead."),this.outboundConnectionId},t.prototype._setInputTracksFromStream=function(e){return this.mediaStream.setInputTracksFromStream(e)},t.prototype._setSinkIds=function(e){return this.mediaStream._setSinkIds(e)},t.prototype.accept=function(e,n){var r=this;if("function"==typeof e){this._addHandler("accept",e);return}if(this._status===t.State.Pending){var i=e||this.options.audioConstraints;this._status=t.State.Connecting;var o=function(){if(r._status!==t.State.Connecting){r._cleanupEventListeners(),r.mediaStream.close();return}var e=function(e){var n=r._direction===t.CallDirection.Incoming?"accepted-by-local":"accepted-by-remote";r._publisher.info("connection",n,null,r);var i=D(r.mediaStream.version.getSDP()),o=i.codecName,a=i.codecParams;r._publisher.info("settings","codec",{codec_params:a,selected_codec:o},r),r._monitor.enable(e)},i="function"==typeof r.options.getSinkIds&&r.options.getSinkIds();if(Array.isArray(i)&&r.mediaStream._setSinkIds(i).catch(function(){}),r.pstream.addListener("hangup",r._onHangup),n=n||r.options.rtcConfiguration,r._direction===t.CallDirection.Incoming)r._isAnswered=!0,r.mediaStream.answerIncomingCall(r.parameters.CallSid,r.options.offerSdp,r.options.rtcConstraints,n,e);else{var o=Array.from(r.customParameters.entries()).map(function(e){return encodeURIComponent(e[0])+"="+encodeURIComponent(e[1])}).join("&");r.pstream.once("answer",r._onAnswer.bind(r)),r.mediaStream.makeOutgoingCall(r.pstream.token,o,r.outboundConnectionId,r.options.rtcConstraints,n,e)}};this.options.beforeAccept&&this.options.beforeAccept(this);var a="function"==typeof this.options.getInputStream&&this.options.getInputStream();(a?this.mediaStream.setInputTracksFromStream(a):this.mediaStream.openWithConstraints(i)).then(function(){r._publisher.info("get-user-media","succeeded",{data:{audioConstraints:i}},r),o()},function(e){var t,n;31208===e.code||-1!==["PermissionDeniedError","NotAllowedError"].indexOf(e.name)?(n=31208,t="User denied access to microphone, or the web browser did not allow microphone access at this address.",r._publisher.error("get-user-media","denied",{data:{audioConstraints:i,error:e}},r)):(n=31201,t="Error occurred while accessing microphone: "+e.name+(e.message?" ("+e.message+")":""),r._publisher.error("get-user-media","failed",{data:{audioConstraints:i,error:e}},r)),r._disconnect(),r.emit("error",{message:t,code:n})})}},t.prototype.cancel=function(e){this._log.warn(".cancel() is deprecated. Please use .ignore() instead."),e?this.ignore(e):this.ignore()},t.prototype.disconnect=function(e){if("function"==typeof e){this._addHandler("disconnect",e);return}this._disconnect()},t.prototype.error=function(e){"function"==typeof e&&this._addHandler("error",e)},t.prototype.getLocalStream=function(){return this.mediaStream&&this.mediaStream.stream},t.prototype.getRemoteStream=function(){return this.mediaStream&&this.mediaStream._remoteStream},t.prototype.ignore=function(e){if("function"==typeof e){this._addHandler("cancel",e);return}this._status===t.State.Pending&&(this._status=t.State.Closed,this.emit("cancel"),this.mediaStream.ignore(this.parameters.CallSid),this._publisher.info("connection","ignored-by-local",null,this))},t.prototype.isMuted=function(){return this.mediaStream.isMuted},t.prototype.mute=function(e){if(void 0===e&&(e=!0),"function"==typeof e){this._addHandler("mute",e);return}var t=this.mediaStream.isMuted;this.mediaStream.mute(e);var n=this.mediaStream.isMuted;t!==n&&(this._publisher.info("connection",n?"muted":"unmuted",null,this),this.emit("mute",n,this))},t.prototype.postFeedback=function(e,n){if(null==e)return this._postFeedbackDeclined();if(!Object.values(t.FeedbackScore).includes(e))throw new C.InvalidArgumentError("Feedback score must be one of: "+Object.values(t.FeedbackScore));if(null!=n&&!Object.values(t.FeedbackIssue).includes(n))throw new C.InvalidArgumentError("Feedback issue must be one of: "+Object.values(t.FeedbackIssue));return this._publisher.info("feedback","received",{issue_name:n,quality_score:e},this,!0)},t.prototype.reject=function(e){if("function"==typeof e){this._addHandler("reject",e);return}this._status===t.State.Pending&&(this.pstream.reject(this.parameters.CallSid),this._status=t.State.Closed,this.emit("reject"),this.mediaStream.reject(this.parameters.CallSid),this._publisher.info("connection","rejected-by-local",null,this))},t.prototype.sendDigits=function(e){if(e.match(/[^0-9*#w]/))throw new C.InvalidArgumentError("Illegal character passed into sendDigits");var t=[];e.split("").forEach(function(e){var n="w"!==e?"dtmf"+e:"";"dtmf*"===n&&(n="dtmfs"),"dtmf#"===n&&(n="dtmfh"),t.push(n)}),function e(n,r){var i=t.shift();i&&(r?r.play(i):n.get(i).play()),t.length&&setTimeout(e.bind(null,n),200)}(this._soundcache,this.options.dialtonePlayer);var n=this.mediaStream.getOrCreateDTMFSender();if(n){if(!("canInsertDTMF"in n)||n.canInsertDTMF){this._log.info("Sending digits using RTCDTMFSender"),function e(t){if(t.length){var r=t.shift();r&&r.length&&n.insertDTMF(r,O,A),setTimeout(e.bind(null,t),L)}}(e.split("w"));return}this._log.info("RTCDTMFSender cannot insert DTMF")}this._log.info("Sending digits over PStream"),null!==this.pstream&&"disconnected"!==this.pstream.status?this.pstream.dtmf(this.parameters.CallSid,e):this.emit("error",{code:31e3,connection:this,message:"Could not send DTMF: Signaling channel is disconnected"})},t.prototype.status=function(){return this._status},t.prototype.unmute=function(){this._log.warn(".unmute() is deprecated. Please use .mute(false) to unmute a call instead."),this.mute(!1)},t.prototype.volume=function(e){window&&(window.AudioContext||window.webkitAudioContext)||this._log.warn("This browser does not support Connection.volume"),this._addHandler("volume",e)},t.prototype._addHandler=function(e,t){return G||(this._log.warn("Connection callback handlers (accept, cancel, disconnect, error, ignore, mute, reject,\n        volume) have been deprecated and will be removed in the next breaking release. Instead, the EventEmitter         interface can be used to set event listeners. Example: connection.on('"+e+"', handler)"),G=!0),this.addListener(e,t),this},t.prototype._checkVolume=function(e,t,n,r){var i=0;return n===e&&(i=t),i>=10?this._emitWarning("audio-level-","constant-audio-"+r+"-level",10,i,!1):t>=10&&this._emitWarning("audio-level-","constant-audio-"+r+"-level",10,i,!0),i},t.prototype._cleanupEventListeners=function(){var e=this,t=function(){e.pstream&&(e.pstream.removeListener("answer",e._onAnswer),e.pstream.removeListener("cancel",e._onCancel),e.pstream.removeListener("hangup",e._onHangup),e.pstream.removeListener("ringing",e._onRinging),e.pstream.removeListener("transportClose",e._onTransportClose))};t(),setTimeout(t,0)},t.prototype._createMetricPayload=function(){var e={call_sid:this.parameters.CallSid,dscp:!!this.options.dscp,sdk_version:T.RELEASE_VERSION,selected_region:this.options.selectedRegion};return this.options.gateway&&(e.gateway=this.options.gateway),this.options.region&&(e.region=this.options.region),e.direction=this._direction,e},t.prototype._disconnect=function(e,n){if(e="string"==typeof e?e:null,this._status===t.State.Open||this._status===t.State.Connecting||this._status===t.State.Reconnecting||this._status===t.State.Ringing){if(this._log.info("Disconnecting..."),null!==this.pstream&&"disconnected"!==this.pstream.status&&this.sendHangup){var r=this.parameters.CallSid||this.outboundConnectionId;r&&this.pstream.hangup(r,e)}this._cleanupEventListeners(),this.mediaStream.close(),n||this._publisher.info("connection","disconnected-by-local",null,this)}},t.prototype._maybeTransitionToOpen=function(){this.mediaStream&&"open"===this.mediaStream.status&&this._isAnswered&&(this._status=t.State.Open,this.emit("accept",this))},t.prototype._postFeedbackDeclined=function(){return this._publisher.info("feedback","received-none",null,this,!0)},t.prototype._publishMetrics=function(){var e=this;0!==this._metricsSamples.length&&this._publisher.postMetrics("quality-metrics-samples","metrics-sample",this._metricsSamples.splice(0),this._createMetricPayload(),this).catch(function(t){e._log.warn("Unable to post metrics to Insights. Received error:",t)})},t.prototype._setCallSid=function(e){var t=e.callsid;t&&(this.parameters.CallSid=t,this.mediaStream.callSid=t)},t.toString=function(){return"[Twilio.Connection class]"},t}(b.EventEmitter);(h=s=(a=B||(B={})).State||(a.State={})).Closed="closed",h.Connecting="connecting",h.Open="open",h.Pending="pending",h.Reconnecting="reconnecting",h.Ringing="ringing",(m=c=a.FeedbackIssue||(a.FeedbackIssue={})).AudioLatency="audio-latency",m.ChoppyAudio="choppy-audio",m.DroppedCall="dropped-call",m.Echo="echo",m.NoisyCall="noisy-call",m.OneWayAudio="one-way-audio",(g=u=a.FeedbackScore||(a.FeedbackScore={}))[g.One=1]="One",g[g.Two=2]="Two",g[g.Three=3]="Three",g[g.Four=4]="Four",g[g.Five=5]="Five",(v=l=a.CallDirection||(a.CallDirection={})).Incoming="INCOMING",v.Outgoing="OUTGOING",(y=d=a.Codec||(a.Codec={})).Opus="opus",y.PCMU="pcmu",($=p=a.IceGatheringFailureReason||(a.IceGatheringFailureReason={})).None="none",$.Timeout="timeout",(S=f=a.MediaFailure||(a.MediaFailure={})).ConnectionDisconnected="ConnectionDisconnected",S.ConnectionFailed="ConnectionFailed",S.IceGatheringFailed="IceGatheringFailed",S.LowBytes="LowBytes",n.default=B},{"./constants":7,"./device":9,"./errors":12,"./log":14,"./rtc":22,"./rtc/icecandidate":21,"./rtc/sdp":27,"./statsMonitor":33,"./util":34,backoff:41,events:47}],7:[function(e,t,n){var r="1.14.0",i="https://sdk.twilio.com/js/client/sounds/releases/1.0.0";t.exports.COWBELL_AUDIO_URL=i+"/cowbell.mp3?cache="+r,t.exports.ECHO_TEST_DURATION=2e4,t.exports.PACKAGE_NAME="twilio-client",t.exports.RELEASE_VERSION=r,t.exports.SOUNDS_BASE_URL=i,t.exports.USED_ERRORS=["AuthorizationErrors.AccessTokenExpired","AuthorizationErrors.AccessTokenInvalid","AuthorizationErrors.AuthenticationFailed","ClientErrors.BadRequest","GeneralErrors.ConnectionError","GeneralErrors.TransportError","GeneralErrors.UnknownError","MediaErrors.ClientLocalDescFailed","MediaErrors.ClientRemoteDescFailed","MediaErrors.ConnectionError","SignalingErrors.ConnectionDisconnected","SignalingErrors.ConnectionError",]},{}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(){var e=this;this._promise=new Promise(function(t,n){e._resolve=t,e._reject=n})}return Object.defineProperty(e.prototype,"promise",{get:function(){return this._promise},enumerable:!0,configurable:!0}),e.prototype.reject=function(e){this._reject(e)},e.prototype.resolve=function(e){this._resolve(e)},e}();n.default=r},{}],9:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},a=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r};Object.defineProperty(n,"__esModule",{value:!0});var s,c,u,l,d,p,f,h=e("events"),m=e("./audiohelper"),g=e("./connection"),v=e("./dialtonePlayer"),y=e("./errors"),$=e("./log"),S=e("./preflight/preflight"),b=e("./regions"),w=e("./util"),C=e("./constants"),k=e("./eventpublisher"),E=e("./pstream"),_=e("./rtc"),x=e("./rtc/getusermedia"),I=e("./sound"),T=3e4,P=2e3,D=!1,R=!1,A=function(e){function t(n,r){var i,a=e.call(this)||this;if(a.audio=null,a.connections=[],a.isInitialized=!1,a.sounds={},a.token=null,a._activeConnection=null,a._chunderURIs=[],a._connectionInputStream=null,a._connectionSinkIds=["default"],a._edge=null,a._enabledSounds=((i={})[t.SoundName.Disconnect]=!0,i[t.SoundName.Incoming]=!0,i[t.SoundName.Outgoing]=!0,i),a._log=$.default.getInstance(),a._publisher=null,a._region=null,a._status=t.Status.Offline,a.mediaPresence={audio:!0},a.options={allowIncomingWhileBusy:!1,audioConstraints:!0,closeProtection:!1,codecPreferences:[g.default.Codec.PCMU,g.default.Codec.Opus],connectionFactory:g.default,debug:!1,dscp:!0,enableIceRestart:!1,eventgw:"eventgw.twilio.com",forceAggressiveIceNomination:!1,iceServers:[],noRegister:!1,pStreamFactory:E,preflight:!1,rtcConstraints:{},soundFactory:I,sounds:{},warnings:!0},a.regTimer=null,a.soundcache=new Map,a.stream=null,a.destroy=function(){a._disconnectAll(),a._stopRegistrationTimer(),a.audio&&a.audio._unbind(),a.stream&&(a.stream.destroy(),a.stream=null),a._networkInformation&&"function"==typeof a._networkInformation.removeEventListener&&a._networkInformation.removeEventListener("change",a._publishNetworkChange),"undefined"!=typeof window&&window.removeEventListener&&(window.removeEventListener("beforeunload",a._confirmClose),window.removeEventListener("unload",a.destroy),window.removeEventListener("pagehide",a.destroy))},a._confirmClose=function(e){if(!a._activeConnection)return"";var t=a.options.closeProtection||!1,n="string"!=typeof t?"A call is currently in-progress. Leaving or reloading this page will end the call.":t;return(e||window.event).returnValue=n,n},a._createDefaultPayload=function(e){var t={aggressive_nomination:a.options.forceAggressiveIceNomination,browser_extension:a._isBrowserExtension,dscp:!!a.options.dscp,ice_restart_enabled:a.options.enableIceRestart,platform:_.getMediaEngine(),sdk_version:C.RELEASE_VERSION};function n(e,n){n&&(t[e]=n)}if(e){var r=e.parameters.CallSid;n("call_sid",/^TJ/.test(r)?void 0:r),n("temp_call_sid",e.outboundConnectionId),n("audio_codec",e.codec),t.direction=e.direction}return n("gateway",a.stream&&a.stream.gateway),n("selected_region",a.options.region),n("region",a.stream&&a.stream.region),t},a._disconnectAll=function(){a.connections.splice(0).forEach(function(e){return e.disconnect()}),a._activeConnection&&a._activeConnection.disconnect()},a._onSignalingClose=function(){a.stream=null},a._onSignalingConnected=function(e){var t=b.getRegionShortcode(e.region);a._edge=b.regionToEdge[t]||e.region,a._region=t||e.region,a._sendPresence()},a._onSignalingError=function(e){if(e.error){var t=o({},e.error),n=e.callsid;n&&(t.connection=a._findConnection(n)),31201===t.code?t.twilioError=new y.AuthorizationErrors.AuthenticationFailed:31204===t.code?t.twilioError=new y.AuthorizationErrors.AccessTokenInvalid:31205===t.code?(a._stopRegistrationTimer(),t.twilioError=new y.AuthorizationErrors.AccessTokenExpired):t.twilioError||(t.twilioError=new y.GeneralErrors.UnknownError),a._log.info("Received error: ",t),a.emit("error",t)}},a._onSignalingInvite=function(e){var n=!!a._activeConnection;if(n&&!a.options.allowIncomingWhileBusy){a._log.info("Device busy; ignoring incoming invite");return}if(!e.callsid||!e.sdp){a.emit("error",{message:"Malformed invite from gateway",twilioError:new y.ClientErrors.BadRequest});return}var r=e.parameters||{};r.CallSid=r.CallSid||e.callsid;var i=Object.assign({},w.queryToJson(r.Params)),o=a._makeConnection(i,{callParameters:r,offerSdp:e.sdp});a.connections.push(o),o.once("accept",function(){a.soundcache.get(t.SoundName.Incoming).stop(),a._publishNetworkChange()});var s=a._enabledSounds.incoming&&!n?function(){return a.soundcache.get(t.SoundName.Incoming).play()}:function(){return Promise.resolve()};a._showIncomingConnection(o,s)},a._onSignalingOffline=function(){a._log.info("Stream is offline"),a._status=t.Status.Offline,a._edge=null,a._region=null,a.emit("offline",a)},a._onSignalingReady=function(){a._log.info("Stream is ready"),a._status=t.Status.Ready,a.emit("ready",a)},a._publishNetworkChange=function(){a._activeConnection&&a._networkInformation&&a._publisher.info("network-information","network-change",{connection_type:a._networkInformation.type,downlink:a._networkInformation.downlink,downlinkMax:a._networkInformation.downlinkMax,effective_type:a._networkInformation.effectiveType,rtt:a._networkInformation.rtt},a._activeConnection)},a._updateInputStream=function(e){var t=a._activeConnection;return t&&!e?Promise.reject(new y.InvalidStateError("Cannot unset input device while a call is in progress.")):(a._connectionInputStream=e,t?t._setInputTracksFromStream(e):Promise.resolve())},a._updateSinkIds=function(e,t){return("ringtone"===e?a._updateRingtoneSinkIds(t):a._updateSpeakerSinkIds(t)).then(function(){a._publisher.info("audio",e+"-devices-set",{audio_device_ids:t},a._activeConnection)},function(n){throw a._publisher.error("audio",e+"-devices-set-failed",{audio_device_ids:t,message:n.message},a._activeConnection),n})},window){var s=window,c=s.msBrowser||s.browser||s.chrome;a._isBrowserExtension=!!c&&!!c.runtime&&!!c.runtime.id||!!s.safari&&!!s.safari.extension}if(a._isBrowserExtension&&a._log.info("Running as browser extension."),navigator){var u=navigator;a._networkInformation=u.connection||u.mozConnection||u.webkitConnection}if(n)a.setup(n,r);else if(r)throw new y.InvalidArgumentError("Cannot construct a Device with options but without a token");return a}return i(t,e),Object.defineProperty(t,"audioContext",{get:function(){return t._audioContext},enumerable:!0,configurable:!0}),Object.defineProperty(t,"extension",{get:function(){var e,t,n="undefined"!=typeof document?document.createElement("audio"):{canPlayType:!1};try{e=n.canPlayType&&!!n.canPlayType("audio/mpeg").replace(/no/,"")}catch(r){e=!1}try{t=n.canPlayType&&!!n.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch(i){t=!1}return t&&!e?"ogg":"mp3"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"isSupported",{get:function(){return _.enabled()},enumerable:!0,configurable:!0}),Object.defineProperty(t,"packageName",{get:function(){return C.PACKAGE_NAME},enumerable:!0,configurable:!0}),t.runPreflight=function(e,n){return new S.PreflightTest(e,o({audioContext:t._getOrCreateAudioContext()},n))},t.toString=function(){return"[Twilio.Device class]"},Object.defineProperty(t,"version",{get:function(){return C.RELEASE_VERSION},enumerable:!0,configurable:!0}),t._getOrCreateAudioContext=function(){return t._audioContext||("undefined"!=typeof AudioContext?t._audioContext=new AudioContext:"undefined"!=typeof webkitAudioContext&&(t._audioContext=new webkitAudioContext)),t._audioContext},t.prototype.activeConnection=function(){return this.isInitialized?this._activeConnection||this.connections[0]:null},t.prototype.cancel=function(e){return this._addHandler(t.EventName.Cancel,e)},t.prototype.connect=function(e,n,r){if("function"==typeof e)return this._addHandler(t.EventName.Connect,e),null;if(this._throwUnlessSetup("connect"),this._activeConnection)throw new y.InvalidStateError("A Connection is already active");n=n||this.options&&this.options.audioConstraints||{},r=r||this.options.rtcConfiguration;var i=this._activeConnection=this._makeConnection(e||{},{rtcConfiguration:r});return this.connections.splice(0).forEach(function(e){return e.ignore()}),this.soundcache.get(t.SoundName.Incoming).stop(),i.accept(n),this._publishNetworkChange(),i},t.prototype.disconnect=function(e){return this._addHandler(t.EventName.Disconnect,e)},t.prototype.disconnectAll=function(){this._throwUnlessSetup("disconnectAll"),this._disconnectAll()},Object.defineProperty(t.prototype,"edge",{get:function(){return this._edge},enumerable:!0,configurable:!0}),t.prototype.error=function(e){return this._addHandler(t.EventName.Error,e)},t.prototype.incoming=function(e){return this._addHandler(t.EventName.Incoming,e)},t.prototype.offline=function(e){return this._addHandler(t.EventName.Offline,e)},t.prototype.ready=function(e){return this._addHandler(t.EventName.Ready,e)},t.prototype.region=function(){return this._log.warn("`Device.region` is deprecated and will be removed in the next major release. Please use `Device.edge` instead."),this._throwUnlessSetup("region"),"string"==typeof this._region?this._region:"offline"},t.prototype.registerPresence=function(){return this._throwUnlessSetup("registerPresence"),this.mediaPresence.audio=!0,this._sendPresence(),this},t.prototype.removeListener=function(e,t){return h.EventEmitter.prototype.removeListener.call(this,e,t),this},t.prototype.setup=function(e,n){var r=this;if(void 0===n&&(n={}),w.isLegacyEdge())throw new y.NotSupportedError("Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. Please see this documentation for a list of supported browsers https://www.twilio.com/docs/voice/client/javascript#supported-browsers");if(!t.isSupported&&!n.ignoreBrowserSupport){if(window&&window.location&&"http:"===window.location.protocol)throw new y.NotSupportedError("twilio.js wasn't able to find WebRTC browser support.           This is most likely because this page is served over http rather than https,           which does not support WebRTC in many browsers. Please load this page over https and           try again.");throw new y.NotSupportedError("twilio.js 1.3+ SDKs require WebRTC browser support.         For more information, see <https://www.twilio.com/docs/api/client/twilio-js>.         If you have any questions about this announcement, please contact         Twilio Support at <help@twilio.com>.")}if(!e)throw new y.InvalidArgumentError("Token is required for Device.setup()");if(Object.assign(this.options,n),this._log.setDefaultLevel(this.options.debug?$.default.levels.DEBUG:this.options.warnings?$.default.levels.WARN:$.default.levels.SILENT),this._chunderURIs=this.options.chunderw?["wss://"+this.options.chunderw+"/signal"]:b.getChunderURIs(this.options.edge,this.options.region,this._log.warn.bind(this._log)).map(function(e){return"wss://"+e+"/signal"}),void 0===t._isUnifiedPlanDefault&&(t._isUnifiedPlanDefault="undefined"!=typeof window&&"undefined"!=typeof RTCPeerConnection&&"undefined"!=typeof RTCRtpTransceiver&&w.isUnifiedPlanDefault(window,window.navigator,RTCPeerConnection,RTCRtpTransceiver)),t._getOrCreateAudioContext(),t._audioContext&&n.fakeLocalDTMF?t._dialtonePlayer||(t._dialtonePlayer=new v.default(t._audioContext)):t._dialtonePlayer&&(t._dialtonePlayer.cleanup(),delete t._dialtonePlayer),this.isInitialized)return this._log.info("Found existing Device; using new token but ignoring options"),this.updateToken(e),this;this.isInitialized=!0,this.options.dscp&&(this.options.rtcConstraints.optional=[{googDscp:!0}]);var i=function(e,t){return R||(r._log.warn("Device.sounds is deprecated and will be removed in the next breaking release. Please use the new functionality available on Device.audio."),R=!0),void 0!==t&&(r._enabledSounds[e]=t),r._enabledSounds[e]};[t.SoundName.Disconnect,t.SoundName.Incoming,t.SoundName.Outgoing].forEach(function(e){r.sounds[e]=i.bind(null,e)});for(var o={disconnect:{filename:"disconnect",maxDuration:3e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},incoming:{filename:"incoming",shouldLoop:!0},outgoing:{filename:"outgoing",maxDuration:3e3}},a=0,s=Object.keys(o);a<s.length;a++){var c=s[a],u=o[c],l=C.SOUNDS_BASE_URL+"/"+u.filename+"."+t.extension+"?cache="+C.RELEASE_VERSION,d=this.options.sounds&&this.options.sounds[c]||l,p=new this.options.soundFactory(c,d,{audioContext:this.options.disableAudioContextSounds?null:t.audioContext,maxDuration:u.maxDuration,shouldLoop:u.shouldLoop});this.soundcache.set(c,p)}return this._publisher=(this.options.Publisher||k)("twilio-js-sdk",e,{defaultPayload:this._createDefaultPayload,host:this.options.eventgw,metadata:{app_name:this.options.appName,app_version:this.options.appVersion}}),!1===this.options.publishEvents?this._publisher.disable():this._publisher.on("error",function(e){r._log.warn("Cannot connect to insights.",e)}),this._networkInformation&&"function"==typeof this._networkInformation.addEventListener&&this._networkInformation.addEventListener("change",this._publishNetworkChange),this.audio=new(this.options.AudioHelper||m.default)(this._updateSinkIds,this._updateInputStream,x,{audioContext:t.audioContext,enabledSounds:this._enabledSounds}),this.audio.on("deviceChange",function(e){var t=r._activeConnection,n=e.map(function(e){return e.deviceId});r._publisher.info("audio","device-change",{lost_active_device_ids:n},t),t&&t.mediaStream._onInputDevicesChanged()}),this.mediaPresence.audio=!this.options.noRegister,this.updateToken(e),"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("unload",this.destroy),window.addEventListener("pagehide",this.destroy),this.options.closeProtection&&window.addEventListener("beforeunload",this._confirmClose)),this.on(t.EventName.Error,function(){!(r.listenerCount("error")>1)&&r._log.info("Uncaught error event suppressed.")}),this},t.prototype.status=function(){return this._throwUnlessSetup("status"),this._activeConnection?t.Status.Busy:this._status},t.prototype.toString=function(){return"[Twilio.Device instance]"},t.prototype.unregisterPresence=function(){return this._throwUnlessSetup("unregisterPresence"),this.mediaPresence.audio=!1,this._sendPresence(),this},t.prototype.updateToken=function(e){this._throwUnlessSetup("updateToken"),this.token=e,this.register(e)},t.prototype._addHandler=function(e,t){return D||(this._log.warn("Device callback handlers (connect, error, offline, incoming, cancel, ready, disconnect)         have been deprecated and will be removed in the next breaking release. Instead, the EventEmitter         interface can be used to set event listeners. Example: device.on('"+e+"', handler)"),D=!0),this.addListener(e,t),this},t.prototype._asyncEmit=function(e){for(var t=this,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];setTimeout(function(){return t.emit.apply(t,a([e],n))})},t.prototype._findConnection=function(e){return this.connections.find(function(t){return t.parameters.CallSid===e||t.outboundConnectionId===e})||null},t.prototype._makeConnection=function(e,n){var r=this;if(void 0===t._isUnifiedPlanDefault)throw new y.InvalidStateError("Device has not been initialized.");var i={audioHelper:this.audio,getUserMedia:x,isUnifiedPlanDefault:t._isUnifiedPlanDefault,pstream:this.stream,publisher:this._publisher,soundcache:this.soundcache};n=Object.assign({MediaStream:this.options.MediaStream||this.options.mediaStreamFactory||_.PeerConnection,audioConstraints:this.options.audioConstraints,beforeAccept:function(e){r._activeConnection&&r._activeConnection!==e&&(r._activeConnection.disconnect(),r._removeConnection(r._activeConnection))},codecPreferences:this.options.codecPreferences,dialtonePlayer:t._dialtonePlayer,dscp:this.options.dscp,enableIceRestart:this.options.enableIceRestart,enableRingingState:this.options.enableRingingState,forceAggressiveIceNomination:this.options.forceAggressiveIceNomination,getInputStream:function(){return r.options.fileInputStream||r._connectionInputStream},getSinkIds:function(){return r._connectionSinkIds},maxAverageBitrate:this.options.maxAverageBitrate,preflight:this.options.preflight,rtcConfiguration:this.options.rtcConfiguration||{iceServers:this.options.iceServers},rtcConstraints:this.options.rtcConstraints,shouldPlayDisconnect:function(){return r._enabledSounds.disconnect},twimlParams:e},n);var o=new this.options.connectionFactory(i,n);return o.once("accept",function(){r._removeConnection(o),r._activeConnection=o,r.audio&&r.audio._maybeStartPollingVolume(),o.direction===g.default.CallDirection.Outgoing&&r._enabledSounds.outgoing&&r.soundcache.get(t.SoundName.Outgoing).play();var e={edge:r._edge||r._region},n=r.options.edge;n&&(e.selected_edge=Array.isArray(n)?n:[n]),r._publisher.info("settings","edge",e,o),r._asyncEmit("connect",o)}),o.addListener("error",function(e){"closed"===o.status()&&r._removeConnection(o),r.audio&&r.audio._maybeStopPollingVolume(),r._maybeStopIncomingSound(),r._asyncEmit("error",e)}),o.once("cancel",function(){r._log.info("Canceled: "+o.parameters.CallSid),r._removeConnection(o),r.audio&&r.audio._maybeStopPollingVolume(),r._maybeStopIncomingSound(),r._asyncEmit("cancel",o)}),o.once("disconnect",function(){r.audio&&r.audio._maybeStopPollingVolume(),r._removeConnection(o),r._asyncEmit("disconnect",o)}),o.once("reject",function(){r._log.info("Rejected: "+o.parameters.CallSid),r.audio&&r.audio._maybeStopPollingVolume(),r._removeConnection(o),r._maybeStopIncomingSound()}),o.once("transportClose",function(){o.status()===g.default.State.Pending&&(r.audio&&r.audio._maybeStopPollingVolume(),r._removeConnection(o),r._maybeStopIncomingSound())}),o},t.prototype._maybeStopIncomingSound=function(){this.connections.length||this.soundcache.get(t.SoundName.Incoming).stop()},t.prototype._removeConnection=function(e){this._activeConnection===e&&(this._activeConnection=null);for(var t=this.connections.length-1;t>=0;t--)e===this.connections[t]&&this.connections.splice(t,1)},t.prototype._sendPresence=function(){this.stream&&(this.stream.register({audio:this.mediaPresence.audio}),this.mediaPresence.audio?this._startRegistrationTimer():this._stopRegistrationTimer())},t.prototype._setupStream=function(e){this._log.info("Setting up VSP"),this.stream=this.options.pStreamFactory(e,this._chunderURIs,{backoffMaxMs:this.options.backoffMaxMs}),this.stream.addListener("close",this._onSignalingClose),this.stream.addListener("connected",this._onSignalingConnected),this.stream.addListener("error",this._onSignalingError),this.stream.addListener("invite",this._onSignalingInvite),this.stream.addListener("offline",this._onSignalingOffline),this.stream.addListener("ready",this._onSignalingReady)},t.prototype._showIncomingConnection=function(e,t){var n,r=this;return Promise.race([t(),new Promise(function(e,t){n=setTimeout(function(){t(Error("Playing incoming ringtone took too long; it might not play. Continuing execution..."))},P)}),]).catch(function(e){r._log.info(e.message)}).then(function(){clearTimeout(n),r.emit("incoming",e)})},t.prototype._startRegistrationTimer=function(){var e=this;this._stopRegistrationTimer(),this.regTimer=setTimeout(function(){e._sendPresence()},T)},t.prototype._stopRegistrationTimer=function(){this.regTimer&&clearTimeout(this.regTimer)},t.prototype._throwUnlessSetup=function(e){if(!this.isInitialized)throw new y.InvalidStateError("Call Device.setup() before "+e)},t.prototype._updateRingtoneSinkIds=function(e){return Promise.resolve(this.soundcache.get(t.SoundName.Incoming).setSinkIds(e))},t.prototype._updateSpeakerSinkIds=function(e){Array.from(this.soundcache.entries()).filter(function(e){return e[0]!==t.SoundName.Incoming}).forEach(function(t){return t[1].setSinkIds(e)}),this._connectionSinkIds=e;var n=this._activeConnection;return n?n._setSinkIds(e):Promise.resolve()},t.prototype.register=function(e){this.stream?(this.stream.setToken(e),this._publisher.setToken(e)):this._setupStream(e)},t}(h.EventEmitter);(d=c=(s=A||(A={})).EventName||(s.EventName={})).Cancel="cancel",d.Connect="connect",d.Disconnect="disconnect",d.Error="error",d.Incoming="incoming",d.Offline="offline",d.Ready="ready",(p=u=s.Status||(s.Status={})).Busy="busy",p.Offline="offline",p.Ready="ready",(f=l=s.SoundName||(s.SoundName={})).Incoming="incoming",f.Outgoing="outgoing",f.Disconnect="disconnect",f.Dtmf0="dtmf0",f.Dtmf1="dtmf1",f.Dtmf2="dtmf2",f.Dtmf3="dtmf3",f.Dtmf4="dtmf4",f.Dtmf5="dtmf5",f.Dtmf6="dtmf6",f.Dtmf7="dtmf7",f.Dtmf8="dtmf8",f.Dtmf9="dtmf9",f.DtmfS="dtmfs",f.DtmfH="dtmfh",n.default=A},{"./audiohelper":5,"./connection":6,"./constants":7,"./dialtonePlayer":10,"./errors":12,"./eventpublisher":13,"./log":14,"./preflight/preflight":16,"./pstream":17,"./regions":18,"./rtc":22,"./rtc/getusermedia":20,"./sound":32,"./util":34,events:47}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./errors"),i={dtmf0:[1360,960],dtmf1:[1230,720],dtmf2:[1360,720],dtmf3:[1480,720],dtmf4:[1230,790],dtmf5:[1360,790],dtmf6:[1480,790],dtmf7:[1230,870],dtmf8:[1360,870],dtmf9:[1480,870],dtmfh:[1480,960],dtmfs:[1230,960]},o=function(){function e(e){var t=this;this._context=e,this._gainNodes=[],this._gainNodes=[this._context.createGain(),this._context.createGain(),],this._gainNodes.forEach(function(e){e.connect(t._context.destination),e.gain.value=.1,t._gainNodes.push(e)})}return e.prototype.cleanup=function(){this._gainNodes.forEach(function(e){e.disconnect()})},e.prototype.play=function(e){var t=this,n=i[e];if(!n)throw new r.InvalidArgumentError("Invalid DTMF sound name");[this._context.createOscillator(),this._context.createOscillator(),].forEach(function(e,r){e.type="sine",e.frequency.value=n[r],e.connect(t._gainNodes[r]),e.start(),e.stop(t._context.currentTime+.1),e.addEventListener("ended",function(){return e.disconnect()})})},e}();n.default=o},{"./errors":12}],11:[function(e,t,n){"use strict";var r,i,o,a,s,c,u,l,d,p,f,h,m,g,v,y,$,S,b,w,C,k,E,_=this&&this.__extends||(S=function(e,t){return(S=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}S(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});function x(e,t,n){"string"==typeof t?(e.message=t,n instanceof Error&&(e.originalError=n)):t instanceof Error&&(e.originalError=t)}Object.defineProperty(n,"__esModule",{value:!0}),r=b=n.AuthorizationErrors||(n.AuthorizationErrors={}),i=function(e){function t(t,n){var i=e.call(this,"")||this;return i.causes=[],i.code=20101,i.description="Invalid access token",i.explanation="Twilio was unable to validate your Access Token",i.solutions=[],Object.setPrototypeOf(i,r.AccessTokenInvalid.prototype),x(i,t,n),i}return _(t,e),t}(Error),r.AccessTokenInvalid=i,o=function(e){function t(t,n){var i=e.call(this,"")||this;return i.causes=[],i.code=20104,i.description="Access token expired or expiration date invalid",i.explanation="The Access Token provided to the Twilio API has expired, the expiration time specified in the token was invalid, or the expiration time specified was too far in the future",i.solutions=[],Object.setPrototypeOf(i,r.AccessTokenExpired.prototype),x(i,t,n),i}return _(t,e),t}(Error),r.AccessTokenExpired=o,a=function(e){function t(t,n){var i=e.call(this,"")||this;return i.causes=[],i.code=20151,i.description="Authentication Failed",i.explanation="The Authentication with the provided JWT failed",i.solutions=[],Object.setPrototypeOf(i,r.AuthenticationFailed.prototype),x(i,t,n),i}return _(t,e),t}(Error),r.AuthenticationFailed=a,s=w=n.ClientErrors||(n.ClientErrors={}),c=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=[],r.code=31400,r.description="Bad Request (HTTP/SIP)",r.explanation="The request could not be understood due to malformed syntax.",r.solutions=[],Object.setPrototypeOf(r,s.BadRequest.prototype),x(r,t,n),r}return _(t,e),t}(Error),s.BadRequest=c,u=C=n.GeneralErrors||(n.GeneralErrors={}),l=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=[],r.code=31e3,r.description="Unknown Error",r.explanation="An unknown error has occurred. See error details for more information.",r.solutions=[],Object.setPrototypeOf(r,u.UnknownError.prototype),x(r,t,n),r}return _(t,e),t}(Error),u.UnknownError=l,d=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=[],r.code=31005,r.description="Connection error",r.explanation="A connection error occurred during the call",r.solutions=[],Object.setPrototypeOf(r,u.ConnectionError.prototype),x(r,t,n),r}return _(t,e),t}(Error),u.ConnectionError=d,p=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=[],r.code=31009,r.description="Transport error",r.explanation="No transport available to send or receive messages",r.solutions=[],Object.setPrototypeOf(r,u.TransportError.prototype),x(r,t,n),r}return _(t,e),t}(Error),u.TransportError=p,f=k=n.SignalingErrors||(n.SignalingErrors={}),h=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=[],r.code=53e3,r.description="Signaling connection error",r.explanation="Raised whenever a signaling connection error occurs that is not covered by a more specific error code.",r.solutions=[],Object.setPrototypeOf(r,f.ConnectionError.prototype),x(r,t,n),r}return _(t,e),t}(Error),f.ConnectionError=h,m=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=["The device running your application lost its Internet connection.",],r.code=53001,r.description="Signaling connection disconnected",r.explanation="Raised whenever the signaling connection is unexpectedly disconnected.",r.solutions=["Ensure the device running your application has access to a stable Internet connection.",],Object.setPrototypeOf(r,f.ConnectionDisconnected.prototype),x(r,t,n),r}return _(t,e),t}(Error),f.ConnectionDisconnected=m,g=E=n.MediaErrors||(n.MediaErrors={}),v=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=["The Client may not be using a supported WebRTC implementation.","The Client may not have the necessary resources to create or apply a new media description.",],r.code=53400,r.description="Client is unable to create or apply a local media description",r.explanation="Raised whenever a Client is unable to create or apply a local media description.",r.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation.",],Object.setPrototypeOf(r,g.ClientLocalDescFailed.prototype),x(r,t,n),r}return _(t,e),t}(Error),g.ClientLocalDescFailed=v,y=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=["The Client may not be using a supported WebRTC implementation.","The Client may be connecting peer-to-peer with another Participant that is not using a supported WebRTC implementation.","The Client may not have the necessary resources to apply a new media description.",],r.code=53402,r.description="Client is unable to apply a remote media description",r.explanation="Raised whenever the Client receives a remote media description but is unable to apply it.",r.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation.",],Object.setPrototypeOf(r,g.ClientRemoteDescFailed.prototype),x(r,t,n),r}return _(t,e),t}(Error),g.ClientRemoteDescFailed=y,$=function(e){function t(t,n){var r=e.call(this,"")||this;return r.causes=["The Client was unable to establish a media connection.","A media connection which was active failed liveliness checks.",],r.code=53405,r.description="Media connection failed",r.explanation="Raised by the Client or Server whenever a media connection fails.",r.solutions=["If the problem persists, try connecting to another region.","Check your Client's network connectivity.","If you've provided custom ICE Servers then ensure that the URLs and credentials are valid.",],Object.setPrototypeOf(r,g.ConnectionError.prototype),x(r,t,n),r}return _(t,e),t}(Error),g.ConnectionError=$,n.errorsByCode=new Map([[20101,b.AccessTokenInvalid],[20104,b.AccessTokenExpired],[20151,b.AuthenticationFailed],[31400,w.BadRequest],[31e3,C.UnknownError],[31005,C.ConnectionError],[31009,C.TransportError],[53e3,k.ConnectionError],[53001,k.ConnectionDisconnected],[53400,E.ClientLocalDescFailed],[53402,E.ClientRemoteDescFailed],[53405,E.ConnectionError],]),Object.freeze(n.errorsByCode)},{}],12:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(n,"__esModule",{value:!0});var o=e("./generated");n.AuthorizationErrors=o.AuthorizationErrors,n.ClientErrors=o.ClientErrors,n.GeneralErrors=o.GeneralErrors,n.MediaErrors=o.MediaErrors,n.SignalingErrors=o.SignalingErrors;var a=function(e){function t(t){var n=e.call(this,t)||this;return n.name="InvalidArgumentError",n}return i(t,e),t}(Error);n.InvalidArgumentError=a;var s=function(e){function t(t){var n=e.call(this,t)||this;return n.name="InvalidStateError",n}return i(t,e),t}(Error);n.InvalidStateError=s;var c=function(e){function t(t){var n=e.call(this,t)||this;return n.name="NotSupportedError",n}return i(t,e),t}(Error);n.NotSupportedError=c,n.getErrorByCode=function e(t){var n=o.errorsByCode.get(t);if(!n)throw new a("Error code "+t+" not found");return n}},{"./generated":11}],13:[function(e,t,n){"use strict";var r=e("events").EventEmitter,i=e("./request"),o=e("util");function a(e,t,n){if(!(this instanceof a))return new a(e,t,n);var r=(n=Object.assign({defaultPayload:function e(){return{}},host:"eventgw.twilio.com"},n)).defaultPayload;"function"!=typeof r&&(r=function e(){return Object.assign({},n.defaultPayload)});var o=!0,s=Object.assign({app_name:void 0,app_version:void 0},n.metadata);Object.defineProperties(this,{_defaultPayload:{value:r},_isEnabled:{get:function e(){return o},set:function e(t){o=t}},_host:{value:n.host},_request:{value:n.request||i,writable:!0},_token:{value:t,writable:!0},isEnabled:{enumerable:!0,get:function e(){return o}},metadata:{enumerable:!0,get:function e(){return s}},productName:{enumerable:!0,value:e},token:{enumerable:!0,get:function e(){return this._token}}})}function s(e){return{timestamp:new Date(e.timestamp).toISOString(),total_packets_received:e.totals.packetsReceived,total_packets_lost:e.totals.packetsLost,total_packets_sent:e.totals.packetsSent,total_bytes_received:e.totals.bytesReceived,total_bytes_sent:e.totals.bytesSent,packets_received:e.packetsReceived,packets_lost:e.packetsLost,packets_lost_fraction:e.packetsLostFraction&&Math.round(100*e.packetsLostFraction)/100,bytes_received:e.bytesReceived,bytes_sent:e.bytesSent,audio_codec:e.codecName,audio_level_in:e.audioInputLevel,audio_level_out:e.audioOutputLevel,call_volume_input:e.inputVolume,call_volume_output:e.outputVolume,jitter:e.jitter,rtt:e.rtt,mos:e.mos&&Math.round(100*e.mos)/100}}o.inherits(a,r),a.prototype._post=function e(t,n,r,i,o,a,s){var c=this;if(!this.isEnabled&&!s||!a||(!a.parameters||!a.parameters.CallSid)&&!a.outboundConnectionId)return Promise.resolve();var u={publisher:this.productName,group:r,name:i,timestamp:new Date().toISOString(),level:n.toUpperCase(),payload_type:"application/json",private:!1,payload:o&&o.forEach?o.slice(0):Object.assign(this._defaultPayload(a),o)};this.metadata&&(u.publisher_metadata=this.metadata);var l={url:"https://"+this._host+"/v4/"+t,body:u,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token}},d=this;return new Promise(function(e,t){d._request.post(l,function(n){n?(c.emit("error",n),t(n)):e()})})},a.prototype.post=function e(t,n,r,i,o,a){return this._post("EndpointEvents",t,n,r,i,o,a)},a.prototype.debug=function e(t,n,r,i){return this.post("debug",t,n,r,i)},a.prototype.info=function e(t,n,r,i){return this.post("info",t,n,r,i)},a.prototype.warn=function e(t,n,r,i){return this.post("warning",t,n,r,i)},a.prototype.error=function e(t,n,r,i){return this.post("error",t,n,r,i)},a.prototype.postMetrics=function e(t,n,r,i,o){var a=this;return new Promise(function(e){var c=r.map(s).map(function(e){return Object.assign(e,i)});e(a._post("EndpointMetrics","info",t,n,c,o))})},a.prototype.setToken=function e(t){this._token=t},a.prototype.enable=function e(){this._isEnabled=!0},a.prototype.disable=function e(){this._isEnabled=!1},t.exports=a},{"./request":19,events:47,util:59}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("loglevel"),i=e("./constants"),o=function(){function e(e){this._log=(e&&e.LogLevelModule?e.LogLevelModule:r).getLogger(i.PACKAGE_NAME)}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.debug=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).debug.apply(e,t)},e.prototype.error=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).error.apply(e,t)},e.prototype.info=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).info.apply(e,t)},e.prototype.setDefaultLevel=function(e){this._log.setDefaultLevel(e)},e.prototype.warn=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).warn.apply(e,t)},e.levels=r.levels,e}();n.default=o},{"./constants":7,loglevel:48}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./constants"),i=e("./errors"),o=r.SOUNDS_BASE_URL+"/outgoing.mp3",a=function(){function e(e,t,n,r){this._name=e,this._availableDevices=t,this._beforeChange=n,this._isSupported=r,this._activeDevices=new Set}return e.prototype.delete=function(e){var t=!!this._activeDevices.delete(e),n=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0];!this._activeDevices.size&&n&&this._activeDevices.add(n);var r=Array.from(this._activeDevices.values()).map(function(e){return e.deviceId});return this._beforeChange(this._name,r),!!t},e.prototype.get=function(){return this._activeDevices},e.prototype.set=function(e){var t=this;if(!this._isSupported)return Promise.reject(new i.NotSupportedError("This browser does not support audio output selection"));var n=Array.isArray(e)?e:[e];if(!n.length)return Promise.reject(new i.InvalidArgumentError("Must specify at least one device to set"));var r=[],o=n.map(function(e){var n=t._availableDevices.get(e);return n||r.push(e),n});return r.length?Promise.reject(new i.InvalidArgumentError("Devices not found: "+r.join(", "))):new Promise(function(e){e(t._beforeChange(t._name,n))}).then(function(){t._activeDevices.clear(),o.forEach(t._activeDevices.add,t._activeDevices)})},e.prototype.test=function(e){return(void 0===e&&(e=o),this._isSupported)?this._activeDevices.size?Promise.all(Array.from(this._activeDevices).map(function(t){var n;return new Promise(function(t){(n=new Audio(e)).oncanplay=t}).then(function(){return n.setSinkId(t.deviceId).then(function(){return n.play()})})})):Promise.reject(new i.InvalidStateError("No active output devices to test")):Promise.reject(new i.NotSupportedError("This browser does not support audio output selection"))},e}();n.default=a},{"./constants":7,"./errors":12}],16:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{c(r.next(e))}catch(t){o(t)}}function s(e){try{c(r.throw(e))}catch(t){o(t)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(a,s)}c((r=r.apply(e,t||[])).next())})},s=this&&this.__generator||function(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function o(s){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(c){s=[6,c],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([o,s])}}};Object.defineProperty(n,"__esModule",{value:!0});var c,u,l,d,p,f,h,m=e("events"),g=e("../connection"),v=e("../device"),y=e("../errors"),$=e("../rtc/stats"),S=e("../constants"),b=S.COWBELL_AUDIO_URL,w=S.ECHO_TEST_DURATION,C=function(e){function t(n,r){var i=e.call(this)||this;return i._hasInsightsErrored=!1,i._networkTiming={},i._options={codecPreferences:[g.default.Codec.PCMU,g.default.Codec.Opus],debug:!1,edge:"roaming",fakeMicInput:!1,signalingTimeoutMs:1e4},i._status=t.Status.Connecting,Object.assign(i._options,r),i._samples=[],i._warnings=[],i._startTime=Date.now(),i._initDevice(n,o(o({},i._options),{fileInputStream:i._options.fakeMicInput?i._getStreamFromFile():void 0})),i}return i(t,e),t.prototype.stop=function(){var e=this,t={code:31008,message:"Call cancelled"};this._device?(this._device.once("offline",function(){return e._onFailed(t)}),this._device.destroy()):this._onFailed(t)},t.prototype._emitWarning=function(e,n,r){var i={name:e,description:n};r&&(i.rtcWarning=r),this._warnings.push(i),this.emit(t.Events.Warning,i)},t.prototype._getCallQuality=function(e){return e>4.2?t.CallQuality.Excellent:e>=4.1&&e<=4.2?t.CallQuality.Great:e>=3.7&&e<=4?t.CallQuality.Good:e>=3.1&&e<=3.6?t.CallQuality.Fair:t.CallQuality.Degraded},t.prototype._getReport=function(){var e=this._getRTCStats(),t={start:this._startTime};this._endTime&&(t.end=this._endTime,t.duration=this._endTime-this._startTime);var n={callSid:this._callSid,edge:this._edge,iceCandidateStats:this._rtcIceCandidateStatsReport.iceCandidateStats,networkTiming:this._networkTiming,samples:this._samples,selectedEdge:this._options.edge,stats:e,testTiming:t,totals:this._getRTCSampleTotals(),warnings:this._warnings},r=this._rtcIceCandidateStatsReport.selectedIceCandidatePairStats;return r&&(n.selectedIceCandidatePairStats=r,n.isTurnRequired="relay"===r.localCandidate.candidateType||"relay"===r.remoteCandidate.candidateType),e&&(n.callQuality=this._getCallQuality(e.mos.average)),n},t.prototype._getRTCSampleTotals=function(){if(this._latestSample)return o({},this._latestSample.totals)},t.prototype._getRTCStats=function(){var e=this._samples.findIndex(function(e){return"number"==typeof e.mos&&e.mos>0}),t=e>=0?this._samples.slice(e):[];if(t&&t.length)return["jitter","mos","rtt"].reduce(function(e,n){var r,i=t.map(function(e){return e[n]});return o(o({},e),((r={})[n]={average:Number((i.reduce(function(e,t){return e+t})/i.length).toPrecision(5)),max:Math.max.apply(Math,i),min:Math.min.apply(Math,i)},r))},{})},t.prototype._getStreamFromFile=function(){var e=this._options.audioContext;if(!e)throw new y.NotSupportedError("Cannot fake input audio stream: AudioContext is not supported by this browser.");var t=new Audio(b);t.addEventListener("canplaythrough",function(){return t.play()}),"function"==typeof t.setAttribute&&t.setAttribute("crossorigin","anonymous");var n=e.createMediaElementSource(t),r=e.createMediaStreamDestination();return n.connect(r),r.stream},t.prototype._initDevice=function(e,t){var n=this;try{this._device=new(t.deviceFactory||v.default)(e,{codecPreferences:t.codecPreferences,debug:t.debug,edge:t.edge,fileInputStream:t.fileInputStream,iceServers:t.iceServers,preflight:!0,rtcConfiguration:t.rtcConfiguration})}catch(r){setTimeout(function(){n._onFailed(r)});return}this._device.once("ready",function(){n._onDeviceReady()}),this._device.once("error",function(e){n._onDeviceError(e)}),this._signalingTimeoutTimer=setTimeout(function(){n._onDeviceError({code:31901,message:"WebSocket - Connection Timeout"})},t.signalingTimeoutMs)},t.prototype._onDeviceError=function(e){this._device.destroy(),this._onFailed(e)},t.prototype._onDeviceReady=function(){var e=this;if(clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._connection=this._device.connect(),this._networkTiming.signaling={start:Date.now()},this._setupConnectionHandlers(this._connection),this._edge=this._device.edge||void 0,this._options.fakeMicInput){this._echoTimer=setTimeout(function(){return e._device.disconnectAll()},w);var t=this._device.audio;t&&(t.disconnect(!1),t.outgoing(!1))}this._device.once("disconnect",function(){e._device.once("offline",function(){return e._onOffline()}),e._device.destroy()}),this._connection._publisher.on("error",function(){e._hasInsightsErrored||e._emitWarning("insights-connection-error","Received an error when attempting to connect to Insights gateway"),e._hasInsightsErrored=!0})},t.prototype._onFailed=function(e){clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=t.Status.Failed,this.emit(t.Events.Failed,e)},t.prototype._onOffline=function(){var e=this;setTimeout(function(){e._status!==t.Status.Failed&&(clearTimeout(e._echoTimer),clearTimeout(e._signalingTimeoutTimer),e._releaseHandlers(),e._endTime=Date.now(),e._status=t.Status.Completed,e._report=e._getReport(),e.emit(t.Events.Completed,e._report))},10)},t.prototype._releaseHandlers=function(){[this._device,this._connection].forEach(function(e){e&&e.eventNames().forEach(function(t){return e.removeAllListeners(t)})})},t.prototype._setupConnectionHandlers=function(e){var n=this;this._options.fakeMicInput&&e.once("volume",function(){e.mediaStream.outputs.forEach(function(e){return e.audio.muted=!0})}),e.on("warning",function(e,t){n._emitWarning(e,"Received an RTCWarning. See .rtcWarning for the RTCWarning",t)}),e.once("accept",function(){n._callSid=e.mediaStream.callSid,n._status=t.Status.Connected,n.emit(t.Events.Connected)}),e.on("sample",function(r){return a(n,void 0,void 0,function(){var n;return s(this,function(i){switch(i.label){case 0:if(this._latestSample)return[3,2];return n=this,[4,(this._options.getRTCIceCandidateStatsReport||$.getRTCIceCandidateStatsReport)(e.mediaStream.version.pc)];case 1:n._rtcIceCandidateStatsReport=i.sent(),i.label=2;case 2:return this._latestSample=r,this._samples.push(r),this.emit(t.Events.Sample,r),[2]}})})}),[{reportLabel:"peerConnection",type:"pcconnection"},{reportLabel:"ice",type:"iceconnection"},{reportLabel:"dtls",type:"dtlstransport"},{reportLabel:"signaling",type:"signaling"}].forEach(function(t){var r=t.type,i=t.reportLabel,o="on"+r+"statechange",a=e.mediaStream[o];e.mediaStream[o]=function(e){var t=n._networkTiming[i]=n._networkTiming[i]||{start:0};"connecting"===e||"checking"===e?t.start=Date.now():"connected"!==e&&"stable"!==e||t.duration||(t.end=Date.now(),t.duration=t.end-t.start),a(e)}})},Object.defineProperty(t.prototype,"callSid",{get:function(){return this._callSid},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"endTime",{get:function(){return this._endTime},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"latestSample",{get:function(){return this._latestSample},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"report",{get:function(){return this._report},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this._startTime},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),t}(m.EventEmitter);n.PreflightTest=C,(p=u=(c=C=n.PreflightTest||(n.PreflightTest={})).CallQuality||(c.CallQuality={})).Excellent="excellent",p.Great="great",p.Good="good",p.Fair="fair",p.Degraded="degraded",(f=l=c.Events||(c.Events={})).Completed="completed",f.Connected="connected",f.Failed="failed",f.Sample="sample",f.Warning="warning",(h=d=c.Status||(c.Status={})).Connecting="connecting",h.Connected="connected",h.Completed="completed",h.Failed="failed",n.PreflightTest=C},{"../connection":6,"../constants":7,"../device":9,"../errors":12,"../rtc/stats":28,events:47}],17:[function(e,t,n){"use strict";var r=e("./constants"),i=e("events").EventEmitter,o=e("./log").default,a=e("util"),s=e("./wstransport").default,c=e("./errors"),u=c.GeneralErrors,l=c.SignalingErrors;function d(e,t,n){if(!(this instanceof d))return new d(e,t,n);var r={TransportFactory:s};for(var i in n=n||{},r)i in n||(n[i]=r[i]);this.options=n,this.token=e||"",this.status="disconnected",this.gateway=null,this.region=null,this._messageQueue=[],this._uris=t,this._handleTransportClose=this._handleTransportClose.bind(this),this._handleTransportError=this._handleTransportError.bind(this),this._handleTransportMessage=this._handleTransportMessage.bind(this),this._handleTransportOpen=this._handleTransportOpen.bind(this),this._log=o.getInstance(),this.on("error",function(){});var a=this;return this.addListener("ready",function(){a.status="ready"}),this.addListener("offline",function(){a.status="offline"}),this.addListener("close",function(){a._log.info('Received "close" from server. Destroying PStream...'),a._destroy()}),this.transport=new this.options.TransportFactory(this._uris,{backoffMaxMs:this.options.backoffMaxMs}),Object.defineProperties(this,{uri:{enumerable:!0,get:function e(){return this.transport.uri}}}),this.transport.on("close",this._handleTransportClose),this.transport.on("error",this._handleTransportError),this.transport.on("message",this._handleTransportMessage),this.transport.on("open",this._handleTransportOpen),this.transport.open(),this}a.inherits(d,i),d.prototype._handleTransportClose=function(){this.emit("transportClose"),"disconnected"!==this.status&&("offline"!==this.status&&this.emit("offline",this),this.status="disconnected")},d.prototype._handleTransportError=function(e){if(!e){this.emit("error",{error:{code:31e3,message:"Websocket closed without a provided reason",twilioError:new l.ConnectionDisconnected}});return}this.emit("error",void 0!==e.code?{error:e}:e)},d.prototype._handleTransportMessage=function(e){if(e&&e.data&&"string"==typeof e.data){var t=JSON.parse(e.data),n=t.type,r=t.payload,i=void 0===r?{}:r;this.gateway=i.gateway||this.gateway,this.region=i.region||this.region,"error"===n&&i.error&&(i.error.twilioError=new l.ConnectionError),this.emit(n,i)}},d.prototype._handleTransportOpen=function(){var e=this;this.status="connected",this.setToken(this.token),this._messageQueue.splice(0,this._messageQueue.length).forEach(function(t){return e._publish.apply(e,function e(t){if(!Array.isArray(t))return Array.from(t);for(var n=0,r=Array(t.length);n<t.length;n++)r[n]=t[n];return r}(t))})},d.toString=function(){return"[Twilio.PStream class]"},d.prototype.toString=function(){return"[Twilio.PStream instance]"},d.prototype.setToken=function(e){this._log.info("Setting token and publishing listen"),this.token=e;var t,n={token:e,browserinfo:(t="undefined"!=typeof navigator?navigator:{},{p:"browser",v:r.RELEASE_VERSION,browser:{userAgent:t.userAgent||"unknown",platform:t.platform||"unknown"},plugin:"rtc"})};this._publish("listen",n)},d.prototype.register=function(e){this._publish("register",{media:e},!0)},d.prototype.invite=function(e,t,n,r){this._publish("invite",{callsid:t,sdp:e,preflight:!!n,twilio:r?{params:r}:{}},!0)},d.prototype.answer=function(e,t){this._publish("answer",{sdp:e,callsid:t},!0)},d.prototype.dtmf=function(e,t){this._publish("dtmf",{callsid:e,dtmf:t},!0)},d.prototype.hangup=function(e,t){this._publish("hangup",t?{callsid:e,message:t}:{callsid:e},!0)},d.prototype.reject=function(e){this._publish("reject",{callsid:e},!0)},d.prototype.reinvite=function(e,t){this._publish("reinvite",{sdp:e,callsid:t},!1)},d.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose),this.transport.removeListener("error",this._handleTransportError),this.transport.removeListener("message",this._handleTransportMessage),this.transport.removeListener("open",this._handleTransportOpen),this.transport.close(),this.emit("offline",this)},d.prototype.destroy=function(){return this._log.info("PStream.destroy() called..."),this._destroy(),this},d.prototype.publish=function(e,t){return this._publish(e,t,!0)},d.prototype._publish=function(e,t,n){var r=JSON.stringify({type:e,version:"1.5",payload:t});!this.transport.send(r)&&(this.emit("error",{error:{code:31009,message:"No transport available to send or receive messages",twilioError:new u.TransportError}}),n&&this._messageQueue.push([e,t,!0]))},t.exports=d},{"./constants":7,"./errors":12,"./log":14,"./wstransport":35,events:47,util:59}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,i,o,a,s,c,u,l,d,p,f=e("./errors");function h(e){return e===n.defaultRegion?n.defaultChunderRegionURI:"chunderw-vpc-gll-"+e+".twilio.com"}(l=s=n.DeprecatedRegion||(n.DeprecatedRegion={})).Au="au",l.Br="br",l.Ie="ie",l.Jp="jp",l.Sg="sg",l.UsOr="us-or",l.UsVa="us-va",(d=c=n.Edge||(n.Edge={})).Sydney="sydney",d.SaoPaulo="sao-paulo",d.Dublin="dublin",d.Frankfurt="frankfurt",d.Tokyo="tokyo",d.Singapore="singapore",d.Ashburn="ashburn",d.Umatilla="umatilla",d.Roaming="roaming",d.AshburnIx="ashburn-ix",d.SanJoseIx="san-jose-ix",d.LondonIx="london-ix",d.FrankfurtIx="frankfurt-ix",d.SingaporeIx="singapore-ix",d.SydneyIx="sydney-ix",d.TokyoIx="tokyo-ix",(p=u=n.Region||(n.Region={})).Au1="au1",p.Au1Ix="au1-ix",p.Br1="br1",p.De1="de1",p.De1Ix="de1-ix",p.Gll="gll",p.Ie1="ie1",p.Ie1Ix="ie1-ix",p.Ie1Tnx="ie1-tnx",p.Jp1="jp1",p.Jp1Ix="jp1-ix",p.Sg1="sg1",p.Sg1Ix="sg1-ix",p.Sg1Tnx="sg1-tnx",p.Us1="us1",p.Us1Ix="us1-ix",p.Us1Tnx="us1-tnx",p.Us2="us2",p.Us2Ix="us2-ix",p.Us2Tnx="us2-tnx",n.deprecatedRegions=((r={})[s.Au]=u.Au1,r[s.Br]=u.Br1,r[s.Ie]=u.Ie1,r[s.Jp]=u.Jp1,r[s.Sg]=u.Sg1,r[s.UsOr]=u.Us1,r[s.UsVa]=u.Us1,r),n.regionShortcodes={ASIAPAC_SINGAPORE:u.Sg1,ASIAPAC_SYDNEY:u.Au1,ASIAPAC_TOKYO:u.Jp1,EU_FRANKFURT:u.De1,EU_IRELAND:u.Ie1,SOUTH_AMERICA_SAO_PAULO:u.Br1,US_EAST_VIRGINIA:u.Us1,US_WEST_OREGON:u.Us2},(i={})[u.Au1]="chunderw-vpc-gll-au1.twilio.com",i[u.Au1Ix]="chunderw-vpc-gll-au1-ix.twilio.com",i[u.Br1]="chunderw-vpc-gll-br1.twilio.com",i[u.De1]="chunderw-vpc-gll-de1.twilio.com",i[u.De1Ix]="chunderw-vpc-gll-de1-ix.twilio.com",i[u.Gll]="chunderw-vpc-gll.twilio.com",i[u.Ie1]="chunderw-vpc-gll-ie1.twilio.com",i[u.Ie1Ix]="chunderw-vpc-gll-ie1-ix.twilio.com",i[u.Ie1Tnx]="chunderw-vpc-gll-ie1-tnx.twilio.com",i[u.Jp1]="chunderw-vpc-gll-jp1.twilio.com",i[u.Jp1Ix]="chunderw-vpc-gll-jp1-ix.twilio.com",i[u.Sg1]="chunderw-vpc-gll-sg1.twilio.com",i[u.Sg1Ix]="chunderw-vpc-gll-sg1-ix.twilio.com",i[u.Sg1Tnx]="chunderw-vpc-gll-sg1-tnx.twilio.com",i[u.Us1]="chunderw-vpc-gll-us1.twilio.com",i[u.Us1Ix]="chunderw-vpc-gll-us1-ix.twilio.com",i[u.Us1Tnx]="chunderw-vpc-gll-us1-tnx.twilio.com",i[u.Us2]="chunderw-vpc-gll-us2.twilio.com",i[u.Us2Ix]="chunderw-vpc-gll-us2-ix.twilio.com",i[u.Us2Tnx]="chunderw-vpc-gll-us2-tnx.twilio.com",n.edgeToRegion=((o={})[c.Sydney]=u.Au1,o[c.SaoPaulo]=u.Br1,o[c.Dublin]=u.Ie1,o[c.Frankfurt]=u.De1,o[c.Tokyo]=u.Jp1,o[c.Singapore]=u.Sg1,o[c.Ashburn]=u.Us1,o[c.Umatilla]=u.Us2,o[c.Roaming]=u.Gll,o[c.AshburnIx]=u.Us1Ix,o[c.SanJoseIx]=u.Us2Ix,o[c.LondonIx]=u.Ie1Ix,o[c.FrankfurtIx]=u.De1Ix,o[c.SingaporeIx]=u.Sg1Ix,o[c.SydneyIx]=u.Au1Ix,o[c.TokyoIx]=u.Jp1Ix,o),n.regionToEdge=((a={})[u.Au1]=c.Sydney,a[u.Br1]=c.SaoPaulo,a[u.Ie1]=c.Dublin,a[u.De1]=c.Frankfurt,a[u.Jp1]=c.Tokyo,a[u.Sg1]=c.Singapore,a[u.Us1]=c.Ashburn,a[u.Us2]=c.Umatilla,a[u.Gll]=c.Roaming,a[u.Us1Ix]=c.AshburnIx,a[u.Us2Ix]=c.SanJoseIx,a[u.Ie1Ix]=c.LondonIx,a[u.De1Ix]=c.FrankfurtIx,a[u.Sg1Ix]=c.SingaporeIx,a[u.Au1Ix]=c.SydneyIx,a[u.Jp1Ix]=c.TokyoIx,a[u.Us1Tnx]=c.AshburnIx,a[u.Us2Tnx]=c.AshburnIx,a[u.Ie1Tnx]=c.LondonIx,a[u.Sg1Tnx]=c.SingaporeIx,a),n.defaultRegion="gll",n.defaultEdge=c.Roaming,n.defaultChunderRegionURI="chunderw-vpc-gll.twilio.com",n.getChunderURIs=function e(t,r,i){if(r&&"string"!=typeof r)throw new f.InvalidArgumentError("If `region` is provided, it must be of type `string`.");if(t&&"string"!=typeof t&&!Array.isArray(t))throw new f.InvalidArgumentError("If `edge` is provided, it must be of type `string` or an array of strings.");var o,a=[];if(r&&t)throw new f.InvalidArgumentError("You cannot specify `region` when `edge` is specified in`Twilio.Device.Options`.");if(r){var l=r;if(a.push("Regions are deprecated in favor of edges. Please see this page for documentation: https://www.twilio.com/docs/voice/client/edges."),Object.values(s).includes(l)&&(l=n.deprecatedRegions[l]),Object.values(u).includes(l)){var d=n.regionToEdge[l];a.push('Region "'+l+'" is deprecated, please use `edge` "'+d+'".')}o=[h(l)]}else if(t){var p=Object.values(c);o=(Array.isArray(t)?t:[t]).map(function(e){var t;return p.includes(e)?h(n.edgeToRegion[e]):"voice-js."+(t=e)+".twilio.com"})}else o=[n.defaultChunderRegionURI];return i&&a.length&&setTimeout(function(){return i(a.join("\n"))}),o},n.getRegionShortcode=function e(t){return n.regionShortcodes[t]||null}},{"./errors":12}],19:[function(e,t,n){"use strict";var r=e("xmlhttprequest").XMLHttpRequest,i=function e(t,n,i){var o={};o.XMLHttpRequest=o.XMLHttpRequest||r;var a=new o.XMLHttpRequest;for(var s in a.open(t,n.url,!0),a.onreadystatechange=function e(){if(4===a.readyState){if(200<=a.status&&a.status<300){i(null,a.responseText);return}i(Error(a.responseText))}},n.headers)a.setRequestHeader(s,n.headers[s]);a.send(JSON.stringify(n.body))};i.get=function e(t,n){return new this("GET",t,n)},i.post=function e(t,n){return new this("POST",t,n)},t.exports=i},{xmlhttprequest:2}],20:[function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("../errors").NotSupportedError,o=e("../util");t.exports=function e(t,n){return(n=n||{}).util=n.util||o,n.navigator=n.navigator||("undefined"!=typeof navigator?navigator:null),new Promise(function(e,o){if(!n.navigator)throw new i("getUserMedia is not supported");switch("function"){case r(n.navigator.mediaDevices&&n.navigator.mediaDevices.getUserMedia):return e(n.navigator.mediaDevices.getUserMedia(t));case r(n.navigator.webkitGetUserMedia):return n.navigator.webkitGetUserMedia(t,e,o);case r(n.navigator.mozGetUserMedia):return n.navigator.mozGetUserMedia(t,e,o);case r(n.navigator.getUserMedia):return n.navigator.getUserMedia(t,e,o);default:throw new i("getUserMedia is not supported")}}).catch(function(e){throw n.util.isFirefox()&&"NotReadableError"===e.name?new i("Firefox does not currently support opening multiple audio input trackssimultaneously, even across different tabs.\nRelated Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324"):e})}},{"../errors":12,"../util":34}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function e(e,t){void 0===t&&(t=!1),this.deleted=!1;var n,r=e.candidate.split("network-cost ");r[1]&&(n=parseInt(r[1],10)),this.candidateType=e.type,this.ip=e.ip||e.address,this.isRemote=t,this.networkCost=n,this.port=e.port,this.priority=e.priority,this.protocol=e.protocol,this.relatedAddress=e.relatedAddress,this.relatedPort=e.relatedPort,this.tcpType=e.tcpType,this.transportId=e.sdpMid}return e.prototype.toPayload=function(){return{candidate_type:this.candidateType,deleted:this.deleted,ip:this.ip,is_remote:this.isRemote,"network-cost":this.networkCost,port:this.port,priority:this.priority,protocol:this.protocol,related_address:this.relatedAddress,related_port:this.relatedPort,tcp_type:this.tcpType,transport_id:this.transportId}},e}();n.IceCandidate=r},{}],22:[function(e,t,n){"use strict";var r=e("./peerconnection"),i=e("./rtcpc").test;t.exports={enabled:function e(){return i()},getMediaEngine:function e(){return"undefined"!=typeof RTCIceGatherer?"ORTC":"WebRTC"},PeerConnection:r}},{"./peerconnection":25,"./rtcpc":26}],23:[function(e,t,n){var r="undefined"!=typeof window?window.RTCStatsReport:void 0;function i(e){if(!(this instanceof i))return new i(e);var t=this;Object.defineProperties(this,{size:{enumerable:!0,get:function(){return t._map.size}},_map:{value:e}}),this[Symbol.iterator]=e[Symbol.iterator]}function o(e){return{type:"transport",id:e.id,timestamp:Date.parse(e.timestamp),bytesSent:void 0,bytesReceived:void 0,rtcpTransportStatsId:void 0,dtlsState:void 0,selectedCandidatePairId:e.stat("selectedCandidatePairId"),localCertificateId:e.stat("localCertificateId"),remoteCertificateId:e.stat("remoteCertificateId")}}function a(e,t){return{id:e.id,timestamp:Date.parse(e.timestamp),ssrc:e.stat("ssrc"),associateStatsId:void 0,isRemote:void 0,mediaType:e.stat("mediaType"),trackId:"track-"+e.id,transportId:e.stat("transportId"),codecId:"codec-"+e.id,firCount:t?u(e,"googFirsSent"):void 0,pliCount:t?u(e,"googPlisSent"):u(e,"googPlisReceived"),nackCount:t?u(e,"googNacksSent"):u(e,"googNacksReceived"),sliCount:void 0,qpSum:u(e,"qpSum")}}function s(e,t){return{type:t?"remote-candidate":"local-candidate",id:e.id,timestamp:Date.parse(e.timestamp),transportId:void 0,isRemote:t,ip:e.stat("ipAddress"),port:u(e,"portNumber"),protocol:e.stat("transport"),candidateType:function e(t){switch(t){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";default:return t}}(e.stat("candidateType")),priority:l(e,"priority"),url:void 0,relayProtocol:void 0,deleted:void 0}}function c(e){return isNaN(e)||""===e?void 0:parseInt(e,10)/1e3}function u(e,t){var n=e.stat(t);return p(e,t)?parseInt(n,10):void 0}function l(e,t){var n=e.stat(t);return p(e,t)?parseFloat(n):void 0}function d(e,t){var n=e.stat(t);return p(e,t)?"true"===n||!0===n:void 0}function p(e,t){var n=e.stat(t);return void 0!==n&&""!==n}r&&(i.prototype=Object.create(r.prototype),i.prototype.constructor=i),["entries","forEach","get","has","keys","values"].forEach(function(e){i.prototype[e]=function(){for(var t,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return(t=this._map)[e].apply(t,n)}}),i.fromArray=function e(t){return new i(t.reduce(function(e,t){return e.set(t.id,t),e},new Map))},i.fromRTCStatsResponse=function e(t){var n,r=new Map,f=t.result().reduce(function(e,t){var i,f,h,m,g,v,y,$,S,b=t.id;switch(t.type){case"googCertificate":e.set(b,(i=t,{type:"certificate",id:i.id,timestamp:Date.parse(i.timestamp),fingerprint:i.stat("googFingerprint"),fingerprintAlgorithm:i.stat("googFingerprintAlgorithm"),base64Certificate:i.stat("googDerBase64"),issuerCertificateId:i.stat("googIssuerId")}));break;case"datachannel":e.set(b,(f=t,{type:"data-channel",id:f.id,timestamp:Date.parse(f.timestamp),label:f.stat("label"),protocol:f.stat("protocol"),datachannelid:f.stat("datachannelid"),transportId:f.stat("transportId"),state:f.stat("state"),messagesSent:void 0,bytesSent:void 0,messagesReceived:void 0,bytesReceived:void 0}));break;case"googCandidatePair":d(t,"googActiveConnection")&&(n=b),e.set(b,(h=t,{type:"candidate-pair",id:h.id,timestamp:Date.parse(h.timestamp),transportId:h.stat("googChannelId"),localCandidateId:h.stat("localCandidateId"),remoteCandidateId:h.stat("remoteCandidateId"),state:void 0,priority:void 0,nominated:void 0,writable:d(h,"googWritable"),readable:void 0,bytesSent:u(h,"bytesSent"),bytesReceived:u(h,"bytesReceived"),lastPacketSentTimestamp:void 0,lastPacketReceivedTimestamp:void 0,totalRoundTripTime:void 0,currentRoundTripTime:c(h.stat("googRtt")),availableOutgoingBitrate:void 0,availableIncomingBitrate:void 0,requestsReceived:u(h,"requestsReceived"),requestsSent:u(h,"requestsSent"),responsesReceived:u(h,"responsesReceived"),responsesSent:u(h,"responsesSent"),retransmissionsReceived:void 0,retransmissionsSent:void 0,consentRequestsSent:u(h,"consentRequestsSent")}));break;case"localcandidate":e.set(b,s(t,!1));break;case"remotecandidate":e.set(b,s(t,!0));break;case"ssrc":p(t,"packetsReceived")?e.set("rtp-"+b,(m=t,g=a(m,!0),Object.assign(g,{type:"inbound-rtp",packetsReceived:u(m,"packetsReceived"),bytesReceived:u(m,"bytesReceived"),packetsLost:u(m,"packetsLost"),jitter:c(m.stat("googJitterReceived")),fractionLost:void 0,roundTripTime:c(m.stat("googRtt")),packetsDiscarded:void 0,packetsRepaired:void 0,burstPacketsLost:void 0,burstPacketsDiscarded:void 0,burstLossCount:void 0,burstDiscardCount:void 0,burstLossRate:void 0,burstDiscardRate:void 0,gapLossRate:void 0,gapDiscardRate:void 0,framesDecoded:u(m,"framesDecoded")}),g)):e.set("rtp-"+b,(v=t,y=a(v,!1),Object.assign(y,{type:"outbound-rtp",remoteTimestamp:void 0,packetsSent:u(v,"packetsSent"),bytesSent:u(v,"bytesSent"),targetBitrate:void 0,framesEncoded:u(v,"framesEncoded")}),y)),e.set("track-"+b,($=t,{type:"track",id:$.id,timestamp:Date.parse($.timestamp),trackIdentifier:$.stat("googTrackId"),remoteSource:void 0,ended:void 0,kind:$.stat("mediaType"),detached:void 0,ssrcIds:void 0,frameWidth:p($,"googFrameWidthReceived")?u($,"googFrameWidthReceived"):u($,"googFrameWidthSent"),frameHeight:p($,"googFrameHeightReceived")?u($,"googFrameHeightReceived"):u($,"googFrameHeightSent"),framesPerSecond:void 0,framesSent:u($,"framesEncoded"),framesReceived:void 0,framesDecoded:u($,"framesDecoded"),framesDropped:void 0,framesCorrupted:void 0,partialFramesLost:void 0,fullFramesLost:void 0,audioLevel:p($,"audioOutputLevel")?u($,"audioOutputLevel")/32767:(u($,"audioInputLevel")||0)/32767,echoReturnLoss:l($,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:l($,"googEchoCancellationReturnLossEnhancement")})),e.set("codec-"+b,(S=t,{type:"codec",id:S.id,timestamp:Date.parse(S.timestamp),payloadType:void 0,mimeType:S.stat("mediaType")+"/"+S.stat("googCodecName"),clockRate:void 0,channels:void 0,sdpFmtpLine:void 0,implementation:void 0}));break;case"googComponent":var w=o(t);r.set(w.selectedCandidatePairId,b),e.set(b,o(t))}return e},new Map);if(n){var h=r.get(n);h&&(f.get(h).dtlsState="connected")}return new i(f)},t.exports=i},{}],24:[function(e,t,n){"use strict";var r={r0:94.768,is:1.42611};function i(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)&&e>=0}t.exports={calculate:function e(t,n,o){if(!i(t)||!i(n)||!i(o))return null;var a=function e(t,n,i){var o=t+2*n+10,a=0;switch(!0){case o<160:a=r.r0-o/40;break;case o<1e3:a=r.r0-(o-120)/10;break;case o>=1e3:a=r.r0-o/100}var s=.01;switch(!0){case -1===i:s=0,a=0;break;case i<=a/2.5:s=2.5;break;case i>a/2.5&&i<100:s=.25}return a-i*s}(t,n,o),s=1+.035*a+7e-6*a*(a-60)*(100-a);return s>=1&&s<4.6?s:null}}},{}],25:[function(e,t,n){"use strict";var r=e("../errors"),i=r.InvalidArgumentError,o=r.MediaErrors,a=r.NotSupportedError,s=r.SignalingErrors,c=e("../log").default,u=e("../util"),l=e("./rtcpc"),d=e("./sdp").setIceAggressiveNomination;function p(e,t,n,r){if(!e||!t||!n)throw new i("Audiohelper, pstream and getUserMedia are required arguments");if(!(this instanceof p))return new p(e,t,n,r);function o(){}this.onopen=o,this.onerror=o,this.onclose=o,this.ondisconnected=o,this.onfailed=o,this.onconnected=o,this.onreconnected=o,this.onsignalingstatechange=o,this.ondtlstransportstatechange=o,this.onicegatheringfailure=o,this.onicegatheringstatechange=o,this.oniceconnectionstatechange=o,this.onpcconnectionstatechange=o,this.onicecandidate=o,this.onselectedcandidatepairchange=o,this.onvolume=o,this.version=null,this.pstream=t,this.stream=null,this.sinkIds=new Set(["default"]),this.outputs=new Map,this.status="connecting",this.callSid=null,this.isMuted=!1,this.getUserMedia=n;var a="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);return this._isSinkSupported=!!a&&"undefined"!=typeof HTMLAudioElement&&HTMLAudioElement.prototype.setSinkId,this._audioContext=a&&e._audioContext,this._hasIceCandidates=!1,this._hasIceGatheringFailures=!1,this._iceGatheringTimeoutId=null,this._masterAudio=null,this._masterAudioDeviceId=null,this._mediaStreamSource=null,this._dtmfSender=null,this._dtmfSenderUnsupported=!1,this._callEvents=[],this._nextTimeToPublish=Date.now(),this._onAnswerOrRinging=o,this._onHangup=o,this._remoteStream=null,this._shouldManageStream=!0,this._iceState="new",this._isUnifiedPlan=r.isUnifiedPlan,this.options=r=r||{},this.navigator=r.navigator||("undefined"!=typeof navigator?navigator:null),this.util=r.util||u,this.codecPreferences=r.codecPreferences,this._filters={},this._log=c.getInstance(),this}function f(e,t){"function"==typeof e.addTrack?t.getAudioTracks().forEach(function(n){e.addTrack(n,t)}):e.addStream(t)}function h(e){var t="undefined"!=typeof MediaStream?new MediaStream:new webkitMediaStream;return e.getAudioTracks().forEach(t.addTrack,t),t}function m(e,t){if(void 0!==e.srcObject)e.srcObject=t;else if(void 0!==e.mozSrcObject)e.mozSrcObject=t;else{if(void 0===e.src)return!1;var n=e.options.window||window;e.src=(n.URL||n.webkitURL).createObjectURL(t)}return!0}p.prototype.uri=function(){return this._uri},p.prototype.openWithConstraints=function(e){return this.getUserMedia({audio:e}).then(this._setInputTracksFromStream.bind(this,!1))},p.prototype.setInputTracksFromStream=function(e){var t=this;return this._setInputTracksFromStream(!0,e).then(function(){t._shouldManageStream=!1})},p.prototype._createAnalyser=function(e,t){t=Object.assign({fftSize:32,smoothingTimeConstant:.3},t);var n=e.createAnalyser();for(var r in t)n[r]=t[r];return n},p.prototype._setVolumeHandler=function(e){this.onvolume=e},p.prototype._startPollingVolume=function(){if(this._audioContext&&this.stream&&this._remoteStream){var e=this._audioContext,t=(this._inputAnalyser=this._createAnalyser(e)).frequencyBinCount,n=new Uint8Array(t);this._inputAnalyser2=this._createAnalyser(e,{minDecibels:-127,maxDecibels:0,smoothingTimeConstant:0});var r=(this._outputAnalyser=this._createAnalyser(e)).frequencyBinCount,i=new Uint8Array(r);this._outputAnalyser2=this._createAnalyser(e,{minDecibels:-127,maxDecibels:0,smoothingTimeConstant:0}),this._updateInputStreamSource(this.stream),this._updateOutputStreamSource(this._remoteStream);var o=this;setTimeout(function e(){if(o._audioContext){if("closed"===o.status){o._inputAnalyser.disconnect(),o._outputAnalyser.disconnect(),o._inputAnalyser2.disconnect(),o._outputAnalyser2.disconnect();return}o._inputAnalyser.getByteFrequencyData(n);var t=o.util.average(n);o._inputAnalyser2.getByteFrequencyData(n);var r=o.util.average(n);o._outputAnalyser.getByteFrequencyData(i);var a=o.util.average(i);o._outputAnalyser2.getByteFrequencyData(i);var s=o.util.average(i);o.onvolume(t/255,a/255,r,s),setTimeout(e,50)}},50)}},p.prototype._stopStream=function e(t){this._shouldManageStream&&("function"==typeof MediaStreamTrack.prototype.stop?("function"==typeof t.getAudioTracks?t.getAudioTracks():t.audioTracks).forEach(function(e){e.stop()}):t.stop())},p.prototype._updateInputStreamSource=function(e){this._inputStreamSource&&this._inputStreamSource.disconnect(),this._inputStreamSource=this._audioContext.createMediaStreamSource(e),this._inputStreamSource.connect(this._inputAnalyser),this._inputStreamSource.connect(this._inputAnalyser2)},p.prototype._updateOutputStreamSource=function(e){this._outputStreamSource&&this._outputStreamSource.disconnect(),this._outputStreamSource=this._audioContext.createMediaStreamSource(e),this._outputStreamSource.connect(this._outputAnalyser),this._outputStreamSource.connect(this._outputAnalyser2)},p.prototype._setInputTracksFromStream=function(e,t){return this._isUnifiedPlan?this._setInputTracksForUnifiedPlan(e,t):this._setInputTracksForPlanB(e,t)},p.prototype._setInputTracksForPlanB=function(e,t){var n=this;if(!t)return Promise.reject(new i("Can not set input stream to null while in a call"));if(!t.getAudioTracks().length)return Promise.reject(new i("Supplied input stream has no audio tracks"));var r,o,a=this.stream;return(a?(this._stopStream(a),r=this.version.pc,o=a,"function"==typeof r.removeTrack?r.getSenders().forEach(function(e){r.removeTrack(e)}):r.removeStream(o),a.getAudioTracks().forEach(a.removeTrack,a),t.getAudioTracks().forEach(a.addTrack,a),f(this.version.pc,t),this._updateInputStreamSource(this.stream)):this.stream=e?h(t):t,this.mute(this.isMuted),this.version)?new Promise(function(e,t){n.version.createOffer(n.options.maxAverageBitrate,n.codecPreferences,{audio:!0},function(){n.version.processAnswer(n.codecPreferences,n._answerSdp,function(){e(n.stream)},t)},t)}):Promise.resolve(this.stream)},p.prototype._setInputTracksForUnifiedPlan=function(e,t){var n=this;if(!t)return Promise.reject(new i("Can not set input stream to null while in a call"));if(!t.getAudioTracks().length)return Promise.reject(new i("Supplied input stream has no audio tracks"));var r=this.stream,o=function e(){return n.mute(n.isMuted),Promise.resolve(n.stream)};return r?(this._shouldManageStream&&this._stopStream(r),this._sender||(this._sender=this.version.pc.getSenders()[0]),this._sender.replaceTrack(t.getAudioTracks()[0]).then(function(){return n._updateInputStreamSource(t),o()})):(this.stream=e?h(t):t,o())},p.prototype._onInputDevicesChanged=function(){this.stream&&this.stream.getAudioTracks().every(function(e){return"ended"===e.readyState})&&this._shouldManageStream&&this.openWithConstraints(!0)},p.prototype._onIceGatheringFailure=function(e){this._hasIceGatheringFailures=!0,this.onicegatheringfailure(e)},p.prototype._onMediaConnectionStateChange=function(e){var t=this._iceState;if(t!==e&&("connected"===e||"disconnected"===e||"failed"===e)){this._iceState=e;var n=void 0;switch(e){case"connected":"disconnected"===t||"failed"===t?(n="ICE liveliness check succeeded. Connection with Twilio restored",this._log.info(n),this.onreconnected(n)):(n="Media connection established.",this._log.info(n),this.onconnected(n)),this._stopIceGatheringTimeout(),this._hasIceGatheringFailures=!1;break;case"disconnected":n="ICE liveliness check failed. May be having trouble connecting to Twilio",this._log.info(n),this.ondisconnected(n);break;case"failed":n="Connection with Twilio was interrupted.",this._log.info(n),this.onfailed(n)}}},p.prototype._setSinkIds=function(e){return this._isSinkSupported?(this.sinkIds=new Set(e.forEach?e:[e]),this.version?this._updateAudioOutputs():Promise.resolve()):Promise.reject(new a("Audio output selection is not supported by this browser"))},p.prototype._startIceGatheringTimeout=function e(){var t=this;this._stopIceGatheringTimeout(),this._iceGatheringTimeoutId=setTimeout(function(){t._onIceGatheringFailure("timeout")},15e3)},p.prototype._stopIceGatheringTimeout=function e(){clearInterval(this._iceGatheringTimeoutId)},p.prototype._updateAudioOutputs=function e(){var t=Array.from(this.sinkIds).filter(function(e){return!this.outputs.has(e)},this),n=Array.from(this.outputs.keys()).filter(function(e){return!this.sinkIds.has(e)},this),r=this;return Promise.all(t.map(this._createAudioOutput,this)).then(function(){return Promise.all(n.map(r._removeAudioOutput,r))})},p.prototype._createAudio=function e(t){return new Audio(t)},p.prototype._createAudioOutput=function e(t){var n=this._audioContext.createMediaStreamDestination();this._mediaStreamSource.connect(n);var r=this._createAudio();m(r,n.stream);var i=this;return r.setSinkId(t).then(function(){return r.play()}).then(function(){i.outputs.set(t,{audio:r,dest:n})})},p.prototype._removeAudioOutputs=function e(){return this._masterAudio&&void 0!==this._masterAudioDeviceId&&(this._disableOutput(this,this._masterAudioDeviceId),this.outputs.delete(this._masterAudioDeviceId),this._masterAudioDeviceId=null,this._masterAudio.paused||this._masterAudio.pause(),void 0!==this._masterAudio.srcObject?this._masterAudio.srcObject=null:this._masterAudio.src="",this._masterAudio=null),Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)},p.prototype._disableOutput=function e(t,n){var r=t.outputs.get(n);r&&(r.audio&&(r.audio.pause(),r.audio.src=""),r.dest&&r.dest.disconnect())},p.prototype._reassignMasterOutput=function e(t,n){var r=t.outputs.get(n);t.outputs.delete(n);var i=this,o=Array.from(t.outputs.keys())[0]||"default";return r.audio.setSinkId(o).then(function(){i._disableOutput(t,o),t.outputs.set(o,r),t._masterAudioDeviceId=o}).catch(function e(){t.outputs.set(n,r),i._log.info("Could not reassign master output. Attempted to roll back.")})},p.prototype._removeAudioOutput=function e(t){return this._masterAudioDeviceId===t?this._reassignMasterOutput(this,t):(this._disableOutput(this,t),this.outputs.delete(t),Promise.resolve())},p.prototype._onAddTrack=function e(t,n){var r=t._masterAudio=this._createAudio();m(r,n),r.play();var i=Array.from(t.outputs.keys())[0]||"default";t._masterAudioDeviceId=i,t.outputs.set(i,{audio:r}),t.pcStream=n,t._updateAudioOutputs()},p.prototype._fallbackOnAddTrack=function e(t,n){var r=document&&document.createElement("audio");r.autoplay=!0,m(r,n)||t._log.info("Error attaching stream to element."),t.outputs.set("default",{audio:r})},p.prototype._setEncodingParameters=function(e){if(e&&this._sender&&"function"==typeof this._sender.getParameters&&"function"==typeof this._sender.setParameters){var t=this._sender.getParameters();(t.priority||t.encodings&&t.encodings.length)&&(t.priority="high",t.encodings&&t.encodings.length&&t.encodings.forEach(function(e){e.priority="high",e.networkPriority="high"}),this._sender.setParameters(t))}},p.prototype.addFilter=function(e,t){"function"==typeof t&&(this._filters[e]=t)},p.prototype._setupPeerConnection=function(e,t){var n=this,r=this,i=new(this.options.rtcpcFactory||l);i.create(e,t);var o=new(AudioContext=window.AudioContext||window.webkitAudioContext),a=o.createMediaStreamDestination(),s=o.createMediaStreamSource(this.stream),c={};for(var u in this._filters){var d=o.createScriptProcessor(512,1,1);d.onaudioprocess=this._filters[u],s.connect(d),c[u]=s=d}s.connect(a),setTimeout(function e(){if(r._audioContext){if("closed"===r.status){for(var t in c)c[t].disconnect();return}setTimeout(e,50)}},50),f(i.pc,a.stream);var p="ontrack"in i.pc?"ontrack":"onaddstream";return i.pc[p]=function(e){var t=r._remoteStream=e.stream||e.streams[0];"function"==typeof i.pc.getSenders&&(n._sender=i.pc.getSenders()[0]),r._isSinkSupported?r._onAddTrack(r,t):r._fallbackOnAddTrack(r,t),r._startPollingVolume()},i},p.prototype._maybeSetIceAggressiveNomination=function(e){return this.options.forceAggressiveIceNomination?d(e):e},p.prototype._setupChannel=function(){var e=this,t=this.version.pc;this.version.pc.onopen=function(){e.status="open",e.onopen()},this.version.pc.onstatechange=function(){e.version.pc&&"stable"===e.version.pc.readyState&&(e.status="open",e.onopen())},this.version.pc.onsignalingstatechange=function(){var n=t.signalingState;e._log.info('signalingState is "'+n+'"'),e.version.pc&&"stable"===e.version.pc.signalingState&&(e.status="open",e.onopen()),e.onsignalingstatechange(t.signalingState)},t.onconnectionstatechange=function(){e._log.info('pc.connectionState is "'+t.connectionState+'"'),e.onpcconnectionstatechange(t.connectionState),e._onMediaConnectionStateChange(t.connectionState)},t.onicecandidate=function(t){var n=t.candidate;n&&(e._hasIceCandidates=!0,e.onicecandidate(n),e._setupRTCIceTransportListener()),e._log.info("ICE Candidate: "+JSON.stringify(n))},t.onicegatheringstatechange=function(){var n=t.iceGatheringState;"gathering"===n?e._startIceGatheringTimeout():"complete"===n&&(e._stopIceGatheringTimeout(),e._hasIceCandidates||e._onIceGatheringFailure("none"),e._hasIceCandidates&&e._hasIceGatheringFailures&&e._startIceGatheringTimeout()),e._log.info('pc.iceGatheringState is "'+t.iceGatheringState+'"'),e.onicegatheringstatechange(n)},t.oniceconnectionstatechange=function(){e._log.info('pc.iceConnectionState is "'+t.iceConnectionState+'"'),e.oniceconnectionstatechange(t.iceConnectionState),e._onMediaConnectionStateChange(t.iceConnectionState)}},p.prototype._initializeMediaStream=function(e,t){return"open"!==this.status&&("disconnected"===this.pstream.status?(this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected",twilioError:new s.ConnectionDisconnected}}),this.close(),!1):(this.version=this._setupPeerConnection(e,t),this._setupChannel(),!0))},p.prototype._removeReconnectionListeners=function(){this.pstream&&(this.pstream.removeListener("answer",this._onAnswerOrRinging),this.pstream.removeListener("hangup",this._onHangup))},p.prototype._setupRTCDtlsTransportListener=function(){var e=this,t=this.getRTCDtlsTransport();if(t&&!t.onstatechange){var n=function n(){e._log.info('dtlsTransportState is "'+t.state+'"'),e.ondtlstransportstatechange(t.state)};n(),t.onstatechange=n}},p.prototype._setupRTCIceTransportListener=function(){var e=this,t=this._getRTCIceTransport();t&&!t.onselectedcandidatepairchange&&(t.onselectedcandidatepairchange=function(){return e.onselectedcandidatepairchange(t.getSelectedCandidatePair())})},p.prototype.iceRestart=function(){var e=this;this.options.enableIceRestart&&(this._log.info("Attempting to restart ICE..."),this._hasIceCandidates=!1,this.version.createOffer(this.options.maxAverageBitrate,this.codecPreferences,{iceRestart:!0}).then(function(){e._removeReconnectionListeners(),e._onAnswerOrRinging=function(t){if(e._removeReconnectionListeners(),!t.sdp||"have-local-offer"!==e.version.pc.signalingState){var n="Invalid state or param during ICE Restart:hasSdp:"+!!t.sdp+", signalingState:"+e.version.pc.signalingState;e._log.info(n);return}var r=e._maybeSetIceAggressiveNomination(t.sdp);e._answerSdp=r,"closed"!==e.status&&e.version.processAnswer(e.codecPreferences,r,null,function(t){var n=t&&t.message?t.message:t;e._log.info("Failed to process answer during ICE Restart. Error: "+n)})},e._onHangup=function(){e._log.info("Received hangup during ICE Restart"),e._removeReconnectionListeners()},e.pstream.on("answer",e._onAnswerOrRinging),e.pstream.on("hangup",e._onHangup),e.pstream.reinvite(e.version.getSDP(),e.callSid)}).catch(function(t){var n=t&&t.message?t.message:t;e._log.info("Failed to createOffer during ICE Restart. Error: "+n),e.onfailed(n)}))},p.prototype.makeOutgoingCall=function(e,t,n,r,i,a){var s=this;if(this._initializeMediaStream(r,i)){var c=this;this.callSid=n,this._onAnswerOrRinging=function(e){if(e.sdp){var t=s._maybeSetIceAggressiveNomination(e.sdp);c._answerSdp=t,"closed"!==c.status&&c.version.processAnswer(s.codecPreferences,t,u,l),c.pstream.removeListener("answer",c._onAnswerOrRinging),c.pstream.removeListener("ringing",c._onAnswerOrRinging)}},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("ringing",this._onAnswerOrRinging),this.version.createOffer(this.options.maxAverageBitrate,this.codecPreferences,{audio:!0},function e(){"closed"!==c.status&&(c.pstream.invite(c.version.getSDP(),c.callSid,c.options.preflight,t),c._setupRTCDtlsTransportListener())},function e(t){var n=t.message||t;c.onerror({info:{code:31e3,message:"Error creating the offer: "+n,twilioError:new o.ClientLocalDescFailed}})})}function u(){c.options&&c._setEncodingParameters(c.options.dscp),a(c.version.pc)}function l(e){var t=e.message||e;c.onerror({info:{code:31e3,message:"Error processing answer: "+t,twilioError:new o.ClientRemoteDescFailed}})}},p.prototype.answerIncomingCall=function(e,t,n,r,i){if(this._initializeMediaStream(n,r)){t=this._maybeSetIceAggressiveNomination(t),this._answerSdp=t.replace(/^a=setup:actpass$/gm,"a=setup:passive"),this.callSid=e;var a=this;this.version.processSDP(this.options.maxAverageBitrate,this.codecPreferences,t,{audio:!0},function t(){"closed"!==a.status&&(a.pstream.answer(a.version.getSDP(),e),a.options&&a._setEncodingParameters(a.options.dscp),i(a.version.pc),a._setupRTCDtlsTransportListener())},function e(t){var n=t.message||t;a.onerror({info:{code:31e3,message:"Error creating the answer: "+n,twilioError:new o.ClientRemoteDescFailed}})})}},p.prototype.close=function(){this.version&&this.version.pc&&("closed"!==this.version.pc.signalingState&&this.version.pc.close(),this.version.pc=null),this.stream&&(this.mute(!1),this._stopStream(this.stream)),this.stream=null,this._removeReconnectionListeners(),this._stopIceGatheringTimeout(),Promise.all(this._removeAudioOutputs()).catch(function(){}),this._mediaStreamSource&&this._mediaStreamSource.disconnect(),this._inputAnalyser&&this._inputAnalyser.disconnect(),this._outputAnalyser&&this._outputAnalyser.disconnect(),this._inputAnalyser2&&this._inputAnalyser2.disconnect(),this._outputAnalyser2&&this._outputAnalyser2.disconnect(),this.status="closed",this.onclose()},p.prototype.reject=function(e){this.callSid=e},p.prototype.ignore=function(e){this.callSid=e},p.prototype.mute=function(e){this.isMuted=e,this.stream&&(this._sender&&this._sender.track?this._sender.track.enabled=!e:("function"==typeof this.stream.getAudioTracks?this.stream.getAudioTracks():this.stream.audioTracks).forEach(function(t){t.enabled=!e}))},p.prototype.getOrCreateDTMFSender=function e(){if(this._dtmfSender||this._dtmfSenderUnsupported)return this._dtmfSender||null;var t=this,n=this.version.pc;if(!n)return this._log.info("No RTCPeerConnection available to call createDTMFSender on"),null;if("function"==typeof n.getSenders&&("function"==typeof RTCDTMFSender||"function"==typeof RTCDtmfSender)){var r=n.getSenders().find(function(e){return e.dtmf});if(r)return this._log.info("Using RTCRtpSender#dtmf"),this._dtmfSender=r.dtmf,this._dtmfSender}if("function"==typeof n.createDTMFSender&&"function"==typeof n.getLocalStreams){var i=n.getLocalStreams().map(function(e){var n=t._getAudioTracks(e);return n&&n[0]})[0];return i?(this._log.info("Creating RTCDTMFSender"),this._dtmfSender=n.createDTMFSender(i),this._dtmfSender):(this._log.info("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender"),null)}return this._log.info("RTCPeerConnection does not support RTCDTMFSender"),this._dtmfSenderUnsupported=!0,null},p.prototype.getRTCDtlsTransport=function e(){var t=this.version&&this.version.pc&&"function"==typeof this.version.pc.getSenders&&this.version.pc.getSenders()[0];return t&&t.transport||null},p.prototype._canStopMediaStreamTrack=function(){return"function"==typeof MediaStreamTrack.prototype.stop},p.prototype._getAudioTracks=function(e){return"function"==typeof e.getAudioTracks?e.getAudioTracks():e.audioTracks},p.prototype._getRTCIceTransport=function e(){var t=this.getRTCDtlsTransport();return t&&t.iceTransport||null},p.protocol=l.test()?new l:null,p.enabled=l.test(),t.exports=p},{"../errors":12,"../log":14,"../util":34,"./rtcpc":26,"./sdp":27}],26:[function(e,t,n){(function(n){(function(){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("rtcpeerconnection-shim"),o=e("../log").default,a=e("./sdp"),s=a.setCodecPreferences,c=a.setMaxAverageBitrate,u=e("../util");function l(){if("undefined"==typeof window){this.log.info("No RTCPeerConnection implementation available. The window object was not found.");return}u.isLegacyEdge()?this.RTCPeerConnection=new i("undefined"!=typeof window?window:n):"function"==typeof window.RTCPeerConnection?this.RTCPeerConnection=window.RTCPeerConnection:"function"==typeof window.webkitRTCPeerConnection?this.RTCPeerConnection=webkitRTCPeerConnection:"function"==typeof window.mozRTCPeerConnection?(this.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate):this.log.info("No RTCPeerConnection implementation available")}function d(e,t,n){return function(){var r=Array.prototype.slice.call(arguments);return new Promise(function(n){n(e.apply(t,r))}).catch(function(){return new Promise(function(i,o){e.apply(t,n?[i,o].concat(r):r.concat([i,o]))})})}}function p(e,t){return d(e,t,!0)}function f(e,t){return d(e,t,!1)}l.prototype.create=function(e,t){this.log=o.getInstance(),this.pc=new this.RTCPeerConnection(t,e)},l.prototype.createModernConstraints=function(e){if(void 0===e)return null;var t=Object.assign({},e);return"undefined"==typeof webkitRTCPeerConnection||u.isLegacyEdge()?(void 0!==e.audio&&(t.offerToReceiveAudio=e.audio),void 0!==e.video&&(t.offerToReceiveVideo=e.video)):(t.mandatory={},void 0!==e.audio&&(t.mandatory.OfferToReceiveAudio=e.audio),void 0!==e.video&&(t.mandatory.OfferToReceiveVideo=e.video)),delete t.audio,delete t.video,t},l.prototype.createOffer=function(e,t,n,r,i){var o=this;return n=this.createModernConstraints(n),p(this.pc.createOffer,this.pc)(n).then(function(n){if(!o.pc)return Promise.resolve();var r=c(n.sdp,e);return f(o.pc.setLocalDescription,o.pc)(new RTCSessionDescription({type:"offer",sdp:s(r,t)}))}).then(r,i)},l.prototype.createAnswer=function(e,t,n,r,i){var o=this;return n=this.createModernConstraints(n),p(this.pc.createAnswer,this.pc)(n).then(function(n){if(!o.pc)return Promise.resolve();var r=c(n.sdp,e);return f(o.pc.setLocalDescription,o.pc)(new RTCSessionDescription({type:"answer",sdp:s(r,t)}))}).then(r,i)},l.prototype.processSDP=function(e,t,n,r,i,o){var a=this;n=s(n,t);var c=new RTCSessionDescription({sdp:n,type:"offer"});return f(this.pc.setRemoteDescription,this.pc)(c).then(function(){a.createAnswer(e,t,r,i,o)})},l.prototype.getSDP=function(){return this.pc.localDescription.sdp},l.prototype.processAnswer=function(e,t,n,r){return this.pc?(t=s(t,e),f(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:t,type:"answer"})).then(n,r)):Promise.resolve()},l.test=function(){if(("undefined"==typeof navigator?"undefined":r(navigator))==="object"){var e=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(u.isLegacyEdge(navigator))return!1;if(e&&"function"==typeof window.RTCPeerConnection)return!0;if(e&&"function"==typeof window.webkitRTCPeerConnection)return!0;if(e&&"function"==typeof window.mozRTCPeerConnection){try{var t=new window.mozRTCPeerConnection;if("function"!=typeof t.getLocalStreams)return!1}catch(n){return!1}return!0}else if("undefined"!=typeof RTCIceGatherer)return!0}return!1},t.exports=l}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../log":14,"../util":34,"./sdp":27,"rtcpeerconnection-shim":55}],27:[function(e,t,n){"use strict";var r=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function e(t,n){var r=[],i=!0,o=!1,a=void 0;try{for(var s,c=t[Symbol.iterator]();!(i=(s=c.next()).done)&&(r.push(s.value),!n||r.length!==n);i=!0);}catch(u){o=!0,a=u}finally{try{!i&&c.return&&c.return()}finally{if(o)throw a}}return r}(e,t);throw TypeError("Invalid attempt to destructure non-iterable instance")},i=e("../util"),o={0:"PCMU",8:"PCMA"};t.exports={getPreferredCodecInfo:function e(t){var n=/a=rtpmap:(\d+) (\S+)/m.exec(t)||[null,"",""],i=r(n,3),o=i[1],a=i[2],s=RegExp("a=fmtp:"+o+" (\\S+)","m").exec(t)||[null,""],c=r(s,2)[1];return{codecName:a,codecParams:c}},setCodecPreferences:function e(t,n){var r,a,s,c;return[t.split("\r\nm=")[0]].concat((r=t,r.replace(/\r\n\r\n$/,"\r\n").split("\r\nm=").slice(1).map(function(e){return"m="+e}).filter(function(e){var t=RegExp("m=.*","gm"),n=RegExp("a=.*","gm");return t.test(e)&&n.test(e)})).map(function(e){if(!/^m=(audio|video)/.test(e))return e;var t,r,a,s,c,u,l,d,p,f,h,m,g,v,y=e.match(/^m=(audio|video)/)[1],$=(t=e,Array.from((r=t,(a=r,s=a.split("\r\n")[0].match(/([0-9]+)/g),s?s.slice(1).map(function(e){return parseInt(e,10)}):[]).reduce(function(e,t){var n=RegExp("a=rtpmap:"+t+" ([^/]+)"),i=r.match(n),a=i?i[1].toLowerCase():o[t]?o[t].toLowerCase():"";return e.set(t,a)},new Map))).reduce(function(e,t){var n=t[0],r=t[1],i=e.get(r)||[];return e.set(r,i.concat(n))},new Map)),S=(c=$,u=n,u=u.map(function(e){return e.toLowerCase()}),l=i.flatMap(u,function(e){return c.get(e)||[]}),d=i.difference(Array.from(c.keys()),u),p=i.flatMap(d,function(e){return c.get(e)}),l.concat(p)),b=(f=S,h=e,m=h.split("\r\n"),g=m[0],[g=g.replace(/([0-9]+\s?)+$/,f.join(" "))].concat(m.slice(1)).join("\r\n")),w=$.get("pcma")||[],C=$.get("pcmu")||[];return("audio"===y?new Set(w.concat(C)):new Set).has(S[0])?b.replace(/\r\nb=(AS|TIAS):([0-9]+)/g,""):b})).join("\r\n")},setIceAggressiveNomination:function e(t){return i.isChrome(window,window.navigator)?t.split("\n").filter(function(e){return -1===e.indexOf("a=ice-lite")}).join("\n"):t},setMaxAverageBitrate:function e(t,n){if("number"!=typeof n||n<6e3||n>51e4)return t;var r=/a=rtpmap:(\d+) opus/m.exec(t),i=RegExp("a=fmtp:"+(r&&r.length?r[1]:111));return t.split("\n").map(function(e){return i.test(e)?e+";maxaveragebitrate="+n:e}).join("\n")}}},{"../util":34}],28:[function(e,t,n){var r=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r},i=e("../errors"),o=i.NotSupportedError,a=i.InvalidArgumentError,s=e("./mockrtcstatsreport");function c(e){var t;if(!e)return Promise.reject(new a("PeerConnection is null"));if("function"!=typeof e.getStats)return Promise.reject(new o("WebRTC statistics are unsupported"));try{t=e.getStats()}catch(n){t=new Promise(function(t){return e.getStats(t)}).then(s.fromRTCStatsResponse)}return t}function u(){}function l(e){var t,n=null,r=new u;Array.from(e.values()).forEach(function(i){if(!i.isRemote){var o=i.type.replace("-","");if(t=t||i.timestamp,i.remoteId){var a=e.get(i.remoteId);a&&a.roundTripTime&&(r.rtt=1e3*a.roundTripTime)}switch(o){case"inboundrtp":r.timestamp=r.timestamp||i.timestamp,r.jitter=1e3*i.jitter,r.packetsLost=i.packetsLost,r.packetsReceived=i.packetsReceived,r.bytesReceived=i.bytesReceived;break;case"outboundrtp":if(r.timestamp=i.timestamp,r.packetsSent=i.packetsSent,r.bytesSent=i.bytesSent,i.codecId){var s=e.get(i.codecId);r.codecName=s?s.mimeType&&s.mimeType.match(/(.*\/)?(.*)/)[2]:i.codecId}break;case"transport":n=i.id}}}),r.timestamp||(r.timestamp=t);var i=e.get(n);if(!i)return r;var o=e.get(i.selectedCandidatePairId);if(!o)return r;var a=e.get(o.localCandidateId),s=e.get(o.remoteCandidateId);return r.rtt||(r.rtt=o&&1e3*o.currentRoundTripTime),Object.assign(r,{localAddress:a&&a.ip,remoteAddress:s&&s.ip}),r}t.exports={getRTCStats:function e(t,n){return n=Object.assign({createRTCSample:l},n),c(t).then(n.createRTCSample)},getRTCIceCandidateStatsReport:function e(t){return c(t).then(function(e){var t,n=Array.from(e.values()).reduce(function(e,t){switch(["candidatePairs","localCandidates","remoteCandidates"].forEach(function(t){e[t]||(e[t]=[])}),t.type){case"candidate-pair":e.candidatePairs.push(t);break;case"local-candidate":e.localCandidates.push(t);break;case"remote-candidate":e.remoteCandidates.push(t);break;case"transport":t.selectedCandidatePairId&&(e.transport=t)}return e},{}),i=n.candidatePairs,o=n.localCandidates,a=n.remoteCandidates,s=n.transport,c=i.find(function(e){return e.selected||s&&e.id===s.selectedCandidatePairId});return c&&(t={localCandidate:o.find(function(e){return e.id===c.localCandidateId}),remoteCandidate:a.find(function(e){return e.id===c.remoteCandidateId})}),{iceCandidateStats:r(o,a),selectedIceCandidatePairStats:t}})}}},{"../errors":12,"./mockrtcstatsreport":23}],29:[function(e,t,n){var r=e("events").EventEmitter;function i(){Object.defineProperties(this,{_eventEmitter:{value:new r},_handlers:{value:{}}})}i.prototype.dispatchEvent=function e(t){return this._eventEmitter.emit(t.type,t)},i.prototype.addEventListener=function e(){var t;return(t=this._eventEmitter).addListener.apply(t,arguments)},i.prototype.removeEventListener=function e(){var t;return(t=this._eventEmitter).removeListener.apply(t,arguments)},i.prototype._defineEventHandler=function e(t){var n=this;Object.defineProperty(this,"on"+t,{get:function(){return n._handlers[t]},set:function(e){var r=n._handlers[t];r&&("function"==typeof e||null==e)&&(n._handlers[t]=null,n.removeEventListener(t,r)),"function"==typeof e&&(n._handlers[t]=e,n.addEventListener(t,e))}})},t.exports=i},{events:47}],30:[function(e,t,n){"use strict";var r=function e(t){!function e(t,n){if(!(t instanceof n))throw TypeError("Cannot call a class as a function")}(this,e),Object.defineProperties(this,{deviceId:{get:function e(){return t.deviceId}},groupId:{get:function e(){return t.groupId}},kind:{get:function e(){return t.kind}},label:{get:function e(){return t.label}}})};t.exports=r},{}],31:[function(e,t,n){var r=e("./eventtarget"),i=e("util").inherits,o="undefined"!=typeof navigator&&navigator.mediaDevices;function a(){r.call(this),this._defineEventHandler("devicechange"),this._defineEventHandler("deviceinfochange");var e=[];Object.defineProperties(this,{_deviceChangeIsNative:{value:c(this,"devicechange")},_deviceInfoChangeIsNative:{value:c(this,"deviceinfochange")},_knownDevices:{value:e},_pollInterval:{value:null,writable:!0}}),"function"==typeof o.enumerateDevices&&o.enumerateDevices().then(function(t){t.sort(u).forEach([].push,e)}),this._eventEmitter.on("newListener",(function e(t){("devicechange"===t||"deviceinfochange"===t)&&(this._pollInterval=this._pollInterval||setInterval(s.bind(null,this),500))}).bind(this)),this._eventEmitter.on("removeListener",(function e(){var t;this._pollInterval&&(t=this,!(["devicechange","deviceinfochange"].reduce(function(e,n){return e+t._eventEmitter.listenerCount(n)},0)>0))&&(clearInterval(this._pollInterval),this._pollInterval=null)}).bind(this))}function s(e){o.enumerateDevices().then(function(t){var n,r,i,o,a,s,c,l=e._knownDevices,d=l.slice(),p="deviceId";if([].splice.apply(l,[0,l.length].concat(t.sort(u))),!e._deviceChangeIsNative&&(o=l,a=d,o.length!==a.length||(s=o,c=a,s.some(function(e,t){return e[p]!==c[t][p]}))))e.dispatchEvent(new Event("devicechange"));!e._deviceInfoChangeIsNative&&(n=l,i=(r=d).reduce(function(e,t){return e.set(t.deviceId,t.label||null)},new Map),n.some(function(e){var t=i.get(e.deviceId);return void 0!==t&&t!==e.label}))&&e.dispatchEvent(new Event("deviceinfochange"))})}function c(e,t){var n="on"+t;function r(t){e.dispatchEvent(t)}return n in o&&("addEventListener"in o?o.addEventListener(t,r):o[n]=r,!0)}function u(e,t){return e.deviceId<t.deviceId}i(a,r),o&&"function"==typeof o.enumerateDevices&&(a.prototype.enumerateDevices=function e(){return o.enumerateDevices.apply(o,arguments)}),a.prototype.getUserMedia=function e(){return o.getUserMedia.apply(o,arguments)},t.exports=o?new a:null},{"./eventtarget":29,util:59}],32:[function(e,t,n){"use strict";var r=e("./asyncQueue").AsyncQueue,i=e("@twilio/audioplayer"),o=e("./errors").InvalidArgumentError;function a(e,t,n){if(!(this instanceof a))return new a(e,t,n);if(!e||!t)throw new o("name and url are required arguments");(n=Object.assign({AudioFactory:"undefined"!=typeof Audio?Audio:null,maxDuration:0,shouldLoop:!1},n)).AudioPlayer=n.audioContext?i.bind(i,n.audioContext):n.AudioFactory,Object.defineProperties(this,{_activeEls:{value:new Map},_Audio:{value:n.AudioPlayer},_isSinkSupported:{value:null!==n.AudioFactory&&"function"==typeof n.AudioFactory.prototype.setSinkId},_maxDuration:{value:n.maxDuration},_maxDurationTimeout:{value:null,writable:!0},_operations:{value:new r},_playPromise:{value:null,writable:!0},_shouldLoop:{value:n.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:!0,get:function e(){return!!this._playPromise}},name:{enumerable:!0,value:e},url:{enumerable:!0,value:t}}),this._Audio&&this._play(!0,!1)}function s(e){e&&(e.pause(),e.src="",e.srcObject=null,e.load())}a.prototype._playAudioElement=function e(t,n,r){var i=this,a=this._activeEls.get(t);if(!a)throw new o('sinkId: "'+t+"\" doesn't have an audio element");return a.muted=!!n,a.loop=!!r,a.play().then(function(){return a}).catch(function(e){throw s(a),i._activeEls.delete(t),e})},a.prototype._play=function e(t,n){this.isPlaying&&this._stop(),this._maxDuration>0&&(this._maxDurationTimeout=setTimeout(this._stop.bind(this),this._maxDuration)),n="boolean"==typeof n?n:this._shouldLoop;var r=this;return this._playPromise=Promise.all(this._sinkIds.map(function e(i){if(!r._Audio)return Promise.resolve();var o=r._activeEls.get(i);return o?r._playAudioElement(i,t,n):("function"==typeof(o=new r._Audio(r.url)).setAttribute&&o.setAttribute("crossorigin","anonymous"),new Promise(function(e){o.addEventListener("canplaythrough",e)}).then(function(){return(r._isSinkSupported?o.setSinkId(i):Promise.resolve()).then(function e(){return(r._activeEls.set(i,o),r._playPromise)?r._playAudioElement(i,t,n):Promise.resolve()})}))}))},a.prototype._stop=function e(){var t=this;this._activeEls.forEach(function(e,n){t._sinkIds.includes(n)?(e.pause(),e.currentTime=0):(s(e),t._activeEls.delete(n))}),clearTimeout(this._maxDurationTimeout),this._playPromise=null,this._maxDurationTimeout=null},a.prototype.setSinkIds=function e(t){this._isSinkSupported&&(t=t.forEach?t:[t],[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(t)))},a.prototype.stop=function e(){var t=this;this._operations.enqueue(function(){return t._stop(),Promise.resolve()})},a.prototype.play=function e(){var t=this;return this._operations.enqueue(function(){return t._play()})},t.exports=a},{"./asyncQueue":4,"./errors":12,"@twilio/audioplayer":39}],33:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},a=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r};Object.defineProperty(n,"__esModule",{value:!0});var s=e("events"),c=e("./errors"),u=e("./util"),l=e("./rtc/stats").getRTCStats,d=e("./rtc/mos"),p={audioInputLevel:{minStandardDeviation:327.67,sampleCount:10},audioOutputLevel:{minStandardDeviation:327.67,sampleCount:10},bytesReceived:{clearCount:2,min:1,raiseCount:3,sampleCount:3},bytesSent:{clearCount:2,min:1,raiseCount:3,sampleCount:3},jitter:{max:30},mos:{min:3},packetsLostFraction:[{max:1},{clearValue:1,maxAverage:3,sampleCount:7}],rtt:{max:400}},f=function(e){function t(t){var n=e.call(this)||this;n._activeWarnings=new Map,n._currentStreaks=new Map,n._inputVolumes=[],n._outputVolumes=[],n._sampleBuffer=[],n._supplementalSampleBuffers={audioInputLevel:[],audioOutputLevel:[]},n._warningsEnabled=!0,t=t||{},n._getRTCStats=t.getRTCStats||l,n._mos=t.Mos||d,n._peerConnection=t.peerConnection,n._thresholds=o(o({},p),t.thresholds);var r=Object.values(n._thresholds).map(function(e){return e.sampleCount}).filter(function(e){return!!e});return n._maxSampleCount=Math.max.apply(Math,a([5],r)),n._peerConnection&&n.enable(n._peerConnection),n}return i(t,e),t.prototype.addVolumes=function(e,t){this._inputVolumes.push(e),this._outputVolumes.push(t)},t.prototype.disable=function(){return clearInterval(this._sampleInterval),delete this._sampleInterval,this},t.prototype.disableWarnings=function(){return this._warningsEnabled&&this._activeWarnings.clear(),this._warningsEnabled=!1,this},t.prototype.enable=function(e){if(e){if(this._peerConnection&&e!==this._peerConnection)throw new c.InvalidArgumentError("Attempted to replace an existing PeerConnection in StatsMonitor.enable");this._peerConnection=e}if(!this._peerConnection)throw new c.InvalidArgumentError("Can not enable StatsMonitor without a PeerConnection");return this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),1e3),this},t.prototype.enableWarnings=function(){return this._warningsEnabled=!0,this},t.prototype.hasActiveWarning=function(e,t){return!!this._activeWarnings.get(e+":"+t)},t.prototype._addSample=function(e){var t=this._sampleBuffer;t.push(e),t.length>this._maxSampleCount&&t.splice(0,t.length-this._maxSampleCount)},t.prototype._clearWarning=function(e,t,n){var r=e+":"+t,i=this._activeWarnings.get(r);!(!i||Date.now()-i.timeRaised<5e3)&&(this._activeWarnings.delete(r),this.emit("warning-cleared",o(o({},n),{name:e,threshold:{name:t,value:this._thresholds[e][t]}})))},t.prototype._createSample=function(e,t){var n=t&&t.totals.bytesSent||0,r=t&&t.totals.bytesReceived||0,i=t&&t.totals.packetsSent||0,o=t&&t.totals.packetsReceived||0,a=t&&t.totals.packetsLost||0,s=e.bytesSent-n,c=e.bytesReceived-r,l=e.packetsSent-i,d=e.packetsReceived-o,p=e.packetsLost-a,f=d+p,h=f>0?p/f*100:0,m=e.packetsReceived+e.packetsLost,g=m>0?e.packetsLost/m*100:100,v="number"!=typeof e.rtt&&t?t.rtt:e.rtt,y=this._inputVolumes.splice(0);this._supplementalSampleBuffers.audioInputLevel.push(y);var $=this._outputVolumes.splice(0);return this._supplementalSampleBuffers.audioOutputLevel.push($),{audioInputLevel:Math.round(u.average(y)),audioOutputLevel:Math.round(u.average($)),bytesReceived:c,bytesSent:s,codecName:e.codecName,jitter:e.jitter,mos:this._mos.calculate(v,e.jitter,t&&h),packetsLost:p,packetsLostFraction:h,packetsReceived:d,packetsSent:l,rtt:v,timestamp:e.timestamp,totals:{bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,packetsLost:e.packetsLost,packetsLostFraction:g,packetsReceived:e.packetsReceived,packetsSent:e.packetsSent}}},t.prototype._fetchSample=function(){var e=this;this._getSample().then(function(t){e._addSample(t),e._raiseWarnings(),e.emit("sample",t)}).catch(function(t){e.disable(),e.emit("error",t)})},t.prototype._getSample=function(){var e=this;return this._getRTCStats(this._peerConnection).then(function(t){var n=null;return e._sampleBuffer.length&&(n=e._sampleBuffer[e._sampleBuffer.length-1]),e._createSample(t,n)})},t.prototype._raiseWarning=function(e,t,n){var r,i=e+":"+t;if(!this._activeWarnings.has(i)){this._activeWarnings.set(i,{timeRaised:Date.now()});var a=this._thresholds[e];if(Array.isArray(a)){var s=a.find(function(e){return t in e});s&&(r=s[t])}else r=this._thresholds[e][t];this.emit("warning",o(o({},n),{name:e,threshold:{name:t,value:r}}))}},t.prototype._raiseWarnings=function(){var e=this;this._warningsEnabled&&Object.keys(this._thresholds).forEach(function(t){return e._raiseWarningsForStat(t)})},t.prototype._raiseWarningsForStat=function(e){var t=this;(Array.isArray(this._thresholds[e])?this._thresholds[e]:[this._thresholds[e]]).forEach(function(n){var r,i=t._sampleBuffer,o=n.clearCount||0,s=n.raiseCount||3,c=n.sampleCount||t._maxSampleCount,l=i.slice(-c),d=l.map(function(t){return t[e]});if(!d.some(function(e){return null==e})){if("number"==typeof n.max&&((r=(g=n.max,(v=d).reduce(function(e,t){return e+(t>g?1:0)},0)))>=s?t._raiseWarning(e,"max",{values:d,samples:l}):r<=o&&t._clearWarning(e,"max",{values:d,samples:l})),"number"==typeof n.min&&((r=(y=n.min,($=d).reduce(function(e,t){return e+(t<y?1:0)},0)))>=s?t._raiseWarning(e,"min",{values:d,samples:l}):r<=o&&t._clearWarning(e,"min",{values:d,samples:l})),"number"==typeof n.maxDuration&&i.length>1){var p=(l=i.slice(-2))[0][e],f=l[1][e],h=t._currentStreaks.get(e)||0,m=p===f?h+1:0;t._currentStreaks.set(e,m),m>=n.maxDuration?t._raiseWarning(e,"maxDuration",{value:m}):0===m&&t._clearWarning(e,"maxDuration",{value:h})}if("number"==typeof n.minStandardDeviation){var g,v,y,$,S,b=t._supplementalSampleBuffers[e];if(!b||b.length<n.sampleCount)return;b.length>n.sampleCount&&b.splice(0,b.length-n.sampleCount);var w=function e(t){if(t.length<=0)return null;var n=t.reduce(function(e,t){return e+t},0)/t.length,r=t.map(function(e){return Math.pow(e-n,2)});return Math.sqrt(r.reduce(function(e,t){return e+t},0)/r.length)}((S=b.slice(-c)).reduce(function(e,t){return a(e,t)},[]));if("number"!=typeof w)return;w<n.minStandardDeviation?t._raiseWarning(e,"minStandardDeviation",{value:w}):t._clearWarning(e,"minStandardDeviation",{value:w})}[["maxAverage",function(e,t){return e>t}],["minAverage",function(e,t){return e<t}],].forEach(function(r){var i=r[0],o=r[1];if("number"==typeof n[i]&&d.length>=c){var a=u.average(d);o(a,n[i])?t._raiseWarning(e,i,{values:d,samples:l}):o(a,n.clearValue||n[i])||t._clearWarning(e,i,{values:d,samples:l})}})}})},t}(s.EventEmitter);n.default=f},{"./errors":12,"./rtc/mos":24,"./rtc/stats":28,"./util":34,events:47}],34:[function(e,t,n){(function(e){(function(){function t(e){if(!(this instanceof t))return new t(e);this.message=e}function r(e){return!!e.userAgent.match("Electron")}function i(e,t){var n=!!t.userAgent.match("CriOS"),i=!!t.userAgent.match("HeadlessChrome"),o=void 0!==e.chrome&&"Google Inc."===t.vendor&&-1===t.userAgent.indexOf("OPR")&&-1===t.userAgent.indexOf("Edge");return n||r(t)||o||i}function o(t){return!!(t=t||("undefined"==typeof window?e.navigator:window.navigator))&&"string"==typeof t.userAgent&&/firefox|fxios/i.test(t.userAgent)}function a(e){return!!e.vendor&&-1!==e.vendor.indexOf("Apple")&&e.userAgent&&-1===e.userAgent.indexOf("CriOS")&&-1===e.userAgent.indexOf("FxiOS")}t.prototype.toString=function(){return"Twilio.Exception: "+this.message},n.Exception=t,n.average=function e(t){return t&&t.length?t.reduce(function(e,t){return e+t})/t.length:0},n.difference=function e(t,n,r){r=r||function(e){return e};var i=new Set(n.map(r));return t.filter(function(e){return!i.has(r(e))})},n.isElectron=r,n.isChrome=i,n.isFirefox=o,n.isLegacyEdge=function t(n){return!!(n=n||("undefined"==typeof window?e.navigator:window.navigator))&&"string"==typeof n.userAgent&&/edge\/\d+/i.test(n.userAgent)},n.isSafari=a,n.isUnifiedPlanDefault=function e(t,n,r,s){if(void 0===t||void 0===n||void 0===r||void 0===s||void 0===r.prototype||void 0===s.prototype)return!1;if(i(t,n)&&r.prototype.addTransceiver){var c=new r,u=!0;try{c.addTransceiver("audio")}catch(l){u=!1}return c.close(),u}return!!o(n)||!!a(n)&&"currentDirection"in s.prototype},n.queryToJson=function e(t){return t?t.split("&").reduce(function(e,t){var n=t.split("="),r=n[0],i=decodeURIComponent((n[1]||"").replace(/\+/g,"%20"));return r&&(e[r]=i),e},{}):""},n.flatMap=function e(t,n){var r=t instanceof Map||t instanceof Set?Array.from(t.values()):t;return n=n||function(e){return e},r.reduce(function(e,t){var r=n(t);return e.concat(r)},[])}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],35:[function(e,t,n){"use strict";var r,i,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(n,"__esModule",{value:!0});var a,s=e("events"),c=e("ws"),u=e("./errors"),l=e("./log"),d=e("backoff");(a=i=n.WSTransportState||(n.WSTransportState={})).Connecting="connecting",a.Closed="closed",a.Open="open";var p=function(e){function t(t,n){void 0===n&&(n={});var r=e.call(this)||this;r.state=i.Closed,r._log=l.default.getInstance(),r._shouldFallback=!1,r._uriIndex=0,r._moveUriIndex=function(){r._uriIndex++,r._uriIndex>=r._uris.length&&(r._uriIndex=0)},r._onSocketClose=function(e){if(r._log.info("Received websocket close event code: "+e.code+". Reason: "+e.reason),1006===e.code||1015===e.code){r.emit("error",{code:31005,message:e.reason||"Websocket connection to Twilio's signaling servers were unexpectedly ended. If this is happening consistently, there may be an issue resolving the hostname provided. If a region or an edge is being specified in Device setup, ensure it is valid.",twilioError:new u.SignalingErrors.ConnectionError});var t=r.state===i.Open||r._previousState===i.Open;(r._shouldFallback||!t)&&r._moveUriIndex(),r._shouldFallback=!0}r._closeSocket()},r._onSocketError=function(e){r._log.info("WebSocket received error: "+e.message),r.emit("error",{code:31e3,message:e.message||"WSTransport socket error",twilioError:new u.SignalingErrors.ConnectionDisconnected})},r._onSocketMessage=function(e){if(r._setHeartbeatTimeout(),r._socket&&"\n"===e.data){r._socket.send("\n");return}r.emit("message",e)},r._onSocketOpen=function(){r._log.info("WebSocket opened successfully."),r._timeOpened=Date.now(),r._shouldFallback=!1,r._setState(i.Open),clearTimeout(r._connectTimeout),r._setHeartbeatTimeout(),r.emit("open")},r._connectTimeoutMs=n.connectTimeoutMs||5e3;var o=100;t&&t.length>1&&(o=Math.floor(4001*Math.random())+1e3);var a={factor:2,initialDelay:o,maxDelay:"number"==typeof n.backoffMaxMs?Math.max(n.backoffMaxMs,3e3):2e4,randomisationFactor:.4};return r._log.info("Initializing transport backoff using config: ",a),r._backoff=d.exponential(a),r._uris=t,r._WebSocket=n.WebSocket||c,r._backoff.on("backoff",function(e,t){r.state!==i.Closed&&r._log.info("Will attempt to reconnect WebSocket in "+t+"ms")}),r._backoff.on("ready",function(e){r.state!==i.Closed&&r._connect(e+1)}),r}return o(t,e),t.prototype.close=function(){this._log.info("WSTransport.close() called..."),this._close()},t.prototype.open=function(){if(this._log.info("WSTransport.open() called..."),this._socket&&(this._socket.readyState===c.CONNECTING||this._socket.readyState===c.OPEN)){this._log.info("WebSocket already open.");return}this._connect()},t.prototype.send=function(e){if(!this._socket||this._socket.readyState!==c.OPEN)return!1;try{this._socket.send(e)}catch(t){return this._log.info("Error while sending message:",t.message),this._closeSocket(),!1}return!0},t.prototype._close=function(){this._setState(i.Closed),this._closeSocket()},t.prototype._closeSocket=function(){if(clearTimeout(this._connectTimeout),clearTimeout(this._heartbeatTimeout),this._log.info("Closing and cleaning up WebSocket..."),!this._socket){this._log.info("No WebSocket to clean up.");return}this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("error",this._onSocketError),this._socket.removeEventListener("message",this._onSocketMessage),this._socket.removeEventListener("open",this._onSocketOpen),(this._socket.readyState===c.CONNECTING||this._socket.readyState===c.OPEN)&&this._socket.close(),this._timeOpened&&Date.now()-this._timeOpened>1e4&&this._backoff.reset(),this._backoff.backoff(),delete this._socket,this.emit("close")},t.prototype._connect=function(e){var t=this;e?this._log.info("Attempting to reconnect (retry #"+e+")..."):this._log.info("Attempting to connect..."),this._closeSocket(),this._setState(i.Connecting);var n=null;try{n=new this._WebSocket(this._uris[this._uriIndex])}catch(r){this._log.info("Could not connect to endpoint:",r.message),this._close(),this.emit("error",{code:31e3,message:r.message||"Could not connect to "+this._uris[this._uriIndex],twilioError:new u.SignalingErrors.ConnectionDisconnected});return}delete this._timeOpened,this._connectTimeout=setTimeout(function(){t._log.info("WebSocket connection attempt timed out."),t._moveUriIndex(),t._closeSocket()},this._connectTimeoutMs),n.addEventListener("close",this._onSocketClose),n.addEventListener("error",this._onSocketError),n.addEventListener("message",this._onSocketMessage),n.addEventListener("open",this._onSocketOpen),this._socket=n},t.prototype._setHeartbeatTimeout=function(){var e=this;clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=setTimeout(function(){e._log.info("No messages received in 15 seconds. Reconnecting..."),e._shouldFallback=!0,e._closeSocket()},15e3)},t.prototype._setState=function(e){this._previousState=this.state,this.state=e},Object.defineProperty(t.prototype,"uri",{get:function(){return this._uris[this._uriIndex]},enumerable:!0,configurable:!0}),t}(s.EventEmitter);n.default=p},{"./errors":12,"./log":14,backoff:41,events:47,ws:1}],36:[function(e,t,n){"use strict";var r,i,o=(r=e("babel-runtime/regenerator"),r&&r.__esModule?r:{default:r}),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{c(r.next(e))}catch(t){o(t)}}function s(e){try{c(r.throw(e))}catch(t){o(t)}}function c(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(n,"__esModule",{value:!0});var c=e("./Deferred"),u=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!function e(t,n){if(!(t instanceof n))throw TypeError("Cannot call a class as a function")}(this,t);var i=function e(t,n){if(!t)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return n&&("object"==typeof n||"function"==typeof n)?n:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i._audioNode=null,i._pendingPlayDeferreds=[],i._loop=!1,i._src="",i._sinkId="default","string"!=typeof n&&(r=n),i._audioContext=e,i._audioElement=new(r.AudioFactory||Audio),i._bufferPromise=i._createPlayDeferred().promise,i._destination=i._audioContext.destination,i._gainNode=i._audioContext.createGain(),i._gainNode.connect(i._destination),i._XMLHttpRequest=r.XMLHttpRequestFactory||XMLHttpRequest,i.addEventListener("canplaythrough",function(){i._resolvePlayDeferreds()}),"string"==typeof n&&(i.src=n),i}return!function e(t,n){if("function"!=typeof n&&null!==n)throw TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)}(t,e),a(t,[{key:"load",value:function e(){this._load(this._src)}},{key:"pause",value:function e(){!this.paused&&(this._audioElement.pause(),this._audioNode.stop(),this._audioNode.disconnect(this._gainNode),this._audioNode=null,this._rejectPlayDeferreds(Error("The play() request was interrupted by a call to pause().")))}},{key:"play",value:function e(){return s(this,void 0,void 0,o.default.mark(function e(){var t,n=this;return o.default.wrap(function e(r){for(;;)switch(r.prev=r.next){case 0:if(this.paused){r.next=6;break}return r.next=3,this._bufferPromise;case 3:if(this.paused){r.next=5;break}return r.abrupt("return");case 5:throw Error("The play() request was interrupted by a call to pause().");case 6:return this._audioNode=this._audioContext.createBufferSource(),this._audioNode.loop=this.loop,this._audioNode.addEventListener("ended",function(){(!n._audioNode||!n._audioNode.loop)&&n.dispatchEvent("ended")}),r.next=11,this._bufferPromise;case 11:if(t=r.sent,!this.paused){r.next=14;break}throw Error("The play() request was interrupted by a call to pause().");case 14:if(this._audioNode.buffer=t,this._audioNode.connect(this._gainNode),this._audioNode.start(),!this._audioElement.srcObject){r.next=19;break}return r.abrupt("return",this._audioElement.play());case 19:case"end":return r.stop()}},e,this)}))}},{key:"setSinkId",value:function e(t){return s(this,void 0,void 0,o.default.mark(function e(){return o.default.wrap(function e(n){for(;;)switch(n.prev=n.next){case 0:if(!("function"!=typeof this._audioElement.setSinkId)){n.next=2;break}throw Error("This browser does not support setSinkId.");case 2:if(t!==this.sinkId){n.next=4;break}return n.abrupt("return");case 4:if("default"!==t){n.next=11;break}return this.paused||this._gainNode.disconnect(this._destination),this._audioElement.srcObject=null,this._destination=this._audioContext.destination,this._gainNode.connect(this._destination),this._sinkId=t,n.abrupt("return");case 11:return n.next=13,this._audioElement.setSinkId(t);case 13:if(!this._audioElement.srcObject){n.next=15;break}return n.abrupt("return");case 15:this._gainNode.disconnect(this._audioContext.destination),this._destination=this._audioContext.createMediaStreamDestination(),this._audioElement.srcObject=this._destination.stream,this._sinkId=t,this._gainNode.connect(this._destination);case 20:case"end":return n.stop()}},e,this)}))}},{key:"_createPlayDeferred",value:function e(){var t=new c.default;return this._pendingPlayDeferreds.push(t),t}},{key:"_load",value:function e(t){var n=this;this._src&&this._src!==t&&this.pause(),this._src=t,this._bufferPromise=new Promise(function(e,r){return s(n,void 0,void 0,o.default.mark(function n(){var r;return o.default.wrap(function n(i){for(;;)switch(i.prev=i.next){case 0:if(t){i.next=2;break}return i.abrupt("return",this._createPlayDeferred().promise);case 2:return i.next=4,l(this._audioContext,this._XMLHttpRequest,t);case 4:r=i.sent,this.dispatchEvent("canplaythrough"),e(r);case 7:case"end":return i.stop()}},n,this)}))})}},{key:"_rejectPlayDeferreds",value:function e(t){var n=this._pendingPlayDeferreds;n.splice(0,n.length).forEach(function(e){return(0,e.reject)(t)})}},{key:"_resolvePlayDeferreds",value:function e(t){var n=this._pendingPlayDeferreds;n.splice(0,n.length).forEach(function(e){return(0,e.resolve)(t)})}},{key:"destination",get:function e(){return this._destination}},{key:"loop",get:function e(){return this._loop},set:function e(t){if(!t&&this.loop&&!this.paused){var n=function e(){r._audioNode.removeEventListener("ended",e),r.pause()},r=this;this._audioNode.addEventListener("ended",n)}this._loop=t}},{key:"muted",get:function e(){return 0===this._gainNode.gain.value},set:function e(t){this._gainNode.gain.value=t?0:1}},{key:"paused",get:function e(){return null===this._audioNode}},{key:"src",get:function e(){return this._src},set:function e(t){this._load(t)}},{key:"srcObject",get:function e(){return this._audioElement.srcObject},set:function e(t){this._audioElement.srcObject=t}},{key:"sinkId",get:function e(){return this._sinkId}}]),t}(e("./EventTarget").default);function l(e,t,n){return s(this,void 0,void 0,o.default.mark(function r(){var i,a;return o.default.wrap(function r(o){for(;;)switch(o.prev=o.next){case 0:return(i=new t).open("GET",n,!0),i.responseType="arraybuffer",o.next=5,new Promise(function(e){i.addEventListener("load",e),i.send()});case 5:return a=o.sent,o.prev=6,o.abrupt("return",e.decodeAudioData(a.target.response));case 10:return o.prev=10,o.t0=o.catch(6),o.abrupt("return",new Promise(function(t){e.decodeAudioData(a.target.response,t)}));case 13:case"end":return o.stop()}},r,this,[[6,10]])}))}n.default=u},{"./Deferred":37,"./EventTarget":38,"babel-runtime/regenerator":40}],37:[function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(){var t=this;!function e(t,n){if(!(t instanceof n))throw TypeError("Cannot call a class as a function")}(this,e),this.promise=new Promise(function(e,n){t._resolve=e,t._reject=n})}return r(e,[{key:"reject",get:function e(){return this._reject}},{key:"resolve",get:function e(){return this._resolve}}]),e}();n.default=i},{}],38:[function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0});var i=e("events"),o=function(){function e(){!function e(t,n){if(!(t instanceof n))throw TypeError("Cannot call a class as a function")}(this,e),this._eventEmitter=new i.EventEmitter}return r(e,[{key:"addEventListener",value:function e(t,n){return this._eventEmitter.addListener(t,n)}},{key:"dispatchEvent",value:function e(t){for(var n,r=arguments.length,i=Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return(n=this._eventEmitter).emit.apply(n,[t].concat(i))}},{key:"removeEventListener",value:function e(t,n){return this._eventEmitter.removeListener(t,n)}}]),e}();n.default=o},{events:47}],39:[function(e,t,n){"use strict";var r=e("./AudioPlayer");t.exports=r.default},{"./AudioPlayer":36}],40:[function(e,t,n){t.exports=e("regenerator-runtime")},{"regenerator-runtime":53}],41:[function(e,t,n){var r=e("./lib/backoff"),i=e("./lib/strategy/exponential"),o=e("./lib/strategy/fibonacci"),a=e("./lib/function_call.js");t.exports.Backoff=r,t.exports.FunctionCall=a,t.exports.FibonacciStrategy=o,t.exports.ExponentialStrategy=i,t.exports.fibonacci=function(e){return new r(new o(e))},t.exports.exponential=function(e){return new r(new i(e))},t.exports.call=function(e,t,n){var r=Array.prototype.slice.call(arguments);return e=r[0],t=r.slice(1,r.length-1),n=r[r.length-1],new a(e,t,n)}},{"./lib/backoff":42,"./lib/function_call.js":43,"./lib/strategy/exponential":44,"./lib/strategy/fibonacci":45}],42:[function(e,t,n){var r=e("events"),i=e("precond"),o=e("util");function a(e){r.EventEmitter.call(this),this.backoffStrategy_=e,this.maxNumberOfRetry_=-1,this.backoffNumber_=0,this.backoffDelay_=0,this.timeoutID_=-1,this.handlers={backoff:this.onBackoff_.bind(this)}}o.inherits(a,r.EventEmitter),a.prototype.failAfter=function(e){i.checkArgument(e>0,"Expected a maximum number of retry greater than 0 but got %s.",e),this.maxNumberOfRetry_=e},a.prototype.backoff=function(e){i.checkState(-1===this.timeoutID_,"Backoff in progress."),this.backoffNumber_===this.maxNumberOfRetry_?(this.emit("fail",e),this.reset()):(this.backoffDelay_=this.backoffStrategy_.next(),this.timeoutID_=setTimeout(this.handlers.backoff,this.backoffDelay_),this.emit("backoff",this.backoffNumber_,this.backoffDelay_,e))},a.prototype.onBackoff_=function(){this.timeoutID_=-1,this.emit("ready",this.backoffNumber_,this.backoffDelay_),this.backoffNumber_++},a.prototype.reset=function(){this.backoffNumber_=0,this.backoffStrategy_.reset(),clearTimeout(this.timeoutID_),this.timeoutID_=-1},t.exports=a},{events:47,precond:49,util:59}],43:[function(e,t,n){var r=e("events"),i=e("precond"),o=e("util"),a=e("./backoff"),s=e("./strategy/fibonacci");function c(e,t,n){r.EventEmitter.call(this),i.checkIsFunction(e,"Expected fn to be a function."),i.checkIsArray(t,"Expected args to be an array."),i.checkIsFunction(n,"Expected callback to be a function."),this.function_=e,this.arguments_=t,this.callback_=n,this.lastResult_=[],this.numRetries_=0,this.backoff_=null,this.strategy_=null,this.failAfter_=-1,this.retryPredicate_=c.DEFAULT_RETRY_PREDICATE_,this.state_=c.State_.PENDING}o.inherits(c,r.EventEmitter),c.State_={PENDING:0,RUNNING:1,COMPLETED:2,ABORTED:3},c.DEFAULT_RETRY_PREDICATE_=function(e){return!0},c.prototype.isPending=function(){return this.state_==c.State_.PENDING},c.prototype.isRunning=function(){return this.state_==c.State_.RUNNING},c.prototype.isCompleted=function(){return this.state_==c.State_.COMPLETED},c.prototype.isAborted=function(){return this.state_==c.State_.ABORTED},c.prototype.setStrategy=function(e){return i.checkState(this.isPending(),"FunctionCall in progress."),this.strategy_=e,this},c.prototype.retryIf=function(e){return i.checkState(this.isPending(),"FunctionCall in progress."),this.retryPredicate_=e,this},c.prototype.getLastResult=function(){return this.lastResult_.concat()},c.prototype.getNumRetries=function(){return this.numRetries_},c.prototype.failAfter=function(e){return i.checkState(this.isPending(),"FunctionCall in progress."),this.failAfter_=e,this},c.prototype.abort=function(){!(this.isCompleted()||this.isAborted())&&(this.isRunning()&&this.backoff_.reset(),this.state_=c.State_.ABORTED,this.lastResult_=[Error("Backoff aborted.")],this.emit("abort"),this.doCallback_())},c.prototype.start=function(e){i.checkState(!this.isAborted(),"FunctionCall is aborted."),i.checkState(this.isPending(),"FunctionCall already started.");var t=this.strategy_||new s;this.backoff_=e?e(t):new a(t),this.backoff_.on("ready",this.doCall_.bind(this,!0)),this.backoff_.on("fail",this.doCallback_.bind(this)),this.backoff_.on("backoff",this.handleBackoff_.bind(this)),this.failAfter_>0&&this.backoff_.failAfter(this.failAfter_),this.state_=c.State_.RUNNING,this.doCall_(!1)},c.prototype.doCall_=function(e){e&&this.numRetries_++;var t=["call"].concat(this.arguments_);r.EventEmitter.prototype.emit.apply(this,t);var n=this.handleFunctionCallback_.bind(this);this.function_.apply(null,this.arguments_.concat(n))},c.prototype.doCallback_=function(){this.callback_.apply(null,this.lastResult_)},c.prototype.handleFunctionCallback_=function(){if(!this.isAborted()){var e=Array.prototype.slice.call(arguments);this.lastResult_=e,r.EventEmitter.prototype.emit.apply(this,["callback"].concat(e));var t=e[0];t&&this.retryPredicate_(t)?this.backoff_.backoff(t):(this.state_=c.State_.COMPLETED,this.doCallback_())}},c.prototype.handleBackoff_=function(e,t,n){this.emit("backoff",e,t,n)},t.exports=c},{"./backoff":42,"./strategy/fibonacci":45,events:47,precond:49,util:59}],44:[function(e,t,n){var r=e("util"),i=e("precond"),o=e("./strategy");function a(e){o.call(this,e),this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay(),this.factor_=a.DEFAULT_FACTOR,e&&void 0!==e.factor&&(i.checkArgument(e.factor>1,"Exponential factor should be greater than 1 but got %s.",e.factor),this.factor_=e.factor)}r.inherits(a,o),a.DEFAULT_FACTOR=2,a.prototype.next_=function(){return this.backoffDelay_=Math.min(this.nextBackoffDelay_,this.getMaxDelay()),this.nextBackoffDelay_=this.backoffDelay_*this.factor_,this.backoffDelay_},a.prototype.reset_=function(){this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay()},t.exports=a},{"./strategy":46,precond:49,util:59}],45:[function(e,t,n){var r=e("util"),i=e("./strategy");function o(e){i.call(this,e),this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay()}r.inherits(o,i),o.prototype.next_=function(){var e=Math.min(this.nextBackoffDelay_,this.getMaxDelay());return this.nextBackoffDelay_+=this.backoffDelay_,this.backoffDelay_=e,e},o.prototype.reset_=function(){this.nextBackoffDelay_=this.getInitialDelay(),this.backoffDelay_=0},t.exports=o},{"./strategy":46,util:59}],46:[function(e,t,n){function r(e){return null!=e}function i(e){if(r((e=e||{}).initialDelay)&&e.initialDelay<1)throw Error("The initial timeout must be greater than 0.");if(r(e.maxDelay)&&e.maxDelay<1)throw Error("The maximal timeout must be greater than 0.");if(this.initialDelay_=e.initialDelay||100,this.maxDelay_=e.maxDelay||1e4,this.maxDelay_<=this.initialDelay_)throw Error("The maximal backoff delay must be greater than the initial backoff delay.");if(r(e.randomisationFactor)&&(e.randomisationFactor<0||e.randomisationFactor>1))throw Error("The randomisation factor must be between 0 and 1.");this.randomisationFactor_=e.randomisationFactor||0}e("events"),e("util"),i.prototype.getMaxDelay=function(){return this.maxDelay_},i.prototype.getInitialDelay=function(){return this.initialDelay_},i.prototype.next=function(){var e,t=this.next_();return Math.round(t*(1+Math.random()*this.randomisationFactor_))},i.prototype.next_=function(){throw Error("BackoffStrategy.next_() unimplemented.")},i.prototype.reset=function(){this.reset_()},i.prototype.reset_=function(){throw Error("BackoffStrategy.reset_() unimplemented.")},t.exports=i},{events:47,util:59}],47:[function(e,t,n){var r,i=Object.create||function e(t){var n=function(){};return n.prototype=t,new n},o=Object.keys||function e(t){var n=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(r);return r},a=Function.prototype.bind||function e(t){var n=this;return function(){return n.apply(t,arguments)}};function s(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=i(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0;var c=10;try{var u={};Object.defineProperty&&Object.defineProperty(u,"x",{value:0}),r=0===u.x}catch(l){r=!1}function d(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function p(e,t,n,r){if("function"!=typeof n)throw TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),s=a[t]):(a=e._events=i(null),e._eventsCount=0),s){if("function"==typeof s?s=a[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),!s.warned&&(o=d(e))&&o>0&&s.length>o){s.warned=!0;var o,a,s,c=Error("Possible EventEmitter memory leak detected. "+s.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",c.name,c.message)}}else s=a[t]=n,++e._eventsCount;return e}function f(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=a.call(f,r);return i.listener=n,r.wrapFn=i,i}function m(e,t,n){var r=e._events;if(!r)return[];var i=r[t];return i?"function"==typeof i?n?[i.listener||i]:[i]:n?function e(t){for(var n=Array(t.length),r=0;r<n.length;++r)n[r]=t[r].listener||t[r];return n}(i):v(i,i.length):[]}function g(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function v(e,t){for(var n=Array(t),r=0;r<t;++r)n[r]=e[r];return n}r?Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||e!=e)throw TypeError('"defaultMaxListeners" must be a positive number');c=e}}):s.defaultMaxListeners=c,s.prototype.setMaxListeners=function e(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},s.prototype.getMaxListeners=function e(){return d(this)},s.prototype.emit=function e(t){var n,r,i,o,a,s,c="error"===t;if(s=this._events)c=c&&null==s.error;else if(!c)return!1;if(c){if(arguments.length>1&&(n=arguments[1]),n instanceof Error)throw n;var u=Error('Unhandled "error" event. ('+n+")");throw u.context=n,u}if(!(r=s[t]))return!1;var l="function"==typeof r;switch(i=arguments.length){case 1:!function e(t,n,r){if(n)t.call(r);else for(var i=t.length,o=v(t,i),a=0;a<i;++a)o[a].call(r)}(r,l,this);break;case 2:!function e(t,n,r,i){if(n)t.call(r,i);else for(var o=t.length,a=v(t,o),s=0;s<o;++s)a[s].call(r,i)}(r,l,this,arguments[1]);break;case 3:!function e(t,n,r,i,o){if(n)t.call(r,i,o);else for(var a=t.length,s=v(t,a),c=0;c<a;++c)s[c].call(r,i,o)}(r,l,this,arguments[1],arguments[2]);break;case 4:!function e(t,n,r,i,o,a){if(n)t.call(r,i,o,a);else for(var s=t.length,c=v(t,s),u=0;u<s;++u)c[u].call(r,i,o,a)}(r,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(a=1,o=Array(i-1);a<i;a++)o[a-1]=arguments[a];!function e(t,n,r,i){if(n)t.apply(r,i);else for(var o=t.length,a=v(t,o),s=0;s<o;++s)a[s].apply(r,i)}(r,l,this,o)}return!0},s.prototype.addListener=function e(t,n){return p(this,t,n,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function e(t,n){return p(this,t,n,!0)},s.prototype.once=function e(t,n){if("function"!=typeof n)throw TypeError('"listener" argument must be a function');return this.on(t,h(this,t,n)),this},s.prototype.prependOnceListener=function e(t,n){if("function"!=typeof n)throw TypeError('"listener" argument must be a function');return this.prependListener(t,h(this,t,n)),this},s.prototype.removeListener=function e(t,n){var r,o,a,s,c;if("function"!=typeof n)throw TypeError('"listener" argument must be a function');if(!(o=this._events)||!(r=o[t]))return this;if(r===n||r.listener===n)0==--this._eventsCount?this._events=i(null):(delete o[t],o.removeListener&&this.emit("removeListener",t,r.listener||n));else if("function"!=typeof r){for(a=-1,s=r.length-1;s>=0;s--)if(r[s]===n||r[s].listener===n){c=r[s].listener,a=s;break}if(a<0)return this;0===a?r.shift():function e(t,n){for(var r=n,i=r+1,o=t.length;i<o;r+=1,i+=1)t[r]=t[i];t.pop()}(r,a),1===r.length&&(o[t]=r[0]),o.removeListener&&this.emit("removeListener",t,c||n)}return this},s.prototype.removeAllListeners=function e(t){var n,r,a;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=i(null),this._eventsCount=0):r[t]&&(0==--this._eventsCount?this._events=i(null):delete r[t]),this;if(0===arguments.length){var s,c=o(r);for(a=0;a<c.length;++a)"removeListener"!==(s=c[a])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=i(null),this._eventsCount=0,this}if("function"==typeof(n=r[t]))this.removeListener(t,n);else if(n)for(a=n.length-1;a>=0;a--)this.removeListener(t,n[a]);return this},s.prototype.listeners=function e(t){return m(this,t,!0)},s.prototype.rawListeners=function e(t){return m(this,t,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},s.prototype.listenerCount=g,s.prototype.eventNames=function e(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],48:[function(e,t,n){var r,i;r=this,i=function(){"use strict";var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(r){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(t,n){for(var i=0;i<r.length;i++){var o=r[i];this[o]=i<t?e:this.methodFactory(o,t,n)}this.log=this.debug}function s(e,n,r){return function(){typeof console!==t&&(a.call(this,n,r),this[e].apply(this,arguments))}}function c(r,a,c){var u;return u=r,"debug"===u&&(u="log"),typeof console!==t&&("trace"===u&&n?o:void 0!==console[u]?i(console,u):void 0!==console.log?i(console,"log"):e)||s.apply(this,arguments)}function u(e,n,i){var o,s=this,u="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[u]}catch(n){}if(typeof e===t)try{var r=window.document.cookie,i=r.indexOf(encodeURIComponent(u)+"=");-1!==i&&(e=/^([^;]+)/.exec(r.slice(i))[1])}catch(o){}return void 0===s.levels[e]&&(e=void 0),e}}e&&(u+=":"+e),s.name=e,s.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},s.methodFactory=i||c,s.getLevel=function(){return o},s.setLevel=function(n,i){if("string"==typeof n&&void 0!==s.levels[n.toUpperCase()]&&(n=s.levels[n.toUpperCase()]),"number"==typeof n&&n>=0&&n<=s.levels.SILENT){if(o=n,!1!==i&&function e(n){var i=(r[n]||"silent").toUpperCase();if(typeof window!==t){try{window.localStorage[u]=i;return}catch(o){}try{window.document.cookie=encodeURIComponent(u)+"="+i+";"}catch(a){}}}(n),a.call(s,n,e),typeof console===t&&n<s.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+n},s.setDefaultLevel=function(e){l()||s.setLevel(e,!1)},s.enableAll=function(e){s.setLevel(s.levels.TRACE,e)},s.disableAll=function(e){s.setLevel(s.levels.SILENT,e)};var d=l();null==d&&(d=null==n?"WARN":n),s.setLevel(d,!1)}var l=new u,d={};l.getLogger=function e(t){if("string"!=typeof t||""===t)throw TypeError("You must supply a name when creating a logger.");var n=d[t];return n||(n=d[t]=new u(t,l.getLevel(),l.methodFactory)),n};var p=typeof window!==t?window.log:void 0;return l.noConflict=function(){return typeof window!==t&&window.log===l&&(window.log=p),l},l.getLoggers=function e(){return d},l},"function"==typeof define&&define.amd?define(i):"object"==typeof t&&t.exports?t.exports=i():r.log=i()},{}],49:[function(e,t,n){t.exports=e("./lib/checks")},{"./lib/checks":50}],50:[function(e,t,n){var r=e("util"),i=t.exports=e("./errors");function o(e,t,n,i){n=n||"";var o=r.format.apply(this,[n].concat(i)),a=new e(o);throw Error.captureStackTrace(a,t),a}function a(e,t,n){o(i.IllegalArgumentError,e,t,n)}function s(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array"}return t}function c(e){return function(t,n){var r=s(t);if(r==e)return t;a(arguments.callee,n||'Expected "'+e+'" but got "'+r+'".',Array.prototype.slice.call(arguments,2))}}t.exports.checkArgument=function(e,t){e||a(arguments.callee,t,Array.prototype.slice.call(arguments,2))},t.exports.checkState=function(e,t){if(!e){var n,r,a;n=arguments.callee,r=t,a=Array.prototype.slice.call(arguments,2),o(i.IllegalStateError,n,r,a)}},t.exports.checkIsDef=function(e,t){if(void 0!==e)return e;a(arguments.callee,t||"Expected value to be defined but was undefined.",Array.prototype.slice.call(arguments,2))},t.exports.checkIsDefAndNotNull=function(e,t){if(null!=e)return e;a(arguments.callee,t||'Expected value to be defined and not null but got "'+s(e)+'".',Array.prototype.slice.call(arguments,2))},t.exports.checkIsString=c("string"),t.exports.checkIsArray=c("array"),t.exports.checkIsNumber=c("number"),t.exports.checkIsBoolean=c("boolean"),t.exports.checkIsFunction=c("function"),t.exports.checkIsObject=c("object")},{"./errors":51,util:59}],51:[function(e,t,n){var r=e("util");function i(e){Error.call(this,e),this.message=e}function o(e){Error.call(this,e),this.message=e}r.inherits(i,Error),i.prototype.name="IllegalArgumentError",r.inherits(o,Error),o.prototype.name="IllegalStateError",t.exports.IllegalStateError=o,t.exports.IllegalArgumentError=i},{util:59}],52:[function(e,t,n){var r,i,o,a=t.exports={};function s(){throw Error("setTimeout has not been defined")}function c(){throw Error("clearTimeout has not been defined")}function u(e){if(r===setTimeout)return setTimeout(e,0);if((r===s||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(n){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:s}catch(e){r=s}try{i="function"==typeof clearTimeout?clearTimeout:c}catch(t){i=c}}();var l=[],d=!1,p=-1;function f(){d&&o&&(d=!1,o.length?l=o.concat(l):p=-1,l.length&&h())}function h(){if(!d){var e=u(f);d=!0;for(var t=l.length;t;){for(o=l,l=[];++p<t;)o&&o[p].run();p=-1,t=l.length}o=null,d=!1,function e(t){if(i===clearTimeout)return clearTimeout(t);if((i===c||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{return i(t)}catch(n){try{return i.call(null,t)}catch(r){return i.call(this,t)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function g(){}a.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new m(e,t)),1!==l.length||d||u(h)},m.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=g,a.addListener=g,a.once=g,a.off=g,a.removeListener=g,a.removeAllListeners=g,a.emit=g,a.prependListener=g,a.prependOnceListener=g,a.listeners=function(e){return[]},a.binding=function(e){throw Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw Error("process.chdir is not supported")},a.umask=function(){return 0}},{}],53:[function(e,t,n){var r=function(){return this}()||Function("return this")(),i=r.regeneratorRuntime&&Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime")>=0,o=i&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,t.exports=e("./runtime"),i)r.regeneratorRuntime=o;else try{delete r.regeneratorRuntime}catch(a){r.regeneratorRuntime=void 0}},{"./runtime":54}],54:[function(e,t,n){!function(e){"use strict";var n,r=Object.prototype,i=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag",u="object"==typeof t,l=e.regeneratorRuntime;if(l){u&&(t.exports=l);return}function d(e,t,n,r){var i,o,a,s,c=Object.create((t&&t.prototype instanceof v?t:v).prototype),u=new T(r||[]);return c._invoke=(i=e,o=n,a=u,s=f,function e(t,n){if(s===h)throw Error("Generator is already running");if(s===m){if("throw"===t)throw n;return D()}for(a.method=t,a.arg=n;;){var r=a.delegate;if(r){var c=_(r,a);if(c){if(c===g)continue;return c}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if(s===f)throw s=m,a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);s=h;var u=p(i,o,a);if("normal"===u.type){if(s=a.done?m:"suspendedYield",u.arg===g)continue;return{value:u.arg,done:a.done}}"throw"===u.type&&(s=m,a.method="throw",a.arg=u.arg)}}),c}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(r){return{type:"throw",arg:r}}}(l=e.regeneratorRuntime=u?t.exports:{}).wrap=d;var f="suspendedStart",h="executing",m="completed",g={};function v(){}function y(){}function $(){}var S={};S[a]=function(){return this};var b=Object.getPrototypeOf,w=b&&b(b(P([])));w&&w!==r&&i.call(w,a)&&(S=w);var C=$.prototype=v.prototype=Object.create(S);function k(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function E(e){var t;this._invoke=function n(r,o){function a(){return new Promise(function(t,n){!function t(n,r,o,a){var s=p(e[n],e,r);if("throw"===s.type)a(s.arg);else{var c=s.arg,u=c.value;return u&&"object"==typeof u&&i.call(u,"__await")?Promise.resolve(u.__await).then(function(e){t("next",e,o,a)},function(e){t("throw",e,o,a)}):Promise.resolve(u).then(function(e){c.value=e,o(c)},a)}}(r,o,t,n)})}return t=t?t.then(a,a):a()}}function _(e,t){var r=e.iterator[t.method];if(r===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=n,_(e,t),"throw"===t.method))return g;t.method="throw",t.arg=TypeError("The iterator does not provide a 'throw' method")}return g}var i=p(r,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,g;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=n),t.delegate=null,g):o:(t.method="throw",t.arg=TypeError("iterator result is not an object"),t.delegate=null,g)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function P(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=n,t.done=!0,t};return o.next=o}}return{next:D}}function D(){return{value:n,done:!0}}y.prototype=C.constructor=$,$.constructor=y,$[c]=y.displayName="GeneratorFunction",l.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},l.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,$):(e.__proto__=$,c in e||(e[c]="GeneratorFunction")),e.prototype=Object.create(C),e},l.awrap=function(e){return{__await:e}},k(E.prototype),E.prototype[s]=function(){return this},l.AsyncIterator=E,l.async=function(e,t,n,r){var i=new E(d(e,t,n,r));return l.isGeneratorFunction(t)?i:i.next().then(function(e){return e.done?e.value:i.next()})},k(C),C[c]="Generator",C[a]=function(){return this},C.toString=function(){return"[object Generator]"},l.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},l.values=P,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(I),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,i){return s.type="throw",s.arg=e,t.next=r,i&&(t.method="next",t.arg=n),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var c=i.call(a,"catchLoc"),u=i.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else if(u){if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else throw Error("try statement without catch or finally")}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return(a.type=e,a.arg=t,o)?(this.method="next",this.next=o.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),I(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;I(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:P(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=n),g}}}(function(){return this}()||Function("return this")())},{}],55:[function(e,t,n){"use strict";var r=e("sdp");function i(e,t,n,i,o){var a=r.writeRtpDescription(e.kind,t);if(a+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":o||"active"),a+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;var c="msid:"+(i?i.id:"-")+" "+s+"\r\n";a+="a="+c,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),a}function o(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},i=function(e,t,n,i){var o=r(e.parameters.apt,n),a=r(t.parameters.apt,i);return o&&a&&o.name.toLowerCase()===a.name.toLowerCase()};return e.codecs.forEach(function(r){for(var o=0;o<t.codecs.length;o++){var a=t.codecs[o];if(r.name.toLowerCase()===a.name.toLowerCase()&&r.clockRate===a.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&a.parameters.apt&&!i(r,a,e.codecs,t.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(r.numChannels,a.numChannels),n.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var r=0;r<t.headerExtensions.length;r++){var i=t.headerExtensions[r];if(e.uri===i.uri){n.headerExtensions.push(i);break}}}),n}function a(e,t,n){return -1!==({offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}})[t][e].indexOf(n)}function s(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function c(e,t){var n=Error(t);return n.name=e,n}t.exports=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,n,r,i){var o=new Event("track");o.track=n,o.receiver=r,o.transceiver={receiver:r},o.streams=i,e.setTimeout(function(){t._dispatchEvent("track",o)})}var l=function(n){var i,o,a,s=this,u=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){s[e]=u[e].bind(u)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.localDescription=null,this.remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=(i=n.iceServers||[],o=t,a=!1,(i=JSON.parse(JSON.stringify(i))).filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof t;return n&&(t=[t]),t=t.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||a?0===e.indexOf("stun:")&&o>=14393&&-1===e.indexOf("?transport=udp"):(a=!0,!0)}),delete e.url,e.urls=n?t[0]:t,!!t.length}})),this._iceGatherers=[],n.iceCandidatePoolSize)for(var l=n.iceCandidatePoolSize;l>0;l--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=r.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){!this._isClosed&&(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e){var t=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&t)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();n.iceTransport=r.iceTransport,n.dtlsTransport=r.dtlsTransport}return this.transceivers.push(n),n},l.prototype.addTrack=function(t,n){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");if(this.transceivers.find(function(e){return e.track===t}))throw c("InvalidAccessError","Track already exists.");for(var r,i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},l.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var r=e.clone();e.getTracks().forEach(function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),r.getTracks().forEach(function(e){n.addTrack(e,r)})}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===t});if(!n)throw c("InvalidAccessError","Sender was not created by this connection.");var r=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(r)&&this.localStreams.indexOf(r)>-1&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});n&&t.removeTrack(n)})},l.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},l.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},l.prototype._createIceGatherer=function(t,n){var r=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},l.prototype._gather=function(t,n){var i=this,o=this.transceivers[n].iceGatherer;if(!o.onlocalcandidate){var a=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,o.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),o.onlocalcandidate=function(e){if(!i.usingBundle||!(n>0)){var a=new Event("icecandidate");a.candidate={sdpMid:t,sdpMLineIndex:n};var s=e.candidate,c=!s||0===Object.keys(s).length;if(c)("new"===o.state||"gathering"===o.state)&&(o.state="completed");else{"new"===o.state&&(o.state="gathering"),s.component=1;var u=r.writeCandidate(s);a.candidate=Object.assign(a.candidate,r.parseCandidate(u)),a.candidate.candidate=u}var l=r.getMediaSections(i.localDescription.sdp);c?l[a.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n":l[a.candidate.sdpMLineIndex]+="a="+a.candidate.candidate+"\r\n",i.localDescription.sdp=r.getDescription(i.localDescription.sdp)+l.join("");var d=i.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),c||i._dispatchEvent("icecandidate",a),d&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout(function(){a.forEach(function(e){o.onlocalcandidate(e)})},0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateConnectionState()};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:r}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,n,i){var a=o(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(a.encodings=e.sendEncodingParameters,a.rtcp={cname:r.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(a)),i&&e.rtpReceiver&&a.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?a.encodings=e.recvEncodingParameters:a.encodings=[{}],a.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(a.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(a))},l.prototype.setLocalDescription=function(e){var t,n,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!a("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)n=(t=r.splitSections(e.sdp)).shift(),t.forEach(function(e,t){var n=r.parseRtpParameters(e);i.transceivers[t].localCapabilities=n}),i.transceivers.forEach(function(e,t){i._gather(e.mid,t)});else if("answer"===e.type){n=(t=r.splitSections(i.remoteDescription.sdp)).shift();var s=r.matchPrefix(n,"a=ice-lite").length>0;t.forEach(function(e,t){var a=i.transceivers[t],c=a.iceGatherer,u=a.iceTransport,l=a.dtlsTransport,d=a.localCapabilities,p=a.remoteCapabilities;if(!(r.isRejected(e)&&0===r.matchPrefix(e,"a=bundle-only").length)&&!a.isDatachannel){var f=r.getIceParameters(e,n),h=r.getDtlsParameters(e,n);s&&(h.role="server"),i.usingBundle&&0!==t||(i._gather(a.mid,t),"new"===u.state&&u.start(c,f,s?"controlling":"controlled"),"new"===l.state&&l.start(h));var m=o(d,p);i._transceive(a,m.codecs.length>0,!1)}})}return i.localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(i){var o=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!a("setRemoteDescription",i.type,o.signalingState)||o._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+o.signalingState));var l={};o.remoteStreams.forEach(function(e){l[e.id]=e});var d=[],p=r.splitSections(i.sdp),f=p.shift(),h=r.matchPrefix(f,"a=ice-lite").length>0,m=r.matchPrefix(f,"a=group:BUNDLE ").length>0;o.usingBundle=m;var g=r.matchPrefix(f,"a=ice-options:")[0];return g?o.canTrickleIceCandidates=g.substr(14).split(" ").indexOf("trickle")>=0:o.canTrickleIceCandidates=!1,p.forEach(function(a,c){var u=r.splitLines(a),p=r.getKind(a),g=r.isRejected(a)&&0===r.matchPrefix(a,"a=bundle-only").length,v=u[0].substr(2).split(" ")[2],y=r.getDirection(a,f),$=r.parseMsid(a),S=r.getMid(a)||r.generateIdentifier();if("application"===p&&"DTLS/SCTP"===v){o.transceivers[c]={mid:S,isDatachannel:!0};return}var b=r.parseRtpParameters(a);g||(L=r.getIceParameters(a,f),(O=r.getDtlsParameters(a,f)).role="client"),D=r.parseRtpEncodingParameters(a);var w=r.parseRtcpParameters(a),C=r.matchPrefix(a,"a=end-of-candidates",f).length>0,k=r.matchPrefix(a,"a=candidate:").map(function(e){return r.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===i.type||"answer"===i.type)&&!g&&m&&c>0&&o.transceivers[c]&&(o._disposeIceAndDtlsTransports(c),o.transceivers[c].iceGatherer=o.transceivers[0].iceGatherer,o.transceivers[c].iceTransport=o.transceivers[0].iceTransport,o.transceivers[c].dtlsTransport=o.transceivers[0].dtlsTransport,o.transceivers[c].rtpSender&&o.transceivers[c].rtpSender.setTransport(o.transceivers[0].dtlsTransport),o.transceivers[c].rtpReceiver&&o.transceivers[c].rtpReceiver.setTransport(o.transceivers[0].dtlsTransport)),"offer"!==i.type||g)"answer"!==i.type||g||(_=(E=o.transceivers[c]).iceGatherer,x=E.iceTransport,I=E.dtlsTransport,T=E.rtpReceiver,P=E.sendEncodingParameters,R=E.localCapabilities,o.transceivers[c].recvEncodingParameters=D,o.transceivers[c].remoteCapabilities=b,o.transceivers[c].rtcpParameters=w,k.length&&"new"===x.state&&((h||C)&&(!m||0===c)?x.setRemoteCandidates(k):k.forEach(function(e){s(E.iceTransport,e)})),m&&0!==c||("new"===x.state&&x.start(_,L,"controlling"),"new"===I.state&&I.start(O)),o._transceive(E,"sendrecv"===y||"recvonly"===y,"sendrecv"===y||"sendonly"===y),T&&("sendrecv"===y||"sendonly"===y)?(A=T.track,$?(l[$.stream]||(l[$.stream]=new e.MediaStream),n(A,l[$.stream]),d.push([A,T,l[$.stream]])):(l.default||(l.default=new e.MediaStream),n(A,l.default),d.push([A,T,l.default]))):delete E.rtpReceiver);else{(E=o.transceivers[c]||o._createTransceiver(p)).mid=S,E.iceGatherer||(E.iceGatherer=o._createIceGatherer(c,m)),k.length&&"new"===E.iceTransport.state&&(C&&(!m||0===c)?E.iceTransport.setRemoteCandidates(k):k.forEach(function(e){s(E.iceTransport,e)})),R=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(R.codecs=R.codecs.filter(function(e){return"rtx"!==e.name})),P=E.sendEncodingParameters||[{ssrc:(2*c+2)*1001}];var E,_,x,I,T,P,D,R,A,L,O,M,F=!1;"sendrecv"===y||"sendonly"===y?(F=!E.rtpReceiver,T=E.rtpReceiver||new e.RTCRtpReceiver(E.dtlsTransport,p),F&&(A=T.track,$&&"-"===$.stream||($?(l[$.stream]||(l[$.stream]=new e.MediaStream,Object.defineProperty(l[$.stream],"id",{get:function(){return $.stream}})),Object.defineProperty(A,"id",{get:function(){return $.track}}),M=l[$.stream]):(l.default||(l.default=new e.MediaStream),M=l.default)),M&&(n(A,M),E.associatedRemoteMediaStreams.push(M)),d.push([A,T,M]))):E.rtpReceiver&&E.rtpReceiver.track&&(E.associatedRemoteMediaStreams.forEach(function(t){var n,r,i=t.getTracks().find(function(e){return e.id===E.rtpReceiver.track.id});i&&(n=i,(r=t).removeTrack(n),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:n})))}),E.associatedRemoteMediaStreams=[]),E.localCapabilities=R,E.remoteCapabilities=b,E.rtpReceiver=T,E.rtcpParameters=w,E.sendEncodingParameters=P,E.recvEncodingParameters=D,o._transceive(o.transceivers[c],!1,F)}}),void 0===o._dtlsRole&&(o._dtlsRole="offer"===i.type?"active":"passive"),o.remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?o._updateSignalingState("have-remote-offer"):o._updateSignalingState("stable"),Object.keys(l).forEach(function(t){var n=l[t];if(n.getTracks().length){if(-1===o.remoteStreams.indexOf(n)){o.remoteStreams.push(n);var r=new Event("addstream");r.stream=n,e.setTimeout(function(){o._dispatchEvent("addstream",r)})}d.forEach(function(e){var t=e[0],r=e[1];n.id===e[2].id&&u(o,t,r,[n])})}}),d.forEach(function(e){!e[2]&&u(o,e[0],e[1],[])}),e.setTimeout(function(){o&&o.transceivers&&o.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0||t.checking>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":(t.connected>0||t.completed>0)&&(e="connected"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},l.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var o=n.transceivers.filter(function(e){return"audio"===e.kind}).length,a=n.transceivers.filter(function(e){return"video"===e.kind}).length,s=arguments[0];if(s){if(s.mandatory||s.optional)throw TypeError("Legacy mandatory/optional constraints not supported.");void 0!==s.offerToReceiveAudio&&(o=!0===s.offerToReceiveAudio?1:!1===s.offerToReceiveAudio?0:s.offerToReceiveAudio),void 0!==s.offerToReceiveVideo&&(a=!0===s.offerToReceiveVideo?1:!1===s.offerToReceiveVideo?0:s.offerToReceiveVideo)}for(n.transceivers.forEach(function(e){"audio"===e.kind?--o<0&&(e.wantReceive=!1):"video"===e.kind&&--a<0&&(e.wantReceive=!1)});o>0||a>0;)o>0&&(n._createTransceiver("audio"),o--),a>0&&(n._createTransceiver("video"),a--);var u=r.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);return n.transceivers.forEach(function(i,o){var a=i.track,s=i.kind,c=i.mid||r.generateIdentifier();i.mid=c,i.iceGatherer||(i.iceGatherer=n._createIceGatherer(o,n.usingBundle));var u=e.RTCRtpSender.getCapabilities(s);t<15019&&(u.codecs=u.codecs.filter(function(e){return"rtx"!==e.name})),u.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),u.headerExtensions.forEach(function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var l=i.sendEncodingParameters||[{ssrc:(2*o+1)*1001}];a&&t>=15019&&"video"===s&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,s)),i.localCapabilities=u,i.sendEncodingParameters=l}),"max-compat"!==n._config.bundlePolicy&&(u+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),u+="a=ice-options:trickle\r\n",n.transceivers.forEach(function(e,t){u+=i(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),u+="a=rtcp-rsize\r\n",e.iceGatherer&&"new"!==n.iceGatheringState&&(0===t||!n.usingBundle)&&(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,u+="a="+r.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(u+="a=end-of-candidates\r\n"))}),Promise.resolve(new e.RTCSessionDescription({type:"offer",sdp:u}))},l.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));var a=r.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(a+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n");var s=r.getMediaSections(n.remoteDescription.sdp).length;return n.transceivers.forEach(function(e,r){if(!(r+1>s)){if(e.isDatachannel){a+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+e.mid+"\r\n";return}e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var c,u=o(e.localCapabilities,e.remoteCapabilities);!u.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,a+=i(e,u,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}}),Promise.resolve(new e.RTCSessionDescription({type:"answer",sdp:a}))},l.prototype.addIceCandidate=function(e){var t,n=this;return e&&!(void 0!==e.sdpMLineIndex||e.sdpMid)?Promise.reject(TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(i,o){if(!n.remoteDescription)return o(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var a=e.sdpMLineIndex;if(e.sdpMid){for(var u=0;u<n.transceivers.length;u++)if(n.transceivers[u].mid===e.sdpMid){a=u;break}}var l=n.transceivers[a];if(!l)return o(c("OperationError","Can not add ICE candidate"));if(l.isDatachannel)return i();var d=Object.keys(e.candidate).length>0?r.parseCandidate(e.candidate):{};if("tcp"===d.protocol&&(0===d.port||9===d.port)||d.component&&1!==d.component)return i();if((0===a||a>0&&l.iceTransport!==n.transceivers[0].iceTransport)&&!s(l.iceTransport,d))return o(c("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),t=r.getMediaSections(n.remoteDescription.sdp),t[a]+="a="+(d.type?p:"end-of-candidates")+"\r\n",n.remoteDescription.sdp=t.join("")}else for(var f=0;f<n.transceivers.length&&(n.transceivers[f].isDatachannel||(n.transceivers[f].iceTransport.addRemoteCandidate({}),t=r.getMediaSections(n.remoteDescription.sdp),t[f]+="a=end-of-candidates\r\n",n.remoteDescription.sdp=r.getDescription(n.remoteDescription.sdp)+t.join(""),!n.usingBundle));f++);i()})},l.prototype.getStats=function(){var e=[];return this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&e.push(t[n].getStats())})}),new Promise(function(t){var n=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(t){var r;e[t].type=({inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"})[(r=e[t]).type]||r.type,n.set(t,e[t])})}),t(n)})})};var d=["createOffer","createAnswer"];return d.forEach(function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),(d=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),l}},{sdp:56}],56:[function(e,t,n){"use strict";var r={};r.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},r.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},r.getDescription=function(e){var t=r.splitSections(e);return t&&t[0]},r.getMediaSections=function(e){var t=r.splitSections(e);return t.shift(),t},r.matchPrefix=function(e,t){return r.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},r.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},r.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},r.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},r.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},r.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},r.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)}),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},r.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},r.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},r.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},r.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},r.getMid=function(e){var t=r.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},r.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},r.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:r.matchPrefix(e+t,"a=fingerprint:").map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},r.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},r.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?r.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},r.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},r.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},r.getCryptoParameters=function(e,t){return r.matchPrefix(e+t,"a=crypto:").map(r.parseCryptoLine)},r.getIceParameters=function(e,t){var n=r.matchPrefix(e+t,"a=ice-ufrag:")[0],i=r.matchPrefix(e+t,"a=ice-pwd:")[0];return n&&i?{usernameFragment:n.substr(12),password:i.substr(10)}:null},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},r.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=r.splitLines(e)[0].split(" "),i=3;i<n.length;i++){var o=n[i],a=r.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){var s=r.parseRtpMap(a),c=r.matchPrefix(e,"a=fmtp:"+o+" ");switch(s.parameters=c.length?r.parseFmtp(c[0]):{},s.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(r.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return r.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(r.parseExtmap(e))}),t},r.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=r.writeRtpMap(e),n+=r.writeFmtp(e),n+=r.writeRtcpFb(e)});var i=0;return t.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),i>0&&(n+="a=maxptime:"+i+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){n+=r.writeExtmap(e)}),n},r.parseRtpEncodingParameters=function(e){var t,n=[],i=r.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),a=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=s.length>0&&s[0].ssrc,u=r.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(r.rtx={ssrc:t}),n.push(r),o&&((r=JSON.parse(JSON.stringify(r))).fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},n.push(r))}}),0===n.length&&c&&n.push({ssrc:c});var l=r.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?950*parseInt(l[0].substr(5),10)-16e3:void 0,n.forEach(function(e){e.maxBitrate=l})),n},r.parseRtcpParameters=function(e){var t={},n=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var i=r.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var o=r.matchPrefix(e,"a=rtcp-mux");return t.mux=o.length>0,t},r.parseMsid=function(e){var t,n=r.matchPrefix(e,"a=msid:");if(1===n.length)return{stream:(t=n[0].substr(7).split(" "))[0],track:t[1]};var i=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});if(i.length>0)return{stream:(t=i[0].value.split(" "))[0],track:t[1]}},r.parseSctpDescription=function(e){var t,n=r.parseMLine(e),i=r.matchPrefix(e,"a=max-message-size:");i.length>0&&(t=parseInt(i[0].substr(19),10)),isNaN(t)&&(t=65536);var o=r.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:n.fmt,maxMessageSize:t};if(r.matchPrefix(e,"a=sctpmap:").length>0){var a=r.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:t}}},r.writeSctpDescription=function(e,t){var n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,t,n){var i;return"v=0\r\no="+(n||"thisisadapterortc")+" "+(i=e||r.generateSessionId())+" "+(void 0!==t?t:2)+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.writeMediaSection=function(e,t,n,i){var o=r.writeRtpDescription(e.kind,t);if(o+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var a="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),o},r.getDirection=function(e,t){for(var n=r.splitLines(e),i=0;i<n.length;i++)switch(n[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[i].substr(2)}return t?r.getDirection(t):"sendrecv"},r.getKind=function(e){return r.splitLines(e)[0].split(" ")[0].substr(2)},r.isRejected=function(e){return"0"===e.split(" ",2)[1]},r.parseMLine=function(e){var t=r.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},r.parseOLine=function(e){var t=r.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},r.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=r.splitLines(e),n=0;n<t.length;n++)if(t[n].length<2||"="!==t[n].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=r)},{}],57:[function(e,t,n){"function"==typeof Object.create?t.exports=function e(t,n){t.super_=n,t.prototype=Object.create(n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function e(t,n){t.super_=n;var r=function(){};r.prototype=n.prototype,t.prototype=new r,t.prototype.constructor=t}},{}],58:[function(e,t,n){t.exports=function e(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8}},{}],59:[function(e,t,n){(function(t,r){(function(){var i,o=/%[sdj%]/g;n.format=function(e){if(!v(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(s(arguments[n]));return t.join(" ")}for(var n=1,r=arguments,i=r.length,a=String(e).replace(o,function(e){if("%%"===e)return"%";if(n>=i)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(t){return"[Circular]"}default:return e}}),c=r[n];n<i;c=r[++n])m(c)||!S(c)?a+=" "+c:a+=" "+s(c);return a},n.deprecate=function(e,i){if(y(r.process))return function(){return n.deprecate(e,i).apply(this,arguments)};if(!0===t.noDeprecation)return e;var o=!1;return function n(){if(!o){if(t.throwDeprecation)throw Error(i);t.traceDeprecation?console.trace(i):console.error(i),o=!0}return e.apply(this,arguments)}};var a={};function s(e,t){var r={seen:[],stylize:u};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),h(t)?r.showHidden=t:t&&n._extend(r,t),y(r.showHidden)&&(r.showHidden=!1),y(r.depth)&&(r.depth=2),y(r.colors)&&(r.colors=!1),y(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=c),l(r,e,r.depth)}function c(e,t){var n=s.styles[t];return n?"\x1b["+s.colors[n][0]+"m"+e+"\x1b["+s.colors[n][1]+"m":e}function u(e,t){return e}function l(e,t,r){if(e.customInspect&&t&&C(t.inspect)&&t.inspect!==n.inspect&&!(t.constructor&&t.constructor.prototype===t)){var i,o,a,s,c,u=t.inspect(r,e);return v(u)||(u=l(e,u,r)),u}var S=function e(t,n){if(y(n))return t.stylize("undefined","undefined");if(v(n)){var r="'"+JSON.stringify(n).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(r,"string")}return g(n)?t.stylize(""+n,"number"):h(n)?t.stylize(""+n,"boolean"):m(n)?t.stylize("null","null"):void 0}(e,t);if(S)return S;var k,E,_=Object.keys(t),I=(k=_,E={},k.forEach(function(e,t){E[e]=!0}),E);if(e.showHidden&&(_=Object.getOwnPropertyNames(t)),w(t)&&(_.indexOf("message")>=0||_.indexOf("description")>=0))return d(t);if(0===_.length){if(C(t)){var T=t.name?": "+t.name:"";return e.stylize("[Function"+T+"]","special")}if($(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(b(t))return e.stylize(Date.prototype.toString.call(t),"date");if(w(t))return d(t)}var P="",D=!1,R=["{","}"];if(f(t)&&(D=!0,R=["[","]"]),C(t)&&(P=" [Function"+(t.name?": "+t.name:"")+"]"),$(t)&&(P=" "+RegExp.prototype.toString.call(t)),b(t)&&(P=" "+Date.prototype.toUTCString.call(t)),w(t)&&(P=" "+d(t)),0===_.length&&(!D||0==t.length))return R[0]+P+R[1];if(r<0)return $(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special");return e.seen.push(t),c=D?function e(t,n,r,i,o){for(var a=[],s=0,c=n.length;s<c;++s)x(n,String(s))?a.push(p(t,n,r,i,String(s),!0)):a.push("");return o.forEach(function(e){e.match(/^\d+$/)||a.push(p(t,n,r,i,e,!0))}),a}(e,t,r,I,_):_.map(function(n){return p(e,t,r,I,n,D)}),e.seen.pop(),i=c,o=P,a=R,s=0,i.reduce(function(e,t){return s++,t.indexOf("\n")>=0&&s++,e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?a[0]+(""===o?"":o+"\n ")+" "+i.join(",\n  ")+" "+a[1]:a[0]+o+" "+i.join(", ")+" "+a[1]}function d(e){return"["+Error.prototype.toString.call(e)+"]"}function p(e,t,n,r,i,o){var a,s,c;if((c=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?s=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(s=e.stylize("[Setter]","special")),x(r,i)||(a="["+i+"]"),!s&&(0>e.seen.indexOf(c.value)?(s=m(n)?l(e,c.value,null):l(e,c.value,n-1)).indexOf("\n")>-1&&(s=o?s.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+s.split("\n").map(function(e){return"   "+e}).join("\n")):s=e.stylize("[Circular]","special")),y(a)){if(o&&i.match(/^\d+$/))return s;(a=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.substr(1,a.length-2),a=e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=e.stylize(a,"string"))}return a+": "+s}function f(e){return Array.isArray(e)}function h(e){return"boolean"==typeof e}function m(e){return null===e}function g(e){return"number"==typeof e}function v(e){return"string"==typeof e}function y(e){return void 0===e}function $(e){return S(e)&&"[object RegExp]"===k(e)}function S(e){return"object"==typeof e&&null!==e}function b(e){return S(e)&&"[object Date]"===k(e)}function w(e){return S(e)&&("[object Error]"===k(e)||e instanceof Error)}function C(e){return"function"==typeof e}function k(e){return Object.prototype.toString.call(e)}function E(e){return e<10?"0"+e.toString(10):e.toString(10)}n.debuglog=function(e){if(y(i)&&(i=t.env.NODE_DEBUG||""),!a[e=e.toUpperCase()]){if(RegExp("\\b"+e+"\\b","i").test(i)){var r=t.pid;a[e]=function(){var t=n.format.apply(n,arguments);console.error("%s %d: %s",e,r,t)}}else a[e]=function(){}}return a[e]},n.inspect=s,s.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},s.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},n.isArray=f,n.isBoolean=h,n.isNull=m,n.isNullOrUndefined=function e(t){return null==t},n.isNumber=g,n.isString=v,n.isSymbol=function e(t){return"symbol"==typeof t},n.isUndefined=y,n.isRegExp=$,n.isObject=S,n.isDate=b,n.isError=w,n.isFunction=C,n.isPrimitive=function e(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},n.isBuffer=e("./support/isBuffer");var _=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function x(e,t){return Object.prototype.hasOwnProperty.call(e,t)}n.log=function(){var e,t;console.log("%s - %s",(e=new Date,t=[E(e.getHours()),E(e.getMinutes()),E(e.getSeconds())].join(":"),[e.getDate(),_[e.getMonth()],t].join(" ")),n.format.apply(n,arguments))},n.inherits=e("inherits"),n._extend=function(e,t){if(!t||!S(t))return e;for(var n=Object.keys(t),r=n.length;r--;)e[n[r]]=t[n[r]];return e}}).call(this)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":58,_process:52,inherits:57}]},{},[3])(3);if("function"==typeof define&&define.amd)define([],function(){return t});else{var n=e.Twilio=e.Twilio||{};n.Connection=n.Connection||t.Connection,n.Device=n.Device||t.Device,n.PStream=n.PStream||t.PStream,n.PreflightTest=n.PreflightTest||t.PreflightTest}}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);